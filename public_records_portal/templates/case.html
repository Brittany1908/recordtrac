<!-- This template houses the baseline case information (request, documents, status, etc.) only. -->

{% extends "base.html" %}
{% block title %}Request{% endblock %}
{% block body %}
  <div class="row-fluid well"> 
    {% block status %}
      <div class="row-fluid">
        <div class="text-right">Routed to <span class="label label-info">{{req.current_owner | directory }} </span> 
          <a data-placement="left" data-toggle="popover" href="#" class="historyPopover hidden-phone hidden-tablet"> <i class="icon-time"></i>  </a>
          <div id="historyPopover-head" class="hide">Routing history</div>
          <div id="historyPopover-content" class="hide">              
            <table class="table table-condensed">
              <thead>
                <tr>
                  <th>Date</th>
                  <th></th>
                  <th>To</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody>
                <!-- the order of data returned here should be reverse chronological (right now it's shown as oldest first)-->
                {% for owner in req.owners %}
                  <tr>
                    <td>{{ owner.date_created | date }}</td>
                    <td><i class="icon-circle-arrow-right"></i></td>
                    <td>{{ owner.id | owner_name }}</td>
                    <td>{{ owner.reason }}</td>
                  </tr>              
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endblock status %}

    {% block request %}
    <!-- request area -->
      <div class="row-fluid">
        <h3>Request {{req.id}}</h3>
        <div class="span10">
            <p class="lead"> {{ req.text }} </p>
        </div>
      </div>

      <!-- shows any existing Q&A -->
      {% if req.qas %}
        <div class="row-fluid">
          {% for qa in req.qas %}
            <div class="row-fluid response">
              <div class="span2 text-center">
                <i class="icon-question icon-2x">  </i> </br>
                <small> {{ qa.date_created | date_granular }}</small> </br>
              </div>
              <div class="span10">
                <p> {{ qa.question }} - <em>{{qa.owner_id | user_name }}</em></p>
                {% if qa.answer %}
                  <p>{{ qa.answer }} - <em>{{qa.subscriber_id | user_name }}</em></p>
                {% else %}
                  {% if user_id %}
                    Requester hasn't answered yet.
                  {% else %}
                    {% if (req.id | is_request_open) %}
                      <!-- respond to a question -->
                        <form name="respond_question" class="form-horizontal" id="answer" method="post" action="/update_a_qa" autocomplete="on">
                          <fieldset> 
                            <div class="row-fluid">
                              <!-- <div class="control-group span8"> -->
                                <label class="control-label">Answer</label>
                                  <div class="controls">
                                    <input type="hidden" name="qa_id" value="{{ qa.id }}"/>
                                    <input type="hidden" name="request_id" value="{{ req.id }}"/>
                                    <textarea id="answerTextarea" name="answer_text" type="text" rows="3" cols="20" placeholder="Can you respond to the above question?" required/></textarea>
                                    <button id="askQuestion" class="btn btn-primary" type="submit">Respond</button>
                                  </div>
                              <!-- </div> -->
                            </div>
                          </fieldset>
                        </form>
                        {% endif %}
                      {% endif %}
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

    {% endblock request %}

    {% block response %}

      <!-- response area: need to give this more space between the request area-->
      <div class="row-fluid">
        <h3 class="response">Response</h3>
          <!-- shows all existing responses (links, documents, offline docs, notes) -->
          {% if req.records or req.notes %} 

            {% if req.records %}
              <div class="span10">
                {% for record in req.records %}
                  {% if record.doc_id %}
                    <div class="row-fluid response">
                      <div class="span2 text-center">
                        <i class="icon-file-alt icon-3x">  </i></br>
                        <small> {{ record.date_created | date_granular }} </small> </br>
                      </div>
                      <div class="span10">
                        <p> 
                            <a href="{{record.url}}" rel="tooltip" data-toggle="tooltip" data-placement="right" title="" data-original-title="{{record.url}}">  {{record.description}} </a> - <em>{{record.user_id | user_name }}</em>
                        </p>
                      </div>
                    </div>
                    {% elif record.access %}
                      <div class="row-fluid response">
                        <div class="span2 text-center">
                          <i class="icon-file-alt icon-3x">  </i></br>
                          <small> {{ record.date_created | date_granular }} </small> </br>
                        </div>
                        <div class="span10">
                          <p>{{record.description}} can be accessed: {{record.access}} </a> - <em>{{record.user_id | user_name }}</em></p>
                        </div>
                      </div>
                  {% else %} <!-- treat it as a link -->
                    <div class="row-fluid response">
                      <div class="span2 text-center">
                        <i class="icon-link icon-3x">  </i></br>
                        <small> {{ record.date_created | date_granular }} </small> </br>
                      </div>
                      <div class="span10">
                        <p> <a href="{{record.url}}" rel="tooltip" data-toggle="tooltip" data-placement="right" title="" data-original-title="{{record.url}}">  {{record.description}} </a> - <em>{{record.owner_id | owner_name }}</em></p>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}

            {% if req.notes %}
              <div class="span10">
                {% for note in req.notes %}
                  <div class="row-fluid response">
                    <div class="span2 text-center">
                      <i class="icon-edit icon-3x">  </i> </br>
                      <small> {{ note.date_created | date_granular }} </small> </br>
                    </div>
                    <div class="span10">
                      <p> {{ note.text}} - <em>{{note.user_id | user_name }}</em></p>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

          {% else %}<!--added an if then to check to see if any responses exist - if no then show text here for the "if any response exists" above -->
            <div class="span10">
              <p>There are no records uploaded just yet.  Stay tuned!</p>
            </div>
        {% endif %}

          

<!-- This code will definitely not work.  All it's meant to do is convey that we need to post whatever the "close" reason is for the case in the page itself. --> 
          {% if closed %}
            <div class="span10">
              <div class="row-fluid response">
                <div class="span2 text-center">
                  <i class="icon-lock icon-3x">  </i> </br>
                  <small> {{ request.status_updated | date_granular }} </small> </br> 
                </div>
                <div class="span10">
                  {% if request_fulfilled_city %}
                    <p> {{request_fulfilled_city.email_body}} </p>
                    {% elif request_rejected_norecord %}
                    <p> {{request_rejected_norecord.email_body}} </p>
                    {% elif equest_rejected_privacy %}
                    <p> {{equest_rejected_privacy}} </p>
                    {% elif request_rejected_lawsuit %}
                    <p> {{request_rejected_lawsuit}} </p>
                    {% elif request_rejected_investigation %}
                    <p> {{request_rejected_investigation}} </p>
                    {% elif request_withdrawn %}
                    <p> {{request_withdrawn}} </p>
                  {% endif %}
                </div>
              </div>
            </div> 
          {% endif %}

      </div>
    {% endblock response %}

  </div>
{% endblock body %}