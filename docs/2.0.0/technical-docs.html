<html>
    <head>

        <style type="text/css">
            .hll { background-color: #ffffcc }
.c { color: #888888 } /* Comment */
.err { color: #a61717; background-color: #e3d2d2 } /* Error */
.k { color: #008800; font-weight: bold } /* Keyword */
.cm { color: #888888 } /* Comment.Multiline */
.cp { color: #cc0000; font-weight: bold } /* Comment.Preproc */
.c1 { color: #888888 } /* Comment.Single */
.cs { color: #cc0000; font-weight: bold; background-color: #fff0f0 } /* Comment.Special */
.gd { color: #000000; background-color: #ffdddd } /* Generic.Deleted */
.ge { font-style: italic } /* Generic.Emph */
.gr { color: #aa0000 } /* Generic.Error */
.gh { color: #333333 } /* Generic.Heading */
.gi { color: #000000; background-color: #ddffdd } /* Generic.Inserted */
.go { color: #888888 } /* Generic.Output */
.gp { color: #555555 } /* Generic.Prompt */
.gs { font-weight: bold } /* Generic.Strong */
.gu { color: #666666 } /* Generic.Subheading */
.gt { color: #aa0000 } /* Generic.Traceback */
.kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.kp { color: #008800 } /* Keyword.Pseudo */
.kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.kt { color: #888888; font-weight: bold } /* Keyword.Type */
.m { color: #0000DD; font-weight: bold } /* Literal.Number */
.s { color: #dd2200; background-color: #fff0f0 } /* Literal.String */
.na { color: #336699 } /* Name.Attribute */
.nb { color: #003388 } /* Name.Builtin */
.nc { color: #bb0066; font-weight: bold } /* Name.Class */
.no { color: #003366; font-weight: bold } /* Name.Constant */
.nd { color: #555555 } /* Name.Decorator */
.ne { color: #bb0066; font-weight: bold } /* Name.Exception */
.nf { color: #0066bb; font-weight: bold } /* Name.Function */
.nl { color: #336699; font-style: italic } /* Name.Label */
.nn { color: #bb0066; font-weight: bold } /* Name.Namespace */
.py { color: #336699; font-weight: bold } /* Name.Property */
.nt { color: #bb0066; font-weight: bold } /* Name.Tag */
.nv { color: #336699 } /* Name.Variable */
.ow { color: #008800 } /* Operator.Word */
.w { color: #bbbbbb } /* Text.Whitespace */
.mf { color: #0000DD; font-weight: bold } /* Literal.Number.Float */
.mh { color: #0000DD; font-weight: bold } /* Literal.Number.Hex */
.mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.mo { color: #0000DD; font-weight: bold } /* Literal.Number.Oct */
.sb { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Backtick */
.sc { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Char */
.sd { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Doc */
.s2 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Double */
.se { color: #0044dd; background-color: #fff0f0 } /* Literal.String.Escape */
.sh { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Heredoc */
.si { color: #3333bb; background-color: #fff0f0 } /* Literal.String.Interpol */
.sx { color: #22bb22; background-color: #f0fff0 } /* Literal.String.Other */
.sr { color: #008800; background-color: #fff0ff } /* Literal.String.Regex */
.s1 { color: #dd2200; background-color: #fff0f0 } /* Literal.String.Single */
.ss { color: #aa6600; background-color: #fff0f0 } /* Literal.String.Symbol */
.bp { color: #003388 } /* Name.Builtin.Pseudo */
.vc { color: #336699 } /* Name.Variable.Class */
.vg { color: #dd7700 } /* Name.Variable.Global */
.vi { color: #3333bb } /* Name.Variable.Instance */
.il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
        </style>

    </head>
    <body>

<p> Hi! Welcome to RecordTrac's technical documentation. Here you'll find the source code for the Flask application. A good place to start is by browsing <a href="#views">views.py</a>, <a href="#models">models.py</a> and <a href="#prr">prr.py</a>. All of the templates referenced can be found <a href= "https://github.com/codeforamerica/recordtrac/tree/master/public_records_portal/templates">here</a>. A full table of contents is below. </p><br/>

Table of Contents
<ul>
	<li><a href="#db_helpers">Jump to db_helpers.py docs</a></li>
	<li><a href="#csv_export">Jump to csv_export.py docs</a></li>
	<li><a href="#notifications">Jump to notifications.py docs</a></li>
	<li><a href="#prflask">Jump to prflask.py docs</a></li>
	<li><a href="#prr">Jump to prr.py docs</a></li>
	<li><a href="#RequestPresenter">Jump to RequestPresenter.py docs</a></li>
	<li><a href="#ResponsePresenter">Jump to ResponsePresenter.py docs</a></li>
	<li><a href="#scribd_helpers">Jump to scribd_helpers.py docs</a></li>
	<li><a href="#spam">Jump to spam.py docs</a></li>
	<li><a href="#views">Jump to views.py docs</a></li>
	<li><a href="#models">Jump to models.py docs</a></li>
</ul>

<a name="db_helpers">Database helpers</a> 
<p>db_helpers.py</p>
<pre>
<div class="highlight"><pre><a name="db_helpers.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot; </span>
<a name="db_helpers.py-pyg.html-2"></a><span class="sd">.. module:: db_helpers</span>
<a name="db_helpers.py-pyg.html-3"></a><span class="sd">	:synopsis: Functions that interact with the Postgres database via Flask-SQLAlchemy</span>
<a name="db_helpers.py-pyg.html-4"></a><span class="sd">.. modlueauthor:: Richa Agarwal &lt;richa@codeforamerica.org&gt;</span>
<a name="db_helpers.py-pyg.html-5"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-6"></a>
<a name="db_helpers.py-pyg.html-7"></a>
<a name="db_helpers.py-pyg.html-8"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">app</span>
<a name="db_helpers.py-pyg.html-9"></a><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="o">*</span>
<a name="db_helpers.py-pyg.html-10"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a name="db_helpers.py-pyg.html-11"></a><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span><span class="p">,</span> <span class="n">InvalidRequestError</span>
<a name="db_helpers.py-pyg.html-12"></a><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">not_</span><span class="p">,</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span>
<a name="db_helpers.py-pyg.html-13"></a><span class="kn">from</span> <span class="nn">sqlalchemy.dialects</span> <span class="kn">import</span> <span class="n">postgresql</span>
<a name="db_helpers.py-pyg.html-14"></a><span class="kn">import</span> <span class="nn">uuid</span>
<a name="db_helpers.py-pyg.html-15"></a><span class="kn">import</span> <span class="nn">json</span>
<a name="db_helpers.py-pyg.html-16"></a><span class="kn">import</span> <span class="nn">os</span>
<a name="db_helpers.py-pyg.html-17"></a><span class="kn">import</span> <span class="nn">logging</span> 
<a name="db_helpers.py-pyg.html-18"></a>
<a name="db_helpers.py-pyg.html-19"></a>
<a name="db_helpers.py-pyg.html-20"></a><span class="c">### @export &quot;get_subscriber&quot;</span>
<a name="db_helpers.py-pyg.html-21"></a><span class="k">def</span> <span class="nf">get_subscriber</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-22"></a><span class="c"># Returns the subscriber for a given request by user ID</span>
<a name="db_helpers.py-pyg.html-23"></a>	<span class="k">if</span> <span class="n">request_id</span> <span class="ow">and</span> <span class="n">user_id</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-24"></a>		<span class="k">return</span> <span class="n">Subscriber</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-25"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-26"></a>
<a name="db_helpers.py-pyg.html-27"></a><span class="c">### @export &quot;get_count&quot;</span>
<a name="db_helpers.py-pyg.html-28"></a><span class="k">def</span> <span class="nf">get_count</span><span class="p">(</span><span class="n">obj_type</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-29"></a>	<span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">obj_type</span><span class="p">)</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-30"></a>
<a name="db_helpers.py-pyg.html-31"></a><span class="c">### @export &quot;get_obj&quot;</span>
<a name="db_helpers.py-pyg.html-32"></a><span class="k">def</span> <span class="nf">get_obj</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-33"></a>	<span class="sd">&quot;&quot;&quot; Query the database for an object via its class/type (defined in models.py) and ID and return the object. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-34"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">obj_id</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-35"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-36"></a>	<span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">obj_type</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-37"></a>
<a name="db_helpers.py-pyg.html-38"></a><span class="c">### @export &quot;get_objs&quot;</span>
<a name="db_helpers.py-pyg.html-39"></a><span class="k">def</span> <span class="nf">get_objs</span><span class="p">(</span><span class="n">obj_type</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-40"></a>	<span class="sd">&quot;&quot;&quot; Query the database for all objects of a certain class/type (defined in models.py) and return queryset. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-41"></a>	<span class="c"># There has to be a better way of doing this</span>
<a name="db_helpers.py-pyg.html-42"></a>	<span class="k">if</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s">&quot;User&quot;</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-43"></a>		<span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-44"></a>	<span class="k">elif</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s">&quot;Request&quot;</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-45"></a>		<span class="k">return</span> <span class="n">Request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-46"></a>	<span class="k">elif</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s">&quot;Owner&quot;</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-47"></a>		<span class="k">return</span> <span class="n">Owner</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-48"></a>	<span class="k">elif</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s">&quot;Note&quot;</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-49"></a>		<span class="k">return</span> <span class="n">Note</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-50"></a>	<span class="k">elif</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s">&quot;QA&quot;</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-51"></a>		<span class="k">return</span> <span class="n">QA</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-52"></a>	<span class="k">elif</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s">&quot;Subscriber&quot;</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-53"></a>		<span class="k">return</span> <span class="n">Subscriber</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-54"></a>	<span class="k">elif</span> <span class="n">obj_type</span> <span class="o">==</span> <span class="s">&quot;Record&quot;</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-55"></a>		<span class="k">return</span> <span class="n">Record</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-56"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-57"></a>
<a name="db_helpers.py-pyg.html-58"></a><span class="c">### @export &quot;get_avg_response_time&quot;</span>
<a name="db_helpers.py-pyg.html-59"></a><span class="k">def</span> <span class="nf">get_avg_response_time</span><span class="p">(</span><span class="n">department</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-60"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Calculating average response time for department: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">department</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-61"></a>	<span class="n">d</span> <span class="o">=</span> <span class="n">Department</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">department</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-62"></a>	<span class="n">response_time</span> <span class="o">=</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-63"></a>	<span class="n">num_closed</span> <span class="o">=</span> <span class="mi">0</span>
<a name="db_helpers.py-pyg.html-64"></a>	<span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-65"></a>		<span class="n">date_created</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">date_received</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">date_created</span>
<a name="db_helpers.py-pyg.html-66"></a>		<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="s">&#39;Closed&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-67"></a>			<span class="k">if</span> <span class="n">response_time</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-68"></a>				<span class="n">response_time</span> <span class="o">=</span> <span class="n">response_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">status_updated</span> <span class="o">-</span> <span class="n">date_created</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-69"></a>			<span class="k">else</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-70"></a>				<span class="n">response_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">status_updated</span> <span class="o">-</span> <span class="n">date_created</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-71"></a>			<span class="n">num_closed</span> <span class="o">=</span> <span class="n">num_closed</span> <span class="o">+</span> <span class="mi">1</span>
<a name="db_helpers.py-pyg.html-72"></a>	<span class="k">if</span> <span class="n">num_closed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-73"></a>		<span class="n">avg</span> <span class="o">=</span> <span class="n">response_time</span> <span class="o">/</span> <span class="n">num_closed</span>
<a name="db_helpers.py-pyg.html-74"></a>		<span class="k">return</span> <span class="n">avg</span>
<a name="db_helpers.py-pyg.html-75"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-76"></a>
<a name="db_helpers.py-pyg.html-77"></a><span class="c">### @export &quot;get_request_by_owner&quot;</span>
<a name="db_helpers.py-pyg.html-78"></a><span class="k">def</span> <span class="nf">get_request_by_owner</span><span class="p">(</span><span class="n">owner_id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-79"></a>	<span class="sd">&quot;&quot;&quot; Return the request that a particular owner belongs to &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-80"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">owner_id</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-81"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-82"></a>	<span class="k">return</span> <span class="n">Owner</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_id</span><span class="p">)</span><span class="o">.</span><span class="n">request</span>
<a name="db_helpers.py-pyg.html-83"></a>
<a name="db_helpers.py-pyg.html-84"></a><span class="c">### @export &quot;get_owners_by_user_id&quot;</span>
<a name="db_helpers.py-pyg.html-85"></a><span class="k">def</span> <span class="nf">get_owners_by_user_id</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-86"></a>	<span class="sd">&quot;&quot;&quot; Return the queryset of owners for a particular user. (A user can be associated with multiple owners).&quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-87"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-88"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-89"></a>	<span class="k">return</span> <span class="n">Owner</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-90"></a>
<a name="db_helpers.py-pyg.html-91"></a><span class="c">### @export &quot;get_prr_liaison_by_dept&quot;</span>
<a name="db_helpers.py-pyg.html-92"></a><span class="k">def</span> <span class="nf">get_contact_by_dept</span><span class="p">(</span><span class="n">dept</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-93"></a>	<span class="sd">&quot;&quot;&quot; Return the contact for a given department. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-94"></a>	<span class="n">q</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">contact_for</span><span class="p">)</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%%%s%%</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dept</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
<a name="db_helpers.py-pyg.html-95"></a>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-96"></a>		<span class="k">return</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">email</span>
<a name="db_helpers.py-pyg.html-97"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Department: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dept</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-98"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-99"></a>
<a name="db_helpers.py-pyg.html-100"></a><span class="c">### @export &quot;get_backup_by_dept&quot;</span>
<a name="db_helpers.py-pyg.html-101"></a><span class="k">def</span> <span class="nf">get_backup_by_dept</span><span class="p">(</span><span class="n">dept</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-102"></a>	<span class="sd">&quot;&quot;&quot; Return the contact for a given department. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-103"></a>	<span class="n">q</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">backup_for</span><span class="p">)</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%%%s%%</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dept</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
<a name="db_helpers.py-pyg.html-104"></a>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-105"></a>		<span class="k">return</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">email</span>
<a name="db_helpers.py-pyg.html-106"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Department: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dept</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-107"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-108"></a>
<a name="db_helpers.py-pyg.html-109"></a><span class="c">### @export &quot;put_obj&quot;</span>
<a name="db_helpers.py-pyg.html-110"></a><span class="k">def</span> <span class="nf">put_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-111"></a>	<span class="sd">&quot;&quot;&quot; Add and commit the object to the database. Return true if successful. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-112"></a>	<span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-113"></a>		<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-114"></a>		<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-115"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Committed object to database: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-116"></a>		<span class="k">return</span> <span class="bp">True</span>
<a name="db_helpers.py-pyg.html-117"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="db_helpers.py-pyg.html-118"></a>
<a name="db_helpers.py-pyg.html-119"></a><span class="c">### @export &quot;get_attribute&quot;</span>
<a name="db_helpers.py-pyg.html-120"></a><span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-121"></a>	<span class="sd">&quot;&quot;&quot; Obtain the object by obj_id and obj_type if obj is not provided, and return the specified attribute for that object. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-122"></a>	<span class="k">if</span> <span class="n">obj_id</span> <span class="ow">and</span> <span class="n">obj_type</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-123"></a>		<span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-124"></a>	<span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-125"></a>		<span class="k">try</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-126"></a>			<span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-127"></a>		<span class="k">except</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-128"></a>			<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-129"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-130"></a>
<a name="db_helpers.py-pyg.html-131"></a><span class="c">### @export &quot;update_obj&quot;</span>
<a name="db_helpers.py-pyg.html-132"></a><span class="k">def</span> <span class="nf">update_obj</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-133"></a>	<span class="sd">&quot;&quot;&quot; Obtain the object by obj_id and obj_type if obj is not provided, and update the specified attribute for that object. Return true if successful. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-134"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Updating attribute: </span><span class="si">%s</span><span class="s"> with value: </span><span class="si">%s</span><span class="s"> for obj_type: </span><span class="si">%s</span><span class="s">, obj_id: </span><span class="si">%s</span><span class="s">, obj: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-135"></a>	<span class="k">if</span> <span class="n">obj_id</span> <span class="ow">and</span> <span class="n">obj_type</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-136"></a>		<span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-137"></a>	<span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-138"></a>		<span class="k">try</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-139"></a>			<span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-140"></a>			<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-141"></a>			<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-142"></a>			<span class="k">return</span> <span class="bp">True</span>
<a name="db_helpers.py-pyg.html-143"></a>		<span class="k">except</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-144"></a>			<span class="k">return</span> <span class="bp">False</span>
<a name="db_helpers.py-pyg.html-145"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="db_helpers.py-pyg.html-146"></a>
<a name="db_helpers.py-pyg.html-147"></a><span class="c">### @export &quot;create_QA&quot;</span>
<a name="db_helpers.py-pyg.html-148"></a><span class="k">def</span> <span class="nf">create_QA</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-149"></a>	<span class="sd">&quot;&quot;&quot; Create a QA object and return the ID. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-150"></a>	<span class="n">qa</span> <span class="o">=</span> <span class="n">QA</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">question</span> <span class="o">=</span> <span class="n">question</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-151"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">qa</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-152"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-153"></a>	<span class="k">return</span> <span class="n">qa</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-154"></a>
<a name="db_helpers.py-pyg.html-155"></a><span class="c">### @export &quot;create_request&quot;</span>
<a name="db_helpers.py-pyg.html-156"></a><span class="k">def</span> <span class="nf">create_request</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">offline_submission_type</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">date_received</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-157"></a>	<span class="sd">&quot;&quot;&quot; Create a Request object and return the ID. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-158"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span> <span class="n">creator_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">offline_submission_type</span> <span class="o">=</span> <span class="n">offline_submission_type</span><span class="p">,</span> <span class="n">date_received</span> <span class="o">=</span> <span class="n">date_received</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-159"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-160"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-161"></a>	<span class="n">req</span><span class="o">.</span><span class="n">set_due_date</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-162"></a>	<span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-163"></a>
<a name="db_helpers.py-pyg.html-164"></a><span class="c">### @export &quot;create_subscriber&quot;</span>
<a name="db_helpers.py-pyg.html-165"></a><span class="k">def</span> <span class="nf">create_subscriber</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-166"></a>	<span class="sd">&quot;&quot;&quot; Create a Subscriber object and return the ID. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-167"></a>	<span class="n">subscriber</span> <span class="o">=</span> <span class="n">Subscriber</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-168"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">subscriber</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-169"></a>		<span class="n">subscriber</span> <span class="o">=</span> <span class="n">Subscriber</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-170"></a>		<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-171"></a>		<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-172"></a>		<span class="k">return</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">True</span>
<a name="db_helpers.py-pyg.html-173"></a>	<span class="k">return</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">False</span>
<a name="db_helpers.py-pyg.html-174"></a>
<a name="db_helpers.py-pyg.html-175"></a><span class="c">### @export &quot;create_note&quot;</span>
<a name="db_helpers.py-pyg.html-176"></a><span class="k">def</span> <span class="nf">create_note</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-177"></a>	<span class="sd">&quot;&quot;&quot; Create a Note object and return the ID. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-178"></a>	<span class="k">try</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-179"></a>		<span class="n">note</span> <span class="o">=</span> <span class="n">Note</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-180"></a>		<span class="n">put_obj</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-181"></a>		<span class="k">return</span> <span class="n">note</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-182"></a>	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-183"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">There was an issue with creating a note with text: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-184"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-185"></a>
<a name="db_helpers.py-pyg.html-186"></a><span class="c">### @export &quot;create_record&quot;</span>
<a name="db_helpers.py-pyg.html-187"></a><span class="k">def</span> <span class="nf">create_record</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-188"></a>	<span class="k">try</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-189"></a>		<span class="n">record</span> <span class="o">=</span> <span class="n">Record</span><span class="p">(</span><span class="n">doc_id</span> <span class="o">=</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-190"></a>		<span class="n">put_obj</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-191"></a>		<span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-192"></a>	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-193"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">There was an issue with creating a record: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-194"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-195"></a>
<a name="db_helpers.py-pyg.html-196"></a><span class="k">def</span> <span class="nf">remove_obj</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-197"></a>	<span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-198"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-199"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-200"></a>
<a name="db_helpers.py-pyg.html-201"></a><span class="c">### @export &quot;create_answer&quot;</span>
<a name="db_helpers.py-pyg.html-202"></a><span class="k">def</span> <span class="nf">create_answer</span><span class="p">(</span><span class="n">qa_id</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-203"></a>	<span class="n">qa</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;QA&quot;</span><span class="p">,</span> <span class="n">qa_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-204"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">qa</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-205"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">QA with id: </span><span class="si">%s</span><span class="s"> does not exist&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qa_id</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-206"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-207"></a>	<span class="n">qa</span><span class="o">.</span><span class="n">subscriber_id</span> <span class="o">=</span> <span class="n">subscriber_id</span>
<a name="db_helpers.py-pyg.html-208"></a>	<span class="n">qa</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">answer</span>
<a name="db_helpers.py-pyg.html-209"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">qa</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-210"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-211"></a>	<span class="k">return</span> <span class="n">qa</span><span class="o">.</span><span class="n">request_id</span>
<a name="db_helpers.py-pyg.html-212"></a>
<a name="db_helpers.py-pyg.html-213"></a><span class="c"># Following three functions are for integration with Mozilla Persona</span>
<a name="db_helpers.py-pyg.html-214"></a>
<a name="db_helpers.py-pyg.html-215"></a><span class="c">### @export &quot;get_user&quot;</span>
<a name="db_helpers.py-pyg.html-216"></a><span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-217"></a>    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-218"></a>
<a name="db_helpers.py-pyg.html-219"></a><span class="c">### @export &quot;get_user_by_id&quot;</span>
<a name="db_helpers.py-pyg.html-220"></a><span class="k">def</span> <span class="nf">get_user_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-221"></a>    <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-222"></a>
<a name="db_helpers.py-pyg.html-223"></a><span class="c">### @export &quot;create_or_return_user&quot;</span>
<a name="db_helpers.py-pyg.html-224"></a><span class="k">def</span> <span class="nf">create_or_return_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">contact_for</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">backup_for</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">not_id</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-225"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Creating or returning user...&quot;</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-226"></a>	<span class="k">if</span> <span class="n">email</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-227"></a>		<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">email</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-228"></a>		<span class="k">if</span> <span class="n">department</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">department</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">department</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
<a name="db_helpers.py-pyg.html-229"></a>			<span class="n">d</span> <span class="o">=</span> <span class="n">Department</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">department</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-230"></a>			<span class="k">if</span> <span class="n">d</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-231"></a>				<span class="n">department</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-232"></a>			<span class="k">else</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-233"></a>				<span class="n">d</span> <span class="o">=</span> <span class="n">Department</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">department</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-234"></a>				<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-235"></a>				<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-236"></a>				<span class="n">department</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-237"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-238"></a>			<span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="n">department</span><span class="p">,</span> <span class="n">contact_for</span> <span class="o">=</span> <span class="n">contact_for</span><span class="p">,</span> <span class="n">backup_for</span> <span class="o">=</span> <span class="n">backup_for</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="n">is_staff</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-239"></a>		<span class="k">else</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-240"></a>			<span class="k">if</span> <span class="n">alias</span> <span class="ow">or</span> <span class="n">phone</span> <span class="ow">or</span> <span class="n">department</span> <span class="ow">or</span> <span class="n">contact_for</span> <span class="ow">or</span> <span class="n">backup_for</span><span class="p">:</span> <span class="c"># Update user if fields to update are provided</span>
<a name="db_helpers.py-pyg.html-241"></a>				<span class="n">user</span> <span class="o">=</span> <span class="n">update_user</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="n">department</span><span class="p">,</span> <span class="n">contact_for</span> <span class="o">=</span> <span class="n">contact_for</span><span class="p">,</span> <span class="n">backup_for</span> <span class="o">=</span> <span class="n">backup_for</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="n">is_staff</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-242"></a>		<span class="k">if</span> <span class="n">not_id</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-243"></a>			<span class="k">return</span> <span class="n">user</span>
<a name="db_helpers.py-pyg.html-244"></a>		<span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-245"></a>	<span class="k">else</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-246"></a>		<span class="n">user</span> <span class="o">=</span> <span class="n">create_user</span><span class="p">(</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="n">is_staff</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-247"></a>		<span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-248"></a>
<a name="db_helpers.py-pyg.html-249"></a><span class="c">### @export &quot;create_user&quot;</span>
<a name="db_helpers.py-pyg.html-250"></a><span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">contact_for</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">backup_for</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-251"></a>	<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="n">department</span><span class="p">,</span> <span class="n">contact_for</span> <span class="o">=</span> <span class="n">contact_for</span><span class="p">,</span> <span class="n">backup_for</span> <span class="o">=</span> <span class="n">backup_for</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="n">is_staff</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-252"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-253"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-254"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Created new user, alias: </span><span class="si">%s</span><span class="s"> id: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-255"></a>	<span class="k">return</span> <span class="n">user</span>
<a name="db_helpers.py-pyg.html-256"></a>
<a name="db_helpers.py-pyg.html-257"></a><span class="c">### @export &quot;update_user&quot;</span>
<a name="db_helpers.py-pyg.html-258"></a><span class="k">def</span> <span class="nf">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">contact_for</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">backup_for</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-259"></a>	<span class="k">if</span> <span class="n">alias</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-260"></a>		<span class="n">user</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span>
<a name="db_helpers.py-pyg.html-261"></a>	<span class="k">if</span> <span class="n">phone</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-262"></a>		<span class="n">user</span><span class="o">.</span><span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span>
<a name="db_helpers.py-pyg.html-263"></a>	<span class="k">if</span> <span class="n">department</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-264"></a>		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">department</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">department</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
<a name="db_helpers.py-pyg.html-265"></a>			<span class="n">d</span> <span class="o">=</span> <span class="n">Department</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">department</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-266"></a>			<span class="k">if</span> <span class="n">d</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-267"></a>				<span class="n">user</span><span class="o">.</span><span class="n">department</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-268"></a>		<span class="k">else</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-269"></a>			<span class="n">user</span><span class="o">.</span><span class="n">department</span> <span class="o">=</span> <span class="n">department</span>
<a name="db_helpers.py-pyg.html-270"></a>	<span class="k">if</span> <span class="n">contact_for</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-271"></a>		<span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">contact_for</span> <span class="ow">and</span> <span class="n">contact_for</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">contact_for</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-272"></a>			<span class="n">contact_for</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">contact_for</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">contact_for</span>
<a name="db_helpers.py-pyg.html-273"></a>		<span class="n">user</span><span class="o">.</span><span class="n">contact_for</span> <span class="o">=</span> <span class="n">contact_for</span>
<a name="db_helpers.py-pyg.html-274"></a>	<span class="k">if</span> <span class="n">backup_for</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-275"></a>		<span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">backup_for</span> <span class="ow">and</span> <span class="n">backup_for</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="o">.</span><span class="n">backup_for</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-276"></a>			<span class="n">backup_for</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">backup_for</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">backup_for</span>
<a name="db_helpers.py-pyg.html-277"></a>		<span class="n">user</span><span class="o">.</span><span class="n">backup_for</span> <span class="o">=</span> <span class="n">backup_for</span>
<a name="db_helpers.py-pyg.html-278"></a>	<span class="k">if</span> <span class="n">is_staff</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-279"></a>		<span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="n">is_staff</span>
<a name="db_helpers.py-pyg.html-280"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-281"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-282"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Updated user </span><span class="si">%s</span><span class="s">, alias: </span><span class="si">%s</span><span class="s"> phone: </span><span class="si">%s</span><span class="s"> department: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">department</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-283"></a>	<span class="k">return</span> <span class="n">user</span>
<a name="db_helpers.py-pyg.html-284"></a>
<a name="db_helpers.py-pyg.html-285"></a><span class="c">### @export &quot;create_owner&quot;</span>
<a name="db_helpers.py-pyg.html-286"></a><span class="k">def</span> <span class="nf">create_owner</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-287"></a>	<span class="sd">&quot;&quot;&quot; Adds a staff member to the request without assigning them as current owner. (i.e. &quot;participant&quot;)</span>
<a name="db_helpers.py-pyg.html-288"></a><span class="sd">	Useful for multidepartmental requests.&quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-289"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-290"></a>		<span class="n">user_id</span> <span class="o">=</span> <span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-291"></a>	<span class="n">participant</span> <span class="o">=</span> <span class="n">Owner</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-292"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">participant</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-293"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-294"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Created owner with id: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-295"></a>	<span class="k">return</span> <span class="n">participant</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-296"></a>
<a name="db_helpers.py-pyg.html-297"></a><span class="c">### @export &quot;change_request_status&quot;</span>
<a name="db_helpers.py-pyg.html-298"></a><span class="k">def</span> <span class="nf">change_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-299"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-300"></a>	<span class="n">req</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
<a name="db_helpers.py-pyg.html-301"></a>	<span class="n">req</span><span class="o">.</span><span class="n">status_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-302"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-303"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Changed status for request: </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-304"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-305"></a>
<a name="db_helpers.py-pyg.html-306"></a><span class="c">### @export &quot;find_request&quot;</span>
<a name="db_helpers.py-pyg.html-307"></a><span class="k">def</span> <span class="nf">find_request</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-308"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-309"></a>	<span class="k">if</span> <span class="n">req</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-310"></a>		<span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">id</span>
<a name="db_helpers.py-pyg.html-311"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="db_helpers.py-pyg.html-312"></a>
<a name="db_helpers.py-pyg.html-313"></a>
<a name="db_helpers.py-pyg.html-314"></a><span class="c">### @export &quot;add_staff_participant&quot;</span>
<a name="db_helpers.py-pyg.html-315"></a><span class="k">def</span> <span class="nf">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">is_point_person</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-316"></a>	<span class="sd">&quot;&quot;&quot; Creates an owner for the request if it doesn&#39;t exist, and returns the owner ID and True if a new one was created. Returns the owner ID and False if existing.&quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-317"></a>	<span class="n">is_new</span> <span class="o">=</span> <span class="bp">True</span>
<a name="db_helpers.py-pyg.html-318"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-319"></a>		<span class="n">user_id</span> <span class="o">=</span> <span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-320"></a>	<span class="n">participant</span> <span class="o">=</span> <span class="n">Owner</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-321"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">participant</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-322"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">reason</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-323"></a>			<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;Added a response&quot;</span>
<a name="db_helpers.py-pyg.html-324"></a>		<span class="n">participant</span> <span class="o">=</span> <span class="n">Owner</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">,</span> <span class="n">is_point_person</span> <span class="o">=</span> <span class="n">is_point_person</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-325"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Staff participant with owner ID: </span><span class="si">%s</span><span class="s"> added to request </span><span class="si">%s</span><span class="s">. Is point of contact: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">is_point_person</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-326"></a>	<span class="k">else</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-327"></a>		<span class="k">if</span> <span class="n">is_point_person</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">participant</span><span class="o">.</span><span class="n">is_point_person</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-328"></a>			<span class="n">participant</span><span class="o">.</span><span class="n">is_point_person</span> <span class="o">=</span> <span class="bp">True</span>
<a name="db_helpers.py-pyg.html-329"></a>			<span class="n">participant</span><span class="o">.</span><span class="n">date_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-330"></a>			<span class="k">if</span> <span class="n">reason</span><span class="p">:</span> <span class="c"># Update the reason</span>
<a name="db_helpers.py-pyg.html-331"></a>				<span class="n">participant</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span> 
<a name="db_helpers.py-pyg.html-332"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Staff participant with owner ID: </span><span class="si">%s</span><span class="s"> is now the point of contact for request </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-333"></a>		<span class="k">else</span><span class="p">:</span>
<a name="db_helpers.py-pyg.html-334"></a>			<span class="n">is_new</span> <span class="o">=</span> <span class="bp">False</span>
<a name="db_helpers.py-pyg.html-335"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Staff participant with owner ID: </span><span class="si">%s</span><span class="s"> already active on request </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">request_id</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-336"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">participant</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-337"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-338"></a>	<span class="k">return</span> <span class="n">participant</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">is_new</span>
<a name="db_helpers.py-pyg.html-339"></a>
<a name="db_helpers.py-pyg.html-340"></a>
<a name="db_helpers.py-pyg.html-341"></a><span class="c">### @export &quot;remove_staff_participant&quot;</span>
<a name="db_helpers.py-pyg.html-342"></a><span class="k">def</span> <span class="nf">remove_staff_participant</span><span class="p">(</span><span class="n">owner_id</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-343"></a>	<span class="n">participant</span> <span class="o">=</span> <span class="n">Owner</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">owner_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-344"></a>	<span class="n">participant</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
<a name="db_helpers.py-pyg.html-345"></a>	<span class="n">participant</span><span class="o">.</span><span class="n">date_updated</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-346"></a>	<span class="n">participant</span><span class="o">.</span><span class="n">reason_unassigned</span> <span class="o">=</span> <span class="n">reason</span>
<a name="db_helpers.py-pyg.html-347"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">participant</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-348"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-349"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Staff participant with owner ID: </span><span class="si">%s</span><span class="s"> has been removed for following reason </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">owner_id</span><span class="p">,</span> <span class="n">reason</span><span class="p">))</span>
<a name="db_helpers.py-pyg.html-350"></a>	<span class="k">return</span> <span class="n">owner_id</span>
<a name="db_helpers.py-pyg.html-351"></a>
<a name="db_helpers.py-pyg.html-352"></a>
<a name="db_helpers.py-pyg.html-353"></a><span class="c">### @export &quot;update_subscriber&quot;</span>
<a name="db_helpers.py-pyg.html-354"></a><span class="k">def</span> <span class="nf">update_subscriber</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span><span class="p">):</span>
<a name="db_helpers.py-pyg.html-355"></a>	<span class="sd">&quot;&quot;&quot; Update a subscriber for a given request with the name and phone number provided. &quot;&quot;&quot;</span>
<a name="db_helpers.py-pyg.html-356"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">create_or_return_user</span><span class="p">(</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-357"></a>	<span class="n">r</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-358"></a>	<span class="n">sub</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">subscribers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a name="db_helpers.py-pyg.html-359"></a>	<span class="n">sub</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
<a name="db_helpers.py-pyg.html-360"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
<a name="db_helpers.py-pyg.html-361"></a>	<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="db_helpers.py-pyg.html-362"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Updated subscriber for request </span><span class="si">%s</span><span class="s"> with alias: </span><span class="si">%s</span><span class="s"> and phone: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span><span class="p">))</span>
</pre></div>

</pre>

<a name="csv_export">CSV export</a> 
<p>csv_export.py</p>
<pre>
<div class="highlight"><pre><a name="csv_export.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="csv_export.py-pyg.html-2"></a><span class="sd">    public_records_portal.csv_export</span>
<a name="csv_export.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="csv_export.py-pyg.html-4"></a>
<a name="csv_export.py-pyg.html-5"></a><span class="sd">    Implements an export to CSV function (for staff only) for relevant database fields.</span>
<a name="csv_export.py-pyg.html-6"></a>
<a name="csv_export.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="csv_export.py-pyg.html-8"></a>
<a name="csv_export.py-pyg.html-9"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">db</span>
<a name="csv_export.py-pyg.html-10"></a><span class="kn">import</span> <span class="nn">csv</span>
<a name="csv_export.py-pyg.html-11"></a>
<a name="csv_export.py-pyg.html-12"></a><span class="k">def</span> <span class="nf">export</span><span class="p">():</span>
<a name="csv_export.py-pyg.html-13"></a>	<span class="n">records</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="csv_export.py-pyg.html-14"></a>	<span class="n">db_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="s">&#39;date_received&#39;</span><span class="p">,</span> <span class="s">&#39;date_created&#39;</span><span class="p">,</span> <span class="s">&#39;due_date&#39;</span><span class="p">,</span> <span class="s">&#39;extended&#39;</span><span class="p">]</span>
<a name="csv_export.py-pyg.html-15"></a>	<span class="n">all_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Request ID&#39;</span><span class="p">,</span> <span class="s">&#39;Request Text&#39;</span><span class="p">,</span> <span class="s">&#39;Date Received&#39;</span><span class="p">,</span> <span class="s">&#39;Date Created&#39;</span><span class="p">,</span> <span class="s">&#39;Date Due&#39;</span><span class="p">,</span> <span class="s">&#39;Extended?&#39;</span><span class="p">,</span> <span class="s">&#39;Requester Name&#39;</span><span class="p">,</span> <span class="s">&#39;Requester Phone&#39;</span><span class="p">,</span> <span class="s">&#39;Department Name&#39;</span><span class="p">,</span> <span class="s">&#39;Point of Contact&#39;</span><span class="p">,</span> <span class="s">&#39;All staff involved&#39;</span><span class="p">,</span> <span class="s">&#39;Status&#39;</span><span class="p">]</span>
<a name="csv_export.py-pyg.html-16"></a>	<span class="k">yield</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_headers</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
<a name="csv_export.py-pyg.html-17"></a>	<span class="k">for</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
<a name="csv_export.py-pyg.html-18"></a>		<span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
<a name="csv_export.py-pyg.html-19"></a>		<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">db_headers</span><span class="p">:</span>
<a name="csv_export.py-pyg.html-20"></a>			<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;text&#39;</span><span class="p">:</span>
<a name="csv_export.py-pyg.html-21"></a>				<span class="n">text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span><span class="s">&#39;text&#39;</span><span class="p">)</span>
<a name="csv_export.py-pyg.html-22"></a>				<span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
<a name="csv_export.py-pyg.html-23"></a>				<span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
<a name="csv_export.py-pyg.html-24"></a>				<span class="c"># print text</span>
<a name="csv_export.py-pyg.html-25"></a>				<span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<a name="csv_export.py-pyg.html-26"></a>				<span class="k">continue</span>
<a name="csv_export.py-pyg.html-27"></a>			<span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span><span class="n">name</span><span class="p">)))</span>
<a name="csv_export.py-pyg.html-28"></a>		<span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">requester_name</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)))</span>
<a name="csv_export.py-pyg.html-29"></a>		<span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">requester_phone</span><span class="p">()))</span>
<a name="csv_export.py-pyg.html-30"></a>		<span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">department_name</span><span class="p">()))</span>
<a name="csv_export.py-pyg.html-31"></a>		<span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">point_person_name</span><span class="p">()))</span>
<a name="csv_export.py-pyg.html-32"></a>		<span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">all_owners</span><span class="p">())))</span>
<a name="csv_export.py-pyg.html-33"></a>		<span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">solid_status</span><span class="p">(</span><span class="n">cron_job</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)))</span>
<a name="csv_export.py-pyg.html-34"></a>		<span class="k">yield</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
</pre></div>

</pre>

<a name="notifications">Notifications</a> 
<p>notifications.py</p>
<pre>
<div class="highlight"><pre><a name="notifications.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="notifications.py-pyg.html-2"></a><span class="sd">    public_records_portal.notifications</span>
<a name="notifications.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="notifications.py-pyg.html-4"></a>
<a name="notifications.py-pyg.html-5"></a><span class="sd">    Implements e-mail notifications for RecordTrac. SendGrid (https://sendgrid.com/) is a dependency, and the following environment variables need to be set in order for this to work: MAIL_USERNAME, MAIL_PASSWORD, and DEFAULT_MAIL_SENDER.</span>
<a name="notifications.py-pyg.html-6"></a>
<a name="notifications.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="notifications.py-pyg.html-8"></a>
<a name="notifications.py-pyg.html-9"></a>
<a name="notifications.py-pyg.html-10"></a>
<a name="notifications.py-pyg.html-11"></a>
<a name="notifications.py-pyg.html-12"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a name="notifications.py-pyg.html-13"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">app</span>
<a name="notifications.py-pyg.html-14"></a><span class="kn">import</span> <span class="nn">os</span>
<a name="notifications.py-pyg.html-15"></a><span class="kn">import</span> <span class="nn">json</span>
<a name="notifications.py-pyg.html-16"></a><span class="kn">from</span> <span class="nn">db_helpers</span> <span class="kn">import</span> <span class="o">*</span>
<a name="notifications.py-pyg.html-17"></a><span class="kn">import</span> <span class="nn">sendgrid</span>
<a name="notifications.py-pyg.html-18"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<a name="notifications.py-pyg.html-19"></a><span class="kn">import</span> <span class="nn">helpers</span>
<a name="notifications.py-pyg.html-20"></a><span class="kn">import</span> <span class="nn">logging</span>
<a name="notifications.py-pyg.html-21"></a>
<a name="notifications.py-pyg.html-22"></a><span class="c"># Set flags:</span>
<a name="notifications.py-pyg.html-23"></a>
<a name="notifications.py-pyg.html-24"></a><span class="n">send_emails</span> <span class="o">=</span> <span class="bp">False</span>
<a name="notifications.py-pyg.html-25"></a><span class="n">test</span> <span class="o">=</span> <span class="s">&quot;[TEST] &quot;</span>
<a name="notifications.py-pyg.html-26"></a>
<a name="notifications.py-pyg.html-27"></a><span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ENVIRONMENT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;PRODUCTION&#39;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-28"></a>	<span class="n">send_emails</span> <span class="o">=</span> <span class="bp">True</span>
<a name="notifications.py-pyg.html-29"></a>	<span class="n">test</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<a name="notifications.py-pyg.html-30"></a><span class="k">elif</span> <span class="s">&#39;DEV_EMAIL&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="notifications.py-pyg.html-31"></a>	<span class="n">send_emails</span> <span class="o">=</span> <span class="bp">True</span>
<a name="notifications.py-pyg.html-32"></a>
<a name="notifications.py-pyg.html-33"></a><span class="c">### @export &quot;generate_prr_emails&quot;</span>
<a name="notifications.py-pyg.html-34"></a><span class="k">def</span> <span class="nf">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="notifications.py-pyg.html-35"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Generating e-mails for request with ID: </span><span class="si">%s</span><span class="s">, notification type: </span><span class="si">%s</span><span class="s">, and user ID: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
<a name="notifications.py-pyg.html-36"></a>	<span class="n">app_url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;APPLICATION_URL&#39;</span><span class="p">]</span> 
<a name="notifications.py-pyg.html-37"></a>	<span class="c"># Define the e-mail template:</span>
<a name="notifications.py-pyg.html-38"></a>	<span class="n">template</span> <span class="o">=</span> <span class="s">&quot;generic_email.html&quot;</span> 
<a name="notifications.py-pyg.html-39"></a>	<span class="k">if</span> <span class="n">notification_type</span> <span class="o">==</span> <span class="s">&quot;Request made&quot;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-40"></a>		<span class="n">template</span> <span class="o">=</span> <span class="s">&quot;new_request_email.html&quot;</span>
<a name="notifications.py-pyg.html-41"></a>	<span class="c"># Get information on who to send the e-mail to and with what subject line based on the notification type:</span>
<a name="notifications.py-pyg.html-42"></a>	<span class="n">email_info</span> <span class="o">=</span> <span class="n">get_email_info</span><span class="p">(</span><span class="n">notification_type</span><span class="o">=</span><span class="n">notification_type</span><span class="p">)</span>
<a name="notifications.py-pyg.html-43"></a>	<span class="n">email_subject</span> <span class="o">=</span> <span class="s">&quot;Public Records Request </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">email_info</span><span class="p">[</span><span class="s">&quot;Subject&quot;</span><span class="p">])</span>
<a name="notifications.py-pyg.html-44"></a>	<span class="n">recipient_types</span> <span class="o">=</span> <span class="n">email_info</span><span class="p">[</span><span class="s">&quot;Recipients&quot;</span><span class="p">]</span>
<a name="notifications.py-pyg.html-45"></a>	<span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="bp">True</span>
<a name="notifications.py-pyg.html-46"></a>	<span class="n">unfollow_link</span> <span class="o">=</span> <span class="bp">None</span> 
<a name="notifications.py-pyg.html-47"></a>	<span class="k">for</span> <span class="n">recipient_type</span> <span class="ow">in</span> <span class="n">recipient_types</span><span class="p">:</span>
<a name="notifications.py-pyg.html-48"></a>		<span class="c"># Skip anyone that has unsubscribed</span>
<a name="notifications.py-pyg.html-49"></a>		<span class="k">if</span> <span class="n">user_id</span> <span class="ow">and</span> <span class="p">(</span><span class="n">recipient_type</span> <span class="o">==</span> <span class="s">&quot;Requester&quot;</span> <span class="ow">or</span> <span class="n">recipient_type</span> <span class="o">==</span> <span class="s">&quot;Subscriber&quot;</span><span class="p">):</span>
<a name="notifications.py-pyg.html-50"></a>			<span class="n">subscriber</span> <span class="o">=</span> <span class="n">get_subscriber</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="notifications.py-pyg.html-51"></a>			<span class="n">should_notify</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;should_notify&quot;</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">subscriber</span><span class="p">)</span>
<a name="notifications.py-pyg.html-52"></a>			<span class="k">if</span> <span class="n">should_notify</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
<a name="notifications.py-pyg.html-53"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Subscriber </span><span class="si">%s</span><span class="s"> unsubscribed, no notification sent.&quot;</span> <span class="o">%</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="notifications.py-pyg.html-54"></a>				<span class="k">continue</span>
<a name="notifications.py-pyg.html-55"></a>		<span class="c"># Set up the e-mail</span>
<a name="notifications.py-pyg.html-56"></a>		<span class="n">page</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">request/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">app_url</span><span class="p">,</span><span class="n">request_id</span><span class="p">)</span> <span class="c"># The request URL </span>
<a name="notifications.py-pyg.html-57"></a>		<span class="k">if</span> <span class="s">&quot;Staff&quot;</span> <span class="ow">in</span> <span class="n">recipient_type</span><span class="p">:</span>
<a name="notifications.py-pyg.html-58"></a>			<span class="n">page</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">city/request/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">app_url</span><span class="p">,</span><span class="n">request_id</span><span class="p">)</span>
<a name="notifications.py-pyg.html-59"></a>			<span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Gets excluded for city staff</span>
<a name="notifications.py-pyg.html-60"></a>		<span class="k">else</span><span class="p">:</span>
<a name="notifications.py-pyg.html-61"></a>			<span class="n">unfollow_link</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">unfollow/</span><span class="si">%s</span><span class="s">/&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">app_url</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a name="notifications.py-pyg.html-62"></a>			<span class="k">if</span> <span class="n">notification_type</span> <span class="o">==</span> <span class="s">&quot;Request closed&quot;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-63"></a>				<span class="n">page</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">feedback/request/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">app_url</span><span class="p">,</span><span class="n">request_id</span><span class="p">)</span>
<a name="notifications.py-pyg.html-64"></a>		<span class="k">if</span> <span class="n">recipient_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;Staff owner&quot;</span><span class="p">,</span><span class="s">&quot;Requester&quot;</span><span class="p">,</span><span class="s">&quot;Subscriber&quot;</span><span class="p">,</span><span class="s">&quot;Staff participant&quot;</span><span class="p">]:</span>
<a name="notifications.py-pyg.html-65"></a>			<span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
<a name="notifications.py-pyg.html-66"></a>				<span class="n">recipient</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;email&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;User&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-67"></a>				<span class="c"># if recipient_type != &quot;Subscriber&quot; or get_attribute(attribute=&quot;&quot;)</span>
<a name="notifications.py-pyg.html-68"></a>				<span class="k">if</span> <span class="n">recipient</span><span class="p">:</span>
<a name="notifications.py-pyg.html-69"></a>					<span class="k">if</span> <span class="n">unfollow_link</span><span class="p">:</span>
<a name="notifications.py-pyg.html-70"></a>						<span class="n">unfollow_link</span> <span class="o">=</span> <span class="n">unfollow_link</span> <span class="o">+</span> <span class="n">recipient</span>
<a name="notifications.py-pyg.html-71"></a>					<span class="n">send_prr_email</span><span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">,</span> <span class="n">recipients</span> <span class="o">=</span> <span class="p">[</span><span class="n">recipient</span><span class="p">],</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">email_subject</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="p">,</span> <span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="n">include_unsubscribe_link</span><span class="p">,</span> <span class="n">unfollow_link</span> <span class="o">=</span> <span class="n">unfollow_link</span><span class="p">)</span>
<a name="notifications.py-pyg.html-72"></a>			<span class="k">else</span><span class="p">:</span>
<a name="notifications.py-pyg.html-73"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> No user ID provided&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-74"></a>		<span class="k">elif</span> <span class="n">recipient_type</span> <span class="o">==</span> <span class="s">&quot;Subscribers&quot;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-75"></a>			<span class="n">subscribers</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;subscribers&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;Request&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-76"></a>			<span class="k">for</span> <span class="n">subscriber</span> <span class="ow">in</span> <span class="n">subscribers</span><span class="p">:</span>
<a name="notifications.py-pyg.html-77"></a>				<span class="k">if</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">should_notify</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
<a name="notifications.py-pyg.html-78"></a>					<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Subscriber </span><span class="si">%s</span><span class="s"> unsubscribed&quot;</span> <span class="o">%</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="notifications.py-pyg.html-79"></a>					<span class="k">continue</span>
<a name="notifications.py-pyg.html-80"></a>				<span class="n">recipient</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;email&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;User&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-81"></a>				<span class="k">if</span> <span class="n">recipient</span><span class="p">:</span>
<a name="notifications.py-pyg.html-82"></a>					<span class="k">if</span> <span class="n">unfollow_link</span><span class="p">:</span>
<a name="notifications.py-pyg.html-83"></a>						<span class="n">unfollow_link</span> <span class="o">=</span> <span class="n">unfollow_link</span> <span class="o">+</span> <span class="n">recipient</span>
<a name="notifications.py-pyg.html-84"></a>					<span class="n">send_prr_email</span><span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">,</span> <span class="n">recipients</span> <span class="o">=</span> <span class="p">[</span><span class="n">recipient</span><span class="p">],</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">email_subject</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="p">,</span> <span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="n">include_unsubscribe_link</span><span class="p">,</span> <span class="n">unfollow_link</span> <span class="o">=</span> <span class="n">unfollow_link</span><span class="p">)</span> <span class="c"># Each subscriber needs to get a separate e-mail.</span>
<a name="notifications.py-pyg.html-85"></a>		<span class="k">elif</span> <span class="n">recipient_type</span> <span class="o">==</span> <span class="s">&quot;Staff participants&quot;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-86"></a>			<span class="n">recipients</span> <span class="o">=</span> <span class="p">[]</span>
<a name="notifications.py-pyg.html-87"></a>			<span class="n">participants</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;owners&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;Request&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-88"></a>			<span class="k">for</span> <span class="n">participant</span> <span class="ow">in</span> <span class="n">participants</span><span class="p">:</span>
<a name="notifications.py-pyg.html-89"></a>				<span class="k">if</span> <span class="n">participant</span><span class="o">.</span><span class="n">active</span><span class="p">:</span> <span class="c"># Only send an e-mail if they are active in the request</span>
<a name="notifications.py-pyg.html-90"></a>					<span class="n">recipient</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;email&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">participant</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;User&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-91"></a>					<span class="k">if</span> <span class="n">recipient</span><span class="p">:</span>
<a name="notifications.py-pyg.html-92"></a>						<span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recipient</span><span class="p">)</span>
<a name="notifications.py-pyg.html-93"></a>			<span class="n">send_prr_email</span><span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">,</span> <span class="n">recipients</span> <span class="o">=</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">email_subject</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="n">template</span><span class="p">,</span> <span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="n">include_unsubscribe_link</span><span class="p">,</span> <span class="n">cc_everyone</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">unfollow_link</span> <span class="o">=</span> <span class="n">unfollow_link</span><span class="p">)</span>
<a name="notifications.py-pyg.html-94"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Recipients: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">recipients</span><span class="p">)</span>
<a name="notifications.py-pyg.html-95"></a>		<span class="k">else</span><span class="p">:</span>
<a name="notifications.py-pyg.html-96"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Not a valid recipient type: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">recipient_type</span><span class="p">)</span>
<a name="notifications.py-pyg.html-97"></a>
<a name="notifications.py-pyg.html-98"></a><span class="c">### @export &quot;send_prr_email&quot;</span>
<a name="notifications.py-pyg.html-99"></a><span class="k">def</span> <span class="nf">send_prr_email</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">cc_everyone</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">unfollow_link</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="notifications.py-pyg.html-100"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Attempting to send an e-mail to </span><span class="si">%s</span><span class="s"> with subject </span><span class="si">%s</span><span class="s">, referencing page </span><span class="si">%s</span><span class="s"> and template </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">recipients</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">template</span><span class="p">))</span>
<a name="notifications.py-pyg.html-101"></a>	<span class="k">if</span> <span class="n">recipients</span><span class="p">:</span>
<a name="notifications.py-pyg.html-102"></a>		<span class="k">if</span> <span class="n">send_emails</span><span class="p">:</span>
<a name="notifications.py-pyg.html-103"></a>			<span class="k">try</span><span class="p">:</span>
<a name="notifications.py-pyg.html-104"></a>				<span class="n">send_email</span><span class="p">(</span><span class="n">body</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">unfollow_link</span> <span class="o">=</span> <span class="n">unfollow_link</span><span class="p">,</span> <span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">,</span> <span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="p">),</span> <span class="n">recipients</span> <span class="o">=</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">subject</span><span class="p">,</span> <span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="n">include_unsubscribe_link</span><span class="p">,</span> <span class="n">cc_everyone</span> <span class="o">=</span> <span class="n">cc_everyone</span><span class="p">)</span>
<a name="notifications.py-pyg.html-105"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> E-mail sent successfully!&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-106"></a>			<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="notifications.py-pyg.html-107"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">There was an error sending the e-mail: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
<a name="notifications.py-pyg.html-108"></a>		<span class="k">else</span><span class="p">:</span>
<a name="notifications.py-pyg.html-109"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> E-mail flag turned off, no e-mails sent.&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-110"></a>
<a name="notifications.py-pyg.html-111"></a><span class="c">### @export &quot;send_email&quot;</span>
<a name="notifications.py-pyg.html-112"></a><span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">cc_everyone</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="notifications.py-pyg.html-113"></a>	<span class="n">mail</span> <span class="o">=</span> <span class="n">sendgrid</span><span class="o">.</span><span class="n">Sendgrid</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;MAIL_USERNAME&#39;</span><span class="p">],</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;MAIL_PASSWORD&#39;</span><span class="p">],</span> <span class="n">secure</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="notifications.py-pyg.html-114"></a>	<span class="n">sender</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEFAULT_MAIL_SENDER&#39;</span><span class="p">]</span>
<a name="notifications.py-pyg.html-115"></a>	<span class="n">plaintext</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<a name="notifications.py-pyg.html-116"></a>	<span class="n">html</span> <span class="o">=</span> <span class="n">body</span>
<a name="notifications.py-pyg.html-117"></a>	<span class="n">message</span> <span class="o">=</span> <span class="n">sendgrid</span><span class="o">.</span><span class="n">Message</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
<a name="notifications.py-pyg.html-118"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">include_unsubscribe_link</span><span class="p">:</span>
<a name="notifications.py-pyg.html-119"></a>		<span class="n">message</span><span class="o">.</span><span class="n">add_filter_setting</span><span class="p">(</span><span class="s">&quot;subscriptiontrack&quot;</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a name="notifications.py-pyg.html-120"></a>	<span class="k">if</span> <span class="s">&#39;DEV_EMAIL&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="notifications.py-pyg.html-121"></a>		<span class="n">recipients</span> <span class="o">=</span> <span class="p">[</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEV_EMAIL&#39;</span><span class="p">]]</span>
<a name="notifications.py-pyg.html-122"></a>	<span class="k">if</span> <span class="n">cc_everyone</span><span class="p">:</span> <span class="c"># Not being used for now</span>
<a name="notifications.py-pyg.html-123"></a>		<span class="n">message</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">recipients</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a name="notifications.py-pyg.html-124"></a>		<span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
<a name="notifications.py-pyg.html-125"></a>			<span class="c"># if should_notify(recipient):</span>
<a name="notifications.py-pyg.html-126"></a>				<span class="n">message</span><span class="o">.</span><span class="n">add_cc</span><span class="p">(</span><span class="n">recipient</span><span class="p">)</span>
<a name="notifications.py-pyg.html-127"></a>	<span class="k">else</span><span class="p">:</span>
<a name="notifications.py-pyg.html-128"></a>		<span class="k">for</span> <span class="n">recipient</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
<a name="notifications.py-pyg.html-129"></a>			<span class="c"># if should_notify(recipient):</span>
<a name="notifications.py-pyg.html-130"></a>				<span class="n">message</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">recipient</span><span class="p">)</span>
<a name="notifications.py-pyg.html-131"></a>	<span class="n">message</span><span class="o">.</span><span class="n">add_bcc</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>
<a name="notifications.py-pyg.html-132"></a>	<span class="k">if</span> <span class="n">send_emails</span><span class="p">:</span>
<a name="notifications.py-pyg.html-133"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Attempting to send e-mail with body: </span><span class="si">%s</span><span class="s">, subject: </span><span class="si">%s</span><span class="s">, to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">recipients</span><span class="p">))</span>
<a name="notifications.py-pyg.html-134"></a>		<span class="k">try</span><span class="p">:</span>
<a name="notifications.py-pyg.html-135"></a>			<span class="n">status</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a name="notifications.py-pyg.html-136"></a>			<span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
<a name="notifications.py-pyg.html-137"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Sendgrid did not deliver e-mail.&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-138"></a>			<span class="k">return</span> <span class="n">status</span>
<a name="notifications.py-pyg.html-139"></a>		<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="notifications.py-pyg.html-140"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">No e-mail was sent, error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
<a name="notifications.py-pyg.html-141"></a>			<span class="k">return</span> <span class="bp">False</span>
<a name="notifications.py-pyg.html-142"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">No e-mail was sent, probably because you&#39;re in a non-production environment.&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-143"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="notifications.py-pyg.html-144"></a>
<a name="notifications.py-pyg.html-145"></a><span class="c">### @export &quot;due_date&quot;</span>
<a name="notifications.py-pyg.html-146"></a><span class="k">def</span> <span class="nf">due_date</span><span class="p">(</span><span class="n">date_obj</span><span class="p">,</span> <span class="n">extended</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">format</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
<a name="notifications.py-pyg.html-147"></a>	<span class="n">days_to_fulfill</span> <span class="o">=</span> <span class="mi">10</span>
<a name="notifications.py-pyg.html-148"></a>	<span class="k">if</span> <span class="n">extended</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
<a name="notifications.py-pyg.html-149"></a>		<span class="n">days_to_fulfill</span> <span class="o">=</span> <span class="n">days_to_fulfill</span> <span class="o">+</span> <span class="mi">14</span>
<a name="notifications.py-pyg.html-150"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">date_obj</span><span class="p">:</span>
<a name="notifications.py-pyg.html-151"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="notifications.py-pyg.html-152"></a>	<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">date_obj</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">datetime</span><span class="p">:</span>
<a name="notifications.py-pyg.html-153"></a>		<span class="n">date_obj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_obj</span><span class="p">,</span> <span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S.</span><span class="si">%f</span><span class="s">&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-154"></a>	<span class="n">due_date</span> <span class="o">=</span> <span class="n">date_obj</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="n">days_to_fulfill</span><span class="p">)</span>
<a name="notifications.py-pyg.html-155"></a>	<span class="k">if</span> <span class="n">format</span><span class="p">:</span>
<a name="notifications.py-pyg.html-156"></a>		<span class="k">return</span> <span class="n">format_date</span><span class="p">(</span><span class="n">due_date</span><span class="p">)</span>
<a name="notifications.py-pyg.html-157"></a>	<span class="k">return</span> <span class="n">due_date</span>
<a name="notifications.py-pyg.html-158"></a>
<a name="notifications.py-pyg.html-159"></a><span class="c">### @export &quot;is_overdue&quot;</span>
<a name="notifications.py-pyg.html-160"></a><span class="k">def</span> <span class="nf">is_overdue</span><span class="p">(</span><span class="n">date_obj</span><span class="p">,</span> <span class="n">extended</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="notifications.py-pyg.html-161"></a>	<span class="n">current_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<a name="notifications.py-pyg.html-162"></a>	<span class="n">due</span> <span class="o">=</span> <span class="n">due_date</span><span class="p">(</span><span class="n">date_obj</span> <span class="o">=</span> <span class="n">date_obj</span><span class="p">,</span> <span class="n">extended</span> <span class="o">=</span> <span class="n">extended</span><span class="p">,</span> <span class="n">format</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<a name="notifications.py-pyg.html-163"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">current_date</span> <span class="o">&gt;=</span> <span class="n">due</span><span class="p">):</span>
<a name="notifications.py-pyg.html-164"></a>		<span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">due</span>
<a name="notifications.py-pyg.html-165"></a>	<span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">due</span>
<a name="notifications.py-pyg.html-166"></a>
<a name="notifications.py-pyg.html-167"></a><span class="c">### @export &quot;get_email_info&quot;</span>
<a name="notifications.py-pyg.html-168"></a><span class="k">def</span> <span class="nf">get_email_info</span><span class="p">(</span><span class="n">notification_type</span><span class="p">):</span>
<a name="notifications.py-pyg.html-169"></a>	<span class="n">email_json</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&#39;static/json/emails.json&#39;</span><span class="p">))</span>
<a name="notifications.py-pyg.html-170"></a>	<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">email_json</span><span class="p">)</span>
<a name="notifications.py-pyg.html-171"></a>	<span class="k">return</span> <span class="n">json_data</span><span class="p">[</span><span class="s">&quot;Notification types&quot;</span><span class="p">][</span><span class="n">notification_type</span><span class="p">]</span>
<a name="notifications.py-pyg.html-172"></a>
<a name="notifications.py-pyg.html-173"></a><span class="c">### @export &quot;notify_due&quot;</span>
<a name="notifications.py-pyg.html-174"></a><span class="k">def</span> <span class="nf">notify_due</span><span class="p">():</span>
<a name="notifications.py-pyg.html-175"></a>	<span class="n">requests</span> <span class="o">=</span> <span class="n">get_objs</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-176"></a>	<span class="n">email_json</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&#39;static/json/emails.json&#39;</span><span class="p">))</span>
<a name="notifications.py-pyg.html-177"></a>	<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">email_json</span><span class="p">)</span>
<a name="notifications.py-pyg.html-178"></a>	<span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
<a name="notifications.py-pyg.html-179"></a>		<span class="n">status</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">solid_status</span>
<a name="notifications.py-pyg.html-180"></a>		<span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s">&quot;closed&quot;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-181"></a>			<span class="c"># Check if it is due in 2 days</span>
<a name="notifications.py-pyg.html-182"></a>			<span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s">&quot;due soon&quot;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-183"></a>				<span class="n">change_request_status</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Due soon&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-184"></a>				<span class="n">email_subject</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">Public Records Request </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">json_data</span><span class="p">[</span><span class="s">&quot;Notification types&quot;</span><span class="p">][</span><span class="s">&quot;Request due&quot;</span><span class="p">])</span>
<a name="notifications.py-pyg.html-185"></a>			<span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s">&quot;overdue&quot;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-186"></a>				<span class="n">change_request_status</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Overdue&quot;</span><span class="p">)</span>
<a name="notifications.py-pyg.html-187"></a>				<span class="n">email_subject</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">Public Records Request </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">json_data</span><span class="p">[</span><span class="s">&quot;Notification types&quot;</span><span class="p">][</span><span class="s">&quot;Request overdue&quot;</span><span class="p">][</span><span class="s">&quot;Subject&quot;</span><span class="p">])</span>
<a name="notifications.py-pyg.html-188"></a>			<span class="k">else</span><span class="p">:</span>
<a name="notifications.py-pyg.html-189"></a>				<span class="k">continue</span>
<a name="notifications.py-pyg.html-190"></a>			<span class="n">recipients</span> <span class="o">=</span> <span class="n">get_staff_recipients</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<a name="notifications.py-pyg.html-191"></a>			<span class="n">app_url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;APPLICATION_URL&#39;</span><span class="p">]</span>
<a name="notifications.py-pyg.html-192"></a>			<span class="n">page</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">city/request/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">app_url</span><span class="p">,</span><span class="n">req</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="notifications.py-pyg.html-193"></a>			<span class="n">body</span> <span class="o">=</span> <span class="s">&quot;You can view the request and take any necessary action at the following webpage: &lt;a href=&#39;</span><span class="si">%s</span><span class="s">&#39;&gt;</span><span class="si">%s</span><span class="s">&lt;/a&gt;.&lt;/br&gt;&lt;/br&gt; This is an automated message. You are receiving it because you are listed as the Public Records Request Liaison, Backup or Supervisor for your department.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
<a name="notifications.py-pyg.html-194"></a>				<span class="c"># Need to figure out a way to pass in generic email template outside application context. For now, hardcoding the body.</span>
<a name="notifications.py-pyg.html-195"></a>			<span class="n">send_email</span><span class="p">(</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="p">,</span> <span class="n">recipients</span> <span class="o">=</span> <span class="n">recipients</span><span class="p">,</span> <span class="n">subject</span> <span class="o">=</span> <span class="n">email_subject</span><span class="p">,</span> <span class="n">include_unsubscribe_link</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<a name="notifications.py-pyg.html-196"></a>
<a name="notifications.py-pyg.html-197"></a><span class="c">### @export &quot;get_staff_recipients&quot;</span>
<a name="notifications.py-pyg.html-198"></a><span class="k">def</span> <span class="nf">get_staff_recipients</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<a name="notifications.py-pyg.html-199"></a>	<span class="n">recipients</span> <span class="o">=</span> <span class="p">[]</span>
<a name="notifications.py-pyg.html-200"></a>	<span class="n">owner_email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">point_person</span><span class="p">()</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<a name="notifications.py-pyg.html-201"></a>	<span class="k">if</span> <span class="n">owner_email</span><span class="p">:</span>
<a name="notifications.py-pyg.html-202"></a>		<span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">owner_email</span><span class="p">)</span>
<a name="notifications.py-pyg.html-203"></a>	<span class="c"># Look up the department for the request, and get the contacts and backup:</span>
<a name="notifications.py-pyg.html-204"></a>	<span class="n">dept</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">department_name</span><span class="p">()</span>
<a name="notifications.py-pyg.html-205"></a>	<span class="k">if</span> <span class="n">dept</span> <span class="o">!=</span> <span class="s">&quot;N/A&quot;</span><span class="p">:</span>
<a name="notifications.py-pyg.html-206"></a>		<span class="n">contact_email</span> <span class="o">=</span> <span class="n">get_contact_by_dept</span><span class="p">(</span><span class="n">dept</span><span class="p">)</span>
<a name="notifications.py-pyg.html-207"></a>		<span class="k">if</span> <span class="n">contact_email</span> <span class="ow">and</span> <span class="n">contact_email</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
<a name="notifications.py-pyg.html-208"></a>			<span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contact_email</span><span class="p">)</span>
<a name="notifications.py-pyg.html-209"></a>		<span class="n">backup_email</span> <span class="o">=</span> <span class="n">get_backup_by_dept</span><span class="p">(</span><span class="n">dept</span><span class="p">)</span>
<a name="notifications.py-pyg.html-210"></a>		<span class="k">if</span> <span class="n">backup_email</span> <span class="ow">and</span> <span class="n">backup_email</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">recipients</span><span class="p">:</span>
<a name="notifications.py-pyg.html-211"></a>			<span class="n">recipients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">backup_email</span><span class="p">)</span>
<a name="notifications.py-pyg.html-212"></a>	<span class="k">if</span> <span class="n">recipients</span><span class="p">:</span>
<a name="notifications.py-pyg.html-213"></a>		<span class="k">return</span> <span class="n">recipients</span>
<a name="notifications.py-pyg.html-214"></a>	<span class="k">else</span><span class="p">:</span>
<a name="notifications.py-pyg.html-215"></a>		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No staff recipients for request </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">))</span> 
<a name="notifications.py-pyg.html-216"></a>
<a name="notifications.py-pyg.html-217"></a><span class="c">### @export &quot;should_notify&quot;</span>
<a name="notifications.py-pyg.html-218"></a><span class="k">def</span> <span class="nf">should_notify</span><span class="p">(</span><span class="n">user_email</span><span class="p">):</span>
<a name="notifications.py-pyg.html-219"></a>	<span class="sd">&quot;&quot;&quot; Looks up the user in do_not_email.json and returns False if found. &quot;&quot;&quot;</span>
<a name="notifications.py-pyg.html-220"></a>	<span class="n">do_not_email</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&#39;static/json/do_not_email.json&#39;</span><span class="p">))</span>
<a name="notifications.py-pyg.html-221"></a>	<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">do_not_email</span><span class="p">)</span>
<a name="notifications.py-pyg.html-222"></a>	<span class="k">for</span> <span class="n">department</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
<a name="notifications.py-pyg.html-223"></a>		<span class="n">emails</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="n">department</span><span class="p">][</span><span class="s">&#39;Emails&#39;</span><span class="p">]</span>
<a name="notifications.py-pyg.html-224"></a>		<span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">emails</span><span class="p">:</span>
<a name="notifications.py-pyg.html-225"></a>			<span class="k">if</span> <span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">user_email</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
<a name="notifications.py-pyg.html-226"></a>				<span class="k">return</span> <span class="bp">False</span>
<a name="notifications.py-pyg.html-227"></a>	<span class="k">return</span> <span class="bp">True</span>
<a name="notifications.py-pyg.html-228"></a>
<a name="notifications.py-pyg.html-229"></a><span class="c">### @export &quot;format_date&quot;</span>
<a name="notifications.py-pyg.html-230"></a><span class="k">def</span> <span class="nf">format_date</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<a name="notifications.py-pyg.html-231"></a>	<span class="sd">&quot;&quot;&quot; Take a datetime object and return it in format Jun 12, 2013 &quot;&quot;&quot;</span>
<a name="notifications.py-pyg.html-232"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
<a name="notifications.py-pyg.html-233"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="notifications.py-pyg.html-234"></a>	<span class="k">return</span> <span class="n">helpers</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%b </span><span class="si">%d</span><span class="s">, %Y&#39;</span><span class="p">)</span>
</pre></div>

</pre>

<a name="prflask">API and admin setup</a> 
<p>prflask.py</p>
<pre>
<div class="highlight"><pre><a name="prflask.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="prflask.py-pyg.html-2"></a><span class="sd">    public_records_portal.prflask</span>
<a name="prflask.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="prflask.py-pyg.html-4"></a>
<a name="prflask.py-pyg.html-5"></a><span class="sd">    Sets up API and admin endpoints for the RecordTrac flask application.</span>
<a name="prflask.py-pyg.html-6"></a>
<a name="prflask.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="prflask.py-pyg.html-8"></a>
<a name="prflask.py-pyg.html-9"></a>
<a name="prflask.py-pyg.html-10"></a>
<a name="prflask.py-pyg.html-11"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">views</span>
<a name="prflask.py-pyg.html-12"></a><span class="kn">from</span> <span class="nn">views</span> <span class="kn">import</span> <span class="o">*</span> <span class="c"># Import all the functions that render templates</span>
<a name="prflask.py-pyg.html-13"></a><span class="kn">from</span> <span class="nn">flask.ext.restless</span> <span class="kn">import</span> <span class="n">APIManager</span>
<a name="prflask.py-pyg.html-14"></a><span class="kn">from</span> <span class="nn">flask.ext.admin</span> <span class="kn">import</span> <span class="n">Admin</span><span class="p">,</span> <span class="n">expose</span><span class="p">,</span> <span class="n">BaseView</span><span class="p">,</span> <span class="n">AdminIndexView</span>
<a name="prflask.py-pyg.html-15"></a><span class="kn">from</span> <span class="nn">flask.ext.admin.contrib.sqlamodel</span> <span class="kn">import</span> <span class="n">ModelView</span>
<a name="prflask.py-pyg.html-16"></a>
<a name="prflask.py-pyg.html-17"></a>
<a name="prflask.py-pyg.html-18"></a><span class="c"># Create API</span>
<a name="prflask.py-pyg.html-19"></a><span class="n">manager</span> <span class="o">=</span> <span class="n">APIManager</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">flask_sqlalchemy_db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
<a name="prflask.py-pyg.html-20"></a>
<a name="prflask.py-pyg.html-21"></a>
<a name="prflask.py-pyg.html-22"></a><span class="c"># The endpoints created are /api/object, e.g. publicrecordsareawesome.com/api/request/</span>
<a name="prflask.py-pyg.html-23"></a><span class="n">manager</span><span class="o">.</span><span class="n">create_api</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">],</span> <span class="n">results_per_page</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">allow_functions</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">include_columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;date_created&#39;</span><span class="p">,</span> <span class="s">&#39;date_received&#39;</span><span class="p">,</span> <span class="s">&#39;department&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;notes&#39;</span><span class="p">,</span> <span class="s">&#39;offline_submission_type&#39;</span><span class="p">,</span> <span class="s">&#39;owners&#39;</span><span class="p">,</span> <span class="s">&#39;qas&#39;</span><span class="p">,</span> <span class="s">&#39;records&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;status_updated&#39;</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">])</span>
<a name="prflask.py-pyg.html-24"></a><span class="c"># manager.create_api(models.Owner, methods=[&#39;GET&#39;], results_per_page = 10, allow_functions = True)</span>
<a name="prflask.py-pyg.html-25"></a><span class="n">manager</span><span class="o">.</span><span class="n">create_api</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Note</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">],</span> <span class="n">results_per_page</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">allow_functions</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prflask.py-pyg.html-26"></a><span class="n">manager</span><span class="o">.</span><span class="n">create_api</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Record</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">],</span> <span class="n">results_per_page</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">allow_functions</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prflask.py-pyg.html-27"></a><span class="n">manager</span><span class="o">.</span><span class="n">create_api</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">QA</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">],</span> <span class="n">results_per_page</span> <span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">allow_functions</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prflask.py-pyg.html-28"></a><span class="c"># manager.create_api(models.Subscriber, methods=[&#39;GET&#39;], results_per_page = 10, allow_functions = True)</span>
<a name="prflask.py-pyg.html-29"></a><span class="n">manager</span><span class="o">.</span><span class="n">create_api</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Visualization</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">],</span> <span class="n">results_per_page</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">allow_functions</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prflask.py-pyg.html-30"></a>
<a name="prflask.py-pyg.html-31"></a><span class="k">class</span> <span class="nc">HomeView</span><span class="p">(</span><span class="n">AdminIndexView</span><span class="p">):</span>
<a name="prflask.py-pyg.html-32"></a>    <span class="nd">@expose</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-33"></a>    <span class="k">def</span> <span class="nf">home</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="prflask.py-pyg.html-34"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s">&#39;admin.html&#39;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-35"></a>    <span class="k">def</span> <span class="nf">is_accessible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="prflask.py-pyg.html-36"></a>		<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<a name="prflask.py-pyg.html-37"></a>			<span class="k">if</span> <span class="s">&#39;LIST_OF_ADMINS&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="prflask.py-pyg.html-38"></a>				<span class="n">admins</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;LIST_OF_ADMINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-39"></a>				<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
<a name="prflask.py-pyg.html-40"></a>					<span class="k">return</span> <span class="bp">True</span>
<a name="prflask.py-pyg.html-41"></a>		<span class="k">return</span> <span class="bp">False</span>
<a name="prflask.py-pyg.html-42"></a>
<a name="prflask.py-pyg.html-43"></a><span class="c"># Create Admin</span>
<a name="prflask.py-pyg.html-44"></a><span class="n">admin</span> <span class="o">=</span> <span class="n">Admin</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;RecordTrac Admin&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s">&#39;/admin&#39;</span><span class="p">,</span> <span class="n">index_view</span> <span class="o">=</span> <span class="n">HomeView</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Home&#39;</span><span class="p">))</span>
<a name="prflask.py-pyg.html-45"></a>
<a name="prflask.py-pyg.html-46"></a><span class="k">class</span> <span class="nc">AdminView</span><span class="p">(</span><span class="n">ModelView</span><span class="p">):</span>
<a name="prflask.py-pyg.html-47"></a>    <span class="k">def</span> <span class="nf">is_accessible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="prflask.py-pyg.html-48"></a>    	<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<a name="prflask.py-pyg.html-49"></a>    		<span class="k">if</span> <span class="s">&#39;LIST_OF_ADMINS&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="prflask.py-pyg.html-50"></a>				<span class="n">admins</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;LIST_OF_ADMINS&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-51"></a>				<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">admins</span><span class="p">:</span>
<a name="prflask.py-pyg.html-52"></a>					<span class="k">return</span> <span class="bp">True</span>
<a name="prflask.py-pyg.html-53"></a>        <span class="k">return</span> <span class="bp">False</span>
<a name="prflask.py-pyg.html-54"></a>
<a name="prflask.py-pyg.html-55"></a><span class="k">class</span> <span class="nc">RequestView</span><span class="p">(</span><span class="n">AdminView</span><span class="p">):</span>
<a name="prflask.py-pyg.html-56"></a>	<span class="n">can_create</span> <span class="o">=</span> <span class="bp">False</span>
<a name="prflask.py-pyg.html-57"></a>	<span class="n">can_edit</span> <span class="o">=</span> <span class="bp">True</span>
<a name="prflask.py-pyg.html-58"></a>	<span class="n">column_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="s">&#39;date_created&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">)</span> <span class="c"># The fields the admin can view</span>
<a name="prflask.py-pyg.html-59"></a>	<span class="n">column_searchable_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">)</span> <span class="c"># The fields the admin can search a request by</span>
<a name="prflask.py-pyg.html-60"></a>	<span class="n">form_excluded_columns</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;date_created&#39;</span><span class="p">,</span> <span class="s">&#39;extended&#39;</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">,</span> <span class="s">&#39;status_updated&#39;</span><span class="p">,</span> <span class="s">&#39;current_owner&#39;</span><span class="p">)</span> <span class="c"># The fields the admin cannot edit.</span>
<a name="prflask.py-pyg.html-61"></a>
<a name="prflask.py-pyg.html-62"></a><span class="k">class</span> <span class="nc">RecordView</span><span class="p">(</span><span class="n">AdminView</span><span class="p">):</span>
<a name="prflask.py-pyg.html-63"></a>	<span class="n">can_create</span> <span class="o">=</span> <span class="bp">False</span>
<a name="prflask.py-pyg.html-64"></a>	<span class="n">column_searchable_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">&#39;download_url&#39;</span><span class="p">,</span> <span class="s">&#39;access&#39;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-65"></a>	<span class="n">column_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;request_id&#39;</span><span class="p">,</span> <span class="s">&#39;description&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="s">&#39;download_url&#39;</span><span class="p">,</span> <span class="s">&#39;access&#39;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-66"></a>	<span class="n">can_edit</span> <span class="o">=</span> <span class="bp">False</span>
<a name="prflask.py-pyg.html-67"></a>
<a name="prflask.py-pyg.html-68"></a><span class="k">class</span> <span class="nc">QAView</span><span class="p">(</span><span class="n">AdminView</span><span class="p">):</span>
<a name="prflask.py-pyg.html-69"></a>	<span class="n">can_create</span> <span class="o">=</span> <span class="bp">False</span>
<a name="prflask.py-pyg.html-70"></a>	<span class="n">can_edit</span> <span class="o">=</span> <span class="bp">True</span>
<a name="prflask.py-pyg.html-71"></a>	<span class="n">column_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;request_id&#39;</span><span class="p">,</span> <span class="s">&#39;question&#39;</span><span class="p">,</span> <span class="s">&#39;answer&#39;</span><span class="p">,</span> <span class="s">&#39;date_created&#39;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-72"></a>	<span class="n">form_excluded_columns</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;date_created&#39;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-73"></a>
<a name="prflask.py-pyg.html-74"></a><span class="k">class</span> <span class="nc">NoteView</span><span class="p">(</span><span class="n">AdminView</span><span class="p">):</span>
<a name="prflask.py-pyg.html-75"></a>	<span class="n">can_create</span> <span class="o">=</span> <span class="bp">False</span>
<a name="prflask.py-pyg.html-76"></a>	<span class="n">can_edit</span> <span class="o">=</span> <span class="bp">True</span>
<a name="prflask.py-pyg.html-77"></a>	<span class="n">column_list</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;request_id&#39;</span><span class="p">,</span> <span class="s">&#39;text&#39;</span><span class="p">,</span> <span class="s">&#39;date_created&#39;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-78"></a>	<span class="n">form_excluded_columns</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;date_created&#39;</span><span class="p">)</span>
<a name="prflask.py-pyg.html-79"></a>
<a name="prflask.py-pyg.html-80"></a>
<a name="prflask.py-pyg.html-81"></a><span class="n">admin</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">RequestView</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">))</span>
<a name="prflask.py-pyg.html-82"></a><span class="n">admin</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">RecordView</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Record</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">))</span>
<a name="prflask.py-pyg.html-83"></a><span class="n">admin</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">NoteView</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Note</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">))</span>
<a name="prflask.py-pyg.html-84"></a><span class="n">admin</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">QAView</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">QA</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="p">))</span>
</pre></div>

</pre>

<a name="prr">Core public records requests functions</a> 
<p>prr.py</p>
<pre>
<div class="highlight"><pre><a name="prr.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-2"></a><span class="sd">    public_records_portal.prr</span>
<a name="prr.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="prr.py-pyg.html-4"></a>
<a name="prr.py-pyg.html-5"></a><span class="sd">    Implements functions specific to managing or creating a public records request.</span>
<a name="prr.py-pyg.html-6"></a>
<a name="prr.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-8"></a>
<a name="prr.py-pyg.html-9"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db_helpers</span>
<a name="prr.py-pyg.html-10"></a><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">json</span>
<a name="prr.py-pyg.html-11"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<a name="prr.py-pyg.html-12"></a><span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">current_user</span>
<a name="prr.py-pyg.html-13"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a name="prr.py-pyg.html-14"></a><span class="kn">from</span> <span class="nn">db_helpers</span> <span class="kn">import</span> <span class="n">find_request</span><span class="p">,</span> <span class="n">create_request</span><span class="p">,</span> <span class="n">get_obj</span><span class="p">,</span> <span class="n">add_staff_participant</span><span class="p">,</span> <span class="n">remove_staff_participant</span><span class="p">,</span> <span class="n">update_obj</span><span class="p">,</span> <span class="n">get_attribute</span><span class="p">,</span> <span class="n">change_request_status</span><span class="p">,</span> <span class="n">create_or_return_user</span><span class="p">,</span> <span class="n">create_subscriber</span><span class="p">,</span> <span class="n">create_record</span><span class="p">,</span> <span class="n">create_note</span><span class="p">,</span> <span class="n">create_QA</span><span class="p">,</span> <span class="n">create_answer</span>
<a name="prr.py-pyg.html-15"></a><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="o">*</span>
<a name="prr.py-pyg.html-16"></a><span class="kn">from</span> <span class="nn">ResponsePresenter</span> <span class="kn">import</span> <span class="n">ResponsePresenter</span>
<a name="prr.py-pyg.html-17"></a><span class="kn">from</span> <span class="nn">RequestPresenter</span> <span class="kn">import</span> <span class="n">RequestPresenter</span>
<a name="prr.py-pyg.html-18"></a><span class="kn">from</span> <span class="nn">notifications</span> <span class="kn">import</span> <span class="n">generate_prr_emails</span>
<a name="prr.py-pyg.html-19"></a><span class="kn">import</span> <span class="nn">scribd_helpers</span>
<a name="prr.py-pyg.html-20"></a><span class="kn">from</span> <span class="nn">spam</span> <span class="kn">import</span> <span class="n">is_spam</span>
<a name="prr.py-pyg.html-21"></a><span class="kn">import</span> <span class="nn">logging</span>
<a name="prr.py-pyg.html-22"></a><span class="kn">import</span> <span class="nn">csv</span>
<a name="prr.py-pyg.html-23"></a><span class="kn">import</span> <span class="nn">urllib</span>
<a name="prr.py-pyg.html-24"></a>
<a name="prr.py-pyg.html-25"></a><span class="c">### @export &quot;add_resource&quot;</span>
<a name="prr.py-pyg.html-26"></a><span class="k">def</span> <span class="nf">add_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request_body</span><span class="p">,</span> <span class="n">current_user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="prr.py-pyg.html-27"></a>	<span class="n">fields</span> <span class="o">=</span> <span class="n">request_body</span>
<a name="prr.py-pyg.html-28"></a>	<span class="k">if</span> <span class="s">&quot;extension&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-29"></a>		<span class="k">return</span> <span class="n">request_extension</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="n">fields</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">&#39;extend_reason&#39;</span><span class="p">),</span> <span class="n">current_user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-30"></a>	<span class="k">if</span> <span class="s">&quot;note&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-31"></a>		<span class="k">return</span> <span class="n">add_note</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="n">text</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;note_text&#39;</span><span class="p">],</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">current_user_id</span><span class="p">,</span> <span class="n">passed_spam_filter</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># Bypass spam filter because they are logged in.</span>
<a name="prr.py-pyg.html-32"></a>	<span class="k">elif</span> <span class="s">&quot;record&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-33"></a>		<span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;record_description&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="prr.py-pyg.html-34"></a>			<span class="k">return</span> <span class="s">&quot;When uploading a record, please fill out the &#39;summary&#39; field.&quot;</span>
<a name="prr.py-pyg.html-35"></a>		<span class="k">if</span> <span class="s">&#39;record_access&#39;</span> <span class="ow">in</span> <span class="n">fields</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;record_access&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="prr.py-pyg.html-36"></a>			<span class="k">return</span> <span class="n">add_offline_record</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;record_description&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;record_access&#39;</span><span class="p">],</span> <span class="n">current_user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-37"></a>		<span class="k">elif</span> <span class="s">&#39;link_url&#39;</span> <span class="ow">in</span> <span class="n">fields</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;link_url&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="prr.py-pyg.html-38"></a>			<span class="k">return</span> <span class="n">add_link</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="n">url</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;link_url&#39;</span><span class="p">],</span> <span class="n">description</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;record_description&#39;</span><span class="p">],</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">current_user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-39"></a>		<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-40"></a>			<span class="n">document</span> <span class="o">=</span> <span class="bp">None</span>
<a name="prr.py-pyg.html-41"></a>			<span class="k">try</span><span class="p">:</span>
<a name="prr.py-pyg.html-42"></a>				<span class="n">document</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&#39;record&#39;</span><span class="p">]</span>
<a name="prr.py-pyg.html-43"></a>			<span class="k">except</span><span class="p">:</span>
<a name="prr.py-pyg.html-44"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">No file passed in&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-45"></a>			<span class="k">return</span> <span class="n">upload_record</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="n">document</span> <span class="o">=</span> <span class="n">document</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;record_description&#39;</span><span class="p">],</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">current_user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-46"></a>	<span class="k">elif</span> <span class="s">&quot;qa&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-47"></a>		<span class="k">return</span> <span class="n">ask_a_question</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">current_user_id</span><span class="p">,</span> <span class="n">question</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;question_text&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-48"></a>	<span class="k">elif</span> <span class="s">&quot;owner&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-49"></a>		<span class="n">participant_id</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">],</span> <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;owner_email&#39;</span><span class="p">],</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;owner_reason&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-50"></a>		<span class="k">if</span> <span class="n">new</span><span class="p">:</span>
<a name="prr.py-pyg.html-51"></a>			<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">],</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;Staff participant added&quot;</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="s">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">participant_id</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;Owner&quot;</span><span class="p">))</span>
<a name="prr.py-pyg.html-52"></a>		<span class="k">return</span> <span class="n">participant_id</span>
<a name="prr.py-pyg.html-53"></a>	<span class="k">elif</span> <span class="s">&quot;subscriber&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-54"></a>		<span class="k">return</span> <span class="n">add_subscriber</span><span class="p">(</span><span class="n">request_id</span><span class="o">=</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">],</span> <span class="n">email</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;follow_email&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-55"></a>	<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-56"></a>		<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-57"></a>
<a name="prr.py-pyg.html-58"></a><span class="c">### @export &quot;update_resource&quot;</span>
<a name="prr.py-pyg.html-59"></a><span class="k">def</span> <span class="nf">update_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">request_body</span><span class="p">):</span>
<a name="prr.py-pyg.html-60"></a>	<span class="n">fields</span> <span class="o">=</span> <span class="n">request_body</span>
<a name="prr.py-pyg.html-61"></a>	<span class="k">if</span> <span class="s">&quot;owner&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-62"></a>		<span class="k">if</span> <span class="s">&quot;reason_unassigned&quot;</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
<a name="prr.py-pyg.html-63"></a>			<span class="k">return</span> <span class="n">remove_staff_participant</span><span class="p">(</span><span class="n">owner_id</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;owner_id&#39;</span><span class="p">],</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;reason_unassigned&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-64"></a>		<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-65"></a>			<span class="n">change_request_status</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="s">&quot;Rerouted&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-66"></a>			<span class="k">return</span> <span class="n">assign_owner</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;owner_reason&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;owner_email&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-67"></a>	<span class="k">elif</span> <span class="s">&quot;reopen&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-68"></a>		<span class="n">change_request_status</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]),</span> <span class="s">&quot;Reopened&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-69"></a>		<span class="k">return</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]</span>
<a name="prr.py-pyg.html-70"></a>	<span class="k">elif</span> <span class="s">&quot;request_text&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-71"></a>		<span class="n">update_obj</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;text&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_text&#39;</span><span class="p">],</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-72"></a>	<span class="k">elif</span> <span class="s">&quot;note_text&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-73"></a>		<span class="n">update_obj</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;text&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;note_text&#39;</span><span class="p">],</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;Note&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="s">&#39;response_id&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-74"></a>		<span class="c"># Need to store note text somewhere else (or just do delete here as well)</span>
<a name="prr.py-pyg.html-75"></a>	<span class="k">elif</span> <span class="s">&quot;note_delete&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-76"></a>		<span class="c"># Need to store note somewhere else</span>
<a name="prr.py-pyg.html-77"></a>		<span class="n">remove_obj</span><span class="p">(</span><span class="s">&quot;Note&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;response_id&#39;</span><span class="p">]))</span>
<a name="prr.py-pyg.html-78"></a>	<span class="k">elif</span> <span class="s">&quot;record_delete&quot;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="prr.py-pyg.html-79"></a>		<span class="n">remove_obj</span><span class="p">(</span><span class="s">&quot;Record&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;record_id&#39;</span><span class="p">]))</span>
<a name="prr.py-pyg.html-80"></a>		<span class="c"># Need to store record somewhere else and prompt them to delete from Scribd as well, if they&#39;d like</span>
<a name="prr.py-pyg.html-81"></a>	<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-82"></a>		<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-83"></a>
<a name="prr.py-pyg.html-84"></a><span class="c">### @export &quot;request_extension&quot;</span>
<a name="prr.py-pyg.html-85"></a><span class="k">def</span> <span class="nf">request_extension</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">extension_reasons</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a name="prr.py-pyg.html-86"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-87"></a>	<span class="n">req</span><span class="o">.</span><span class="n">extension</span><span class="p">()</span>
<a name="prr.py-pyg.html-88"></a>	<span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Request extended:&quot;</span>
<a name="prr.py-pyg.html-89"></a>	<span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">extension_reasons</span><span class="p">:</span>
<a name="prr.py-pyg.html-90"></a>		<span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="n">reason</span> <span class="o">+</span> <span class="s">&quot;&lt;/br&gt;&quot;</span>
<a name="prr.py-pyg.html-91"></a>	<span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-92"></a>	<span class="k">return</span> <span class="n">add_note</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">passed_spam_filter</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># Bypass spam filter because they are logged in.</span>
<a name="prr.py-pyg.html-93"></a>
<a name="prr.py-pyg.html-94"></a><span class="c">### @export &quot;add_note&quot;</span>
<a name="prr.py-pyg.html-95"></a><span class="k">def</span> <span class="nf">add_note</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">passed_spam_filter</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="prr.py-pyg.html-96"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">passed_spam_filter</span><span class="p">):</span>
<a name="prr.py-pyg.html-97"></a>		<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-98"></a>	<span class="n">note_id</span> <span class="o">=</span> <span class="n">create_note</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-99"></a>	<span class="k">if</span> <span class="n">note_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-100"></a>		<span class="n">change_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="s">&quot;A response has been added.&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-101"></a>		<span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-102"></a>			<span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-103"></a>			<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;City response added&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-104"></a>		<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-105"></a>			<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;Public note added&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-106"></a>		<span class="k">return</span> <span class="n">note_id</span>
<a name="prr.py-pyg.html-107"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-108"></a>
<a name="prr.py-pyg.html-109"></a>
<a name="prr.py-pyg.html-110"></a>
<a name="prr.py-pyg.html-111"></a><span class="c">### @export &quot;upload_record&quot;</span>
<a name="prr.py-pyg.html-112"></a><span class="k">def</span> <span class="nf">upload_record</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">document</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="prr.py-pyg.html-113"></a>	<span class="sd">&quot;&quot;&quot; Creates a record with upload/download attributes &quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-114"></a>	<span class="k">try</span><span class="p">:</span>
<a name="prr.py-pyg.html-115"></a>		<span class="n">doc_id</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">scribd_helpers</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">document</span> <span class="o">=</span> <span class="n">document</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-116"></a>	<span class="k">except</span><span class="p">:</span>
<a name="prr.py-pyg.html-117"></a>		<span class="k">return</span> <span class="s">&quot;The upload timed out, please try again.&quot;</span>
<a name="prr.py-pyg.html-118"></a>	<span class="k">if</span> <span class="n">doc_id</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
<a name="prr.py-pyg.html-119"></a>		<span class="k">return</span> <span class="s">&quot;Extension type &#39;</span><span class="si">%s</span><span class="s">&#39; is not allowed.&quot;</span> <span class="o">%</span> <span class="n">filename</span>
<a name="prr.py-pyg.html-120"></a>	<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-121"></a>		<span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
<a name="prr.py-pyg.html-122"></a>			<span class="n">record_id</span> <span class="o">=</span> <span class="n">create_record</span><span class="p">(</span><span class="n">doc_id</span> <span class="o">=</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;HOST_URL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">doc_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-123"></a>			<span class="n">change_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="s">&quot;A response has been added.&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-124"></a>			<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;City response added&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-125"></a>			<span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-126"></a>			<span class="k">return</span> <span class="n">record_id</span>
<a name="prr.py-pyg.html-127"></a>	<span class="k">return</span> <span class="s">&quot;There was an issue with your upload.&quot;</span>
<a name="prr.py-pyg.html-128"></a>
<a name="prr.py-pyg.html-129"></a><span class="c">### @export &quot;add_offline_record&quot;</span>
<a name="prr.py-pyg.html-130"></a><span class="k">def</span> <span class="nf">add_offline_record</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a name="prr.py-pyg.html-131"></a>	<span class="sd">&quot;&quot;&quot; Creates a record with offline attributes &quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-132"></a>	<span class="n">record_id</span> <span class="o">=</span> <span class="n">create_record</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="n">access</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">)</span> <span class="c"># To create an offline record, we need to know the request ID to which it will be added, the user ID for the person adding the record, how it can be accessed, and a description/title of the record.</span>
<a name="prr.py-pyg.html-133"></a>	<span class="k">if</span> <span class="n">record_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-134"></a>		<span class="n">change_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="s">&quot;A response has been added.&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-135"></a>		<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;City response added&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-136"></a>		<span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-137"></a>		<span class="k">return</span> <span class="n">record_id</span>
<a name="prr.py-pyg.html-138"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-139"></a>
<a name="prr.py-pyg.html-140"></a><span class="c">### @export &quot;add_link&quot;</span>
<a name="prr.py-pyg.html-141"></a><span class="k">def</span> <span class="nf">add_link</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a name="prr.py-pyg.html-142"></a>	<span class="sd">&quot;&quot;&quot; Creates a record with link attributes &quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-143"></a>	<span class="n">record_id</span> <span class="o">=</span> <span class="n">create_record</span><span class="p">(</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">)</span>
<a name="prr.py-pyg.html-144"></a>	<span class="k">if</span> <span class="n">record_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-145"></a>		<span class="n">change_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="s">&quot;A response has been added.&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-146"></a>		<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;City response added&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-147"></a>		<span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-148"></a>		<span class="k">return</span> <span class="n">record_id</span>
<a name="prr.py-pyg.html-149"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-150"></a>
<a name="prr.py-pyg.html-151"></a><span class="c">### @export &quot;make_request&quot;			</span>
<a name="prr.py-pyg.html-152"></a><span class="k">def</span> <span class="nf">make_request</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">passed_spam_filter</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">offline_submission_type</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">date_received</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="prr.py-pyg.html-153"></a>	<span class="sd">&quot;&quot;&quot; Make the request. At minimum you need to communicate which record(s) you want, probably with some text.&quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-154"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">passed_spam_filter</span><span class="p">:</span> 
<a name="prr.py-pyg.html-155"></a>		<span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-156"></a>	<span class="n">request_id</span> <span class="o">=</span> <span class="n">find_request</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a name="prr.py-pyg.html-157"></a>	<span class="k">if</span> <span class="n">request_id</span><span class="p">:</span> <span class="c"># Same request already exists</span>
<a name="prr.py-pyg.html-158"></a>		<span class="k">return</span> <span class="n">request_id</span><span class="p">,</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-159"></a>	<span class="n">assigned_to_email</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEFAULT_OWNER_EMAIL&#39;</span><span class="p">]</span>
<a name="prr.py-pyg.html-160"></a>	<span class="n">assigned_to_reason</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEFAULT_OWNER_REASON&#39;</span><span class="p">]</span>
<a name="prr.py-pyg.html-161"></a>	<span class="k">if</span> <span class="n">department</span><span class="p">:</span>
<a name="prr.py-pyg.html-162"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Department chosen: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="n">department</span><span class="p">)</span>
<a name="prr.py-pyg.html-163"></a>		<span class="n">prr_email</span> <span class="o">=</span> <span class="n">db_helpers</span><span class="o">.</span><span class="n">get_contact_by_dept</span><span class="p">(</span><span class="n">department</span><span class="p">)</span>
<a name="prr.py-pyg.html-164"></a>		<span class="k">if</span> <span class="n">prr_email</span><span class="p">:</span>
<a name="prr.py-pyg.html-165"></a>			<span class="n">assigned_to_email</span> <span class="o">=</span> <span class="n">prr_email</span>
<a name="prr.py-pyg.html-166"></a>			<span class="n">assigned_to_reason</span> <span class="o">=</span> <span class="s">&quot;PRR Liaison for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">department</span><span class="p">)</span>
<a name="prr.py-pyg.html-167"></a>		<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-168"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not a valid department&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">department</span><span class="p">))</span>
<a name="prr.py-pyg.html-169"></a>			<span class="n">department</span> <span class="o">=</span> <span class="bp">None</span>
<a name="prr.py-pyg.html-170"></a>	<span class="n">request_id</span> <span class="o">=</span> <span class="n">create_request</span><span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">offline_submission_type</span> <span class="o">=</span> <span class="n">offline_submission_type</span><span class="p">,</span> <span class="n">date_received</span> <span class="o">=</span> <span class="n">date_received</span><span class="p">)</span> <span class="c"># Actually create the Request object</span>
<a name="prr.py-pyg.html-171"></a>	<span class="n">new_owner_id</span> <span class="o">=</span> <span class="n">assign_owner</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">assigned_to_reason</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="n">assigned_to_email</span><span class="p">)</span> <span class="c"># Assign someone to the request</span>
<a name="prr.py-pyg.html-172"></a>	<span class="n">open_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span> <span class="c"># Set the status of the incoming request to &quot;Open&quot;</span>
<a name="prr.py-pyg.html-173"></a>	<span class="k">if</span> <span class="n">email</span> <span class="ow">or</span> <span class="n">alias</span> <span class="ow">or</span> <span class="n">phone</span><span class="p">:</span>
<a name="prr.py-pyg.html-174"></a>		<span class="n">subscriber_user_id</span> <span class="o">=</span> <span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="p">)</span>
<a name="prr.py-pyg.html-175"></a>		<span class="n">subscriber_id</span><span class="p">,</span> <span class="n">is_new_subscriber</span> <span class="o">=</span> <span class="n">create_subscriber</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">subscriber_user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-176"></a>		<span class="k">if</span> <span class="n">subscriber_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-177"></a>			<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;Request made&quot;</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">subscriber_user_id</span><span class="p">)</span> <span class="c"># Send them an e-mail notification</span>
<a name="prr.py-pyg.html-178"></a>	<span class="k">return</span> <span class="n">request_id</span><span class="p">,</span> <span class="bp">True</span>
<a name="prr.py-pyg.html-179"></a>
<a name="prr.py-pyg.html-180"></a><span class="c">### @export &quot;add_subscriber&quot;	</span>
<a name="prr.py-pyg.html-181"></a><span class="k">def</span> <span class="nf">add_subscriber</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a name="prr.py-pyg.html-182"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">)</span>
<a name="prr.py-pyg.html-183"></a>	<span class="n">subscriber_id</span><span class="p">,</span> <span class="n">is_new_subscriber</span> <span class="o">=</span> <span class="n">create_subscriber</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-184"></a>	<span class="k">if</span> <span class="n">subscriber_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-185"></a>		<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;Request followed&quot;</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-186"></a>		<span class="k">return</span> <span class="n">subscriber_id</span>
<a name="prr.py-pyg.html-187"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-188"></a>
<a name="prr.py-pyg.html-189"></a><span class="c">### @export &quot;ask_a_question&quot;	</span>
<a name="prr.py-pyg.html-190"></a><span class="k">def</span> <span class="nf">ask_a_question</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">question</span><span class="p">):</span>
<a name="prr.py-pyg.html-191"></a>	<span class="sd">&quot;&quot;&quot; City staff can ask a question about a request they are confused about.&quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-192"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-193"></a>	<span class="n">qa_id</span> <span class="o">=</span> <span class="n">create_QA</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">question</span> <span class="o">=</span> <span class="n">question</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-194"></a>	<span class="k">if</span> <span class="n">qa_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-195"></a>		<span class="n">change_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="s">&quot;Pending&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-196"></a>		<span class="n">requester</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">requester</span><span class="p">()</span>
<a name="prr.py-pyg.html-197"></a>		<span class="k">if</span> <span class="n">requester</span><span class="p">:</span>
<a name="prr.py-pyg.html-198"></a>			<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;Question asked&quot;</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">requester</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-199"></a>		<span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-200"></a>		<span class="k">return</span> <span class="n">qa_id</span>
<a name="prr.py-pyg.html-201"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-202"></a>
<a name="prr.py-pyg.html-203"></a><span class="c">### @export &quot;answer_a_question&quot;</span>
<a name="prr.py-pyg.html-204"></a><span class="k">def</span> <span class="nf">answer_a_question</span><span class="p">(</span><span class="n">qa_id</span><span class="p">,</span> <span class="n">answer</span><span class="p">,</span> <span class="n">subscriber_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">passed_spam_filter</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="prr.py-pyg.html-205"></a>	<span class="sd">&quot;&quot;&quot; A requester can answer a question city staff asked them about their request.&quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-206"></a>	<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">answer</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">answer</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">passed_spam_filter</span><span class="p">):</span>
<a name="prr.py-pyg.html-207"></a>		<span class="k">return</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-208"></a>	<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-209"></a>		<span class="n">request_id</span> <span class="o">=</span> <span class="n">create_answer</span><span class="p">(</span><span class="n">qa_id</span><span class="p">,</span> <span class="n">subscriber_id</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
<a name="prr.py-pyg.html-210"></a>		<span class="c"># We aren&#39;t changing the request status if someone&#39;s answered a question anymore, but we could change_request_status(request_id, &quot;Pending&quot;)</span>
<a name="prr.py-pyg.html-211"></a>		<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;Question answered&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-212"></a>		<span class="k">return</span> <span class="bp">True</span>
<a name="prr.py-pyg.html-213"></a>
<a name="prr.py-pyg.html-214"></a><span class="c">### @export &quot;open_request&quot;	</span>
<a name="prr.py-pyg.html-215"></a><span class="k">def</span> <span class="nf">open_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
<a name="prr.py-pyg.html-216"></a>	<span class="n">change_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="s">&quot;Open&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-217"></a>
<a name="prr.py-pyg.html-218"></a><span class="c">### @export &quot;assign_owner&quot;	</span>
<a name="prr.py-pyg.html-219"></a><span class="k">def</span> <span class="nf">assign_owner</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span> 
<a name="prr.py-pyg.html-220"></a>	<span class="sd">&quot;&quot;&quot; Called any time a new owner is assigned. This will overwrite the current owner.&quot;&quot;&quot;</span>
<a name="prr.py-pyg.html-221"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-222"></a>	<span class="n">past_owner_id</span> <span class="o">=</span> <span class="bp">None</span>
<a name="prr.py-pyg.html-223"></a>	<span class="c"># If there is already an owner, unassign them:</span>
<a name="prr.py-pyg.html-224"></a>	<span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">point_person</span><span class="p">():</span>
<a name="prr.py-pyg.html-225"></a>		<span class="n">past_owner_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">point_person</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
<a name="prr.py-pyg.html-226"></a>		<span class="n">past_owner</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Owner&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">point_person</span><span class="p">()</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="prr.py-pyg.html-227"></a>		<span class="n">update_obj</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;is_point_person&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">past_owner</span><span class="p">)</span>
<a name="prr.py-pyg.html-228"></a>	<span class="n">owner_id</span><span class="p">,</span> <span class="n">is_new_owner</span> <span class="o">=</span> <span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">,</span> <span class="n">is_point_person</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prr.py-pyg.html-229"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">past_owner_id</span> <span class="o">==</span> <span class="n">owner_id</span><span class="p">):</span> <span class="c"># Already the current owner, so don&#39;t send any e-mails</span>
<a name="prr.py-pyg.html-230"></a>		<span class="k">return</span> <span class="n">owner_id</span>
<a name="prr.py-pyg.html-231"></a>
<a name="prr.py-pyg.html-232"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">A new owner has been assigned: Owner: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">owner_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-233"></a>	<span class="n">new_owner</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Owner&quot;</span><span class="p">,</span> <span class="n">owner_id</span><span class="p">)</span>	
<a name="prr.py-pyg.html-234"></a>	<span class="c"># Update the associated department on request</span>
<a name="prr.py-pyg.html-235"></a>	<span class="n">update_obj</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;department_id&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">new_owner</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">department</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">req</span><span class="p">)</span>
<a name="prr.py-pyg.html-236"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">owner_id</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;Owner&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-237"></a>	<span class="c"># Send notifications</span>
<a name="prr.py-pyg.html-238"></a>	<span class="k">if</span> <span class="n">is_new_owner</span><span class="p">:</span>
<a name="prr.py-pyg.html-239"></a>		<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;Request assigned&quot;</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-240"></a>	<span class="k">return</span> <span class="n">owner_id</span>
<a name="prr.py-pyg.html-241"></a>
<a name="prr.py-pyg.html-242"></a><span class="c">### @export &quot;get_request_data_chronologically&quot;</span>
<a name="prr.py-pyg.html-243"></a><span class="k">def</span> <span class="nf">get_request_data_chronologically</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
<a name="prr.py-pyg.html-244"></a>	<span class="n">public</span> <span class="o">=</span> <span class="bp">False</span>
<a name="prr.py-pyg.html-245"></a>	<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">():</span>
<a name="prr.py-pyg.html-246"></a>		<span class="n">public</span> <span class="o">=</span> <span class="bp">True</span>
<a name="prr.py-pyg.html-247"></a>	<span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
<a name="prr.py-pyg.html-248"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="p">:</span>
<a name="prr.py-pyg.html-249"></a>		<span class="k">return</span> <span class="n">responses</span>
<a name="prr.py-pyg.html-250"></a>	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">note</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">notes</span><span class="p">):</span>
<a name="prr.py-pyg.html-251"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">note</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-252"></a>			<span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RequestPresenter</span><span class="p">(</span><span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">public</span> <span class="o">=</span> <span class="n">public</span><span class="p">,</span> <span class="n">request</span> <span class="o">=</span> <span class="n">req</span><span class="p">))</span>
<a name="prr.py-pyg.html-253"></a>	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">qa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">qas</span><span class="p">):</span>
<a name="prr.py-pyg.html-254"></a>		<span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RequestPresenter</span><span class="p">(</span><span class="n">qa</span> <span class="o">=</span> <span class="n">qa</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">public</span> <span class="o">=</span> <span class="n">public</span><span class="p">,</span> <span class="n">request</span> <span class="o">=</span> <span class="n">req</span><span class="p">))</span>
<a name="prr.py-pyg.html-255"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">responses</span><span class="p">:</span>
<a name="prr.py-pyg.html-256"></a>		<span class="k">return</span> <span class="n">responses</span>
<a name="prr.py-pyg.html-257"></a>	<span class="n">responses</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prr.py-pyg.html-258"></a>	<span class="k">return</span> <span class="n">responses</span>
<a name="prr.py-pyg.html-259"></a>
<a name="prr.py-pyg.html-260"></a><span class="c">### @export &quot;get_responses_chronologically&quot;</span>
<a name="prr.py-pyg.html-261"></a><span class="k">def</span> <span class="nf">get_responses_chronologically</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
<a name="prr.py-pyg.html-262"></a>	<span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
<a name="prr.py-pyg.html-263"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="p">:</span>
<a name="prr.py-pyg.html-264"></a>		<span class="k">return</span> <span class="n">responses</span>
<a name="prr.py-pyg.html-265"></a>	<span class="k">for</span> <span class="n">note</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">notes</span><span class="p">:</span>
<a name="prr.py-pyg.html-266"></a>		<span class="k">if</span> <span class="n">note</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
<a name="prr.py-pyg.html-267"></a>			<span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ResponsePresenter</span><span class="p">(</span><span class="n">note</span> <span class="o">=</span> <span class="n">note</span><span class="p">))</span>
<a name="prr.py-pyg.html-268"></a>	<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
<a name="prr.py-pyg.html-269"></a>		<span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ResponsePresenter</span><span class="p">(</span><span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="p">))</span>
<a name="prr.py-pyg.html-270"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">responses</span><span class="p">:</span>
<a name="prr.py-pyg.html-271"></a>		<span class="k">return</span> <span class="n">responses</span>
<a name="prr.py-pyg.html-272"></a>	<span class="n">responses</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">date</span><span class="p">(),</span> <span class="n">reverse</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prr.py-pyg.html-273"></a>	<span class="k">if</span> <span class="s">&quot;Closed&quot;</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a name="prr.py-pyg.html-274"></a>		<span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_icon</span><span class="p">(</span><span class="s">&quot;icon-archive&quot;</span><span class="p">)</span> <span class="c"># Set most recent note (closed note)&#39;s icon</span>
<a name="prr.py-pyg.html-275"></a>	<span class="k">return</span> <span class="n">responses</span>
<a name="prr.py-pyg.html-276"></a>
<a name="prr.py-pyg.html-277"></a><span class="c">### @export &quot;set_directory_fields&quot;</span>
<a name="prr.py-pyg.html-278"></a><span class="k">def</span> <span class="nf">set_directory_fields</span><span class="p">():</span>
<a name="prr.py-pyg.html-279"></a>	<span class="c"># Set basic user data</span>
<a name="prr.py-pyg.html-280"></a>	<span class="k">if</span> <span class="s">&#39;STAFF_URL&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="prr.py-pyg.html-281"></a>		<span class="c"># This gets run at regular internals via db_users.py in order to keep the staff user list up to date. Before users are added/updated, ALL users get reset to &#39;inactive&#39;, and then only the ones in the current CSV are set to active. </span>
<a name="prr.py-pyg.html-282"></a>		<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<a name="prr.py-pyg.html-283"></a>			<span class="n">update_user</span><span class="p">(</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<a name="prr.py-pyg.html-284"></a>		<span class="n">csvfile</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;STAFF_URL&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-285"></a>		<span class="n">dictreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
<a name="prr.py-pyg.html-286"></a>		<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dictreader</span><span class="p">:</span>
<a name="prr.py-pyg.html-287"></a>			<span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;phone number&#39;</span><span class="p">],</span> <span class="n">department</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;department name&#39;</span><span class="p">],</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prr.py-pyg.html-288"></a>		<span class="c"># Set liaisons data (who is a PRR liaison for what department)</span>
<a name="prr.py-pyg.html-289"></a>		<span class="k">if</span> <span class="s">&#39;LIAISONS_URL&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="prr.py-pyg.html-290"></a>			<span class="n">csvfile</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;LIAISONS_URL&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-291"></a>			<span class="n">dictreader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
<a name="prr.py-pyg.html-292"></a>			<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dictreader</span><span class="p">:</span>
<a name="prr.py-pyg.html-293"></a>				<span class="n">user</span> <span class="o">=</span> <span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;PRR liaison&#39;</span><span class="p">],</span> <span class="n">contact_for</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;department name&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-294"></a>				<span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;PRR backup&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="prr.py-pyg.html-295"></a>					<span class="n">user</span> <span class="o">=</span> <span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;PRR backup&#39;</span><span class="p">],</span> <span class="n">backup_for</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s">&#39;department name&#39;</span><span class="p">])</span>
<a name="prr.py-pyg.html-296"></a>		<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-297"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Please update the config variable LIAISONS_URL for where to find department liaison data for your agency.&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-298"></a>	<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-299"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Please update the config variable STAFF_URL for where to find csv data on the users in your agency.&quot;</span><span class="p">)</span> 
<a name="prr.py-pyg.html-300"></a>		<span class="k">if</span> <span class="s">&#39;DEFAULT_OWNER_EMAIL&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="s">&#39;DEFAULT_OWNER_REASON&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="prr.py-pyg.html-301"></a>			<span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEFAULT_OWNER_EMAIL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEFAULT_OWNER_EMAIL&#39;</span><span class="p">],</span> <span class="n">department</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEFAULT_OWNER_REASON&#39;</span><span class="p">],</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="prr.py-pyg.html-302"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Creating a single user from DEFAULT_OWNER_EMAIL and DEFAULT_OWNER_REASON for now. You may log in with </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DEFAULT_OWNER_EMAIL&#39;</span><span class="p">]))</span>
<a name="prr.py-pyg.html-303"></a>		<span class="k">else</span><span class="p">:</span>
<a name="prr.py-pyg.html-304"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Unable to create any users. No one will be able to log in.&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-305"></a>
<a name="prr.py-pyg.html-306"></a>
<a name="prr.py-pyg.html-307"></a>
<a name="prr.py-pyg.html-308"></a><span class="c">### @export &quot;close_request&quot;</span>
<a name="prr.py-pyg.html-309"></a><span class="k">def</span> <span class="nf">close_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="prr.py-pyg.html-310"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-311"></a>	<span class="n">change_request_status</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="s">&quot;Closed&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-312"></a>	<span class="c"># Create a note to capture closed information:</span>
<a name="prr.py-pyg.html-313"></a>	<span class="n">create_note</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<a name="prr.py-pyg.html-314"></a>	<span class="n">generate_prr_emails</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">notification_type</span> <span class="o">=</span> <span class="s">&quot;Request closed&quot;</span><span class="p">)</span>
<a name="prr.py-pyg.html-315"></a>	<span class="n">add_staff_participant</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
</pre></div>

</pre>

<a name="RequestPresenter">The 'Request' view</a> 
<p>RequestPresenter.py</p>
<pre>
<div class="highlight"><pre><a name="RequestPresenter.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="RequestPresenter.py-pyg.html-2"></a><span class="sd">    public_records_portal.RequestPresenter</span>
<a name="RequestPresenter.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="RequestPresenter.py-pyg.html-4"></a>
<a name="RequestPresenter.py-pyg.html-5"></a><span class="sd">    Returns the html needed for the &#39;Request&#39; portion of the case page.</span>
<a name="RequestPresenter.py-pyg.html-6"></a>
<a name="RequestPresenter.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="RequestPresenter.py-pyg.html-8"></a>
<a name="RequestPresenter.py-pyg.html-9"></a>
<a name="RequestPresenter.py-pyg.html-10"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">models</span>
<a name="RequestPresenter.py-pyg.html-11"></a><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Note</span><span class="p">,</span> <span class="n">QA</span>
<a name="RequestPresenter.py-pyg.html-12"></a><span class="kn">from</span> <span class="nn">db_helpers</span> <span class="kn">import</span> <span class="n">get_obj</span>
<a name="RequestPresenter.py-pyg.html-13"></a>
<a name="RequestPresenter.py-pyg.html-14"></a><span class="k">class</span> <span class="nc">RequestPresenter</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-15"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">qa</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">note</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">public</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="RequestPresenter.py-pyg.html-16"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
<a name="RequestPresenter.py-pyg.html-17"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">public</span> <span class="o">=</span> <span class="n">public</span>
<a name="RequestPresenter.py-pyg.html-18"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
<a name="RequestPresenter.py-pyg.html-19"></a>		<span class="k">if</span> <span class="n">qa</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-20"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">qa</span>
<a name="RequestPresenter.py-pyg.html-21"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;qa&quot;</span>
<a name="RequestPresenter.py-pyg.html-22"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">owner_id</span>
<a name="RequestPresenter.py-pyg.html-23"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">staff</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;User&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
<a name="RequestPresenter.py-pyg.html-24"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">staff_email</span> <span class="o">=</span> <span class="s">&quot;N/A&quot;</span>
<a name="RequestPresenter.py-pyg.html-25"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">staff_department</span> <span class="o">=</span> <span class="s">&quot;N/A&quot;</span>
<a name="RequestPresenter.py-pyg.html-26"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">staff_phone</span> <span class="o">=</span> <span class="s">&quot;N/A&quot;</span>
<a name="RequestPresenter.py-pyg.html-27"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">staff_alias</span> <span class="o">=</span> <span class="s">&quot;N/A&quot;</span>
<a name="RequestPresenter.py-pyg.html-28"></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-29"></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-30"></a>					<span class="bp">self</span><span class="o">.</span><span class="n">staff_email</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="o">.</span><span class="n">email</span>
<a name="RequestPresenter.py-pyg.html-31"></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="o">.</span><span class="n">department</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-32"></a>					<span class="bp">self</span><span class="o">.</span><span class="n">staff_department</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="o">.</span><span class="n">department</span>
<a name="RequestPresenter.py-pyg.html-33"></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="o">.</span><span class="n">phone</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-34"></a>					<span class="bp">self</span><span class="o">.</span><span class="n">staff_phone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="o">.</span><span class="n">phone</span>
<a name="RequestPresenter.py-pyg.html-35"></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="o">.</span><span class="n">alias</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-36"></a>					<span class="bp">self</span><span class="o">.</span><span class="n">staff_alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff</span><span class="o">.</span><span class="n">alias</span>
<a name="RequestPresenter.py-pyg.html-37"></a>			<span class="n">directory_popover</span> <span class="o">=</span> <span class="s">&quot;directoryPopover(&#39;</span><span class="si">%s</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;, &#39;#contactinfoPopoverQA</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">staff_email</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff_department</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff_phone</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
<a name="RequestPresenter.py-pyg.html-38"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">owner_link</span> <span class="o">=</span> <span class="s">&#39;&lt;a href=&quot;/staff_card/</span><span class="si">%s</span><span class="s">&quot; data-placement=&quot;top&quot; data-toggle=&quot;popover&quot; href=&quot;#&quot; id=&quot;contactinfoPopoverQA</span><span class="si">%s</span><span class="s">&quot; class=&quot;hidden-phone hidden-tablet&quot;&gt;&lt;span class=&quot;contactinfoPopover&quot; onmouseover=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/span&gt;&lt;/a&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">owner_id</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">directory_popover</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff_alias</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">staff_email</span><span class="p">)</span>
<a name="RequestPresenter.py-pyg.html-39"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="s">&quot;icon-question icon-large&quot;</span>
<a name="RequestPresenter.py-pyg.html-40"></a>		<span class="k">if</span> <span class="n">note</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-41"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">note</span>
<a name="RequestPresenter.py-pyg.html-42"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;note&quot;</span>
<a name="RequestPresenter.py-pyg.html-43"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="s">&quot;icon-edit icon-large&quot;</span>
<a name="RequestPresenter.py-pyg.html-44"></a>	
<a name="RequestPresenter.py-pyg.html-45"></a>	<span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="RequestPresenter.py-pyg.html-46"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">id</span>
<a name="RequestPresenter.py-pyg.html-47"></a>
<a name="RequestPresenter.py-pyg.html-48"></a>	<span class="k">def</span> <span class="nf">display_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="RequestPresenter.py-pyg.html-49"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;qa&quot;</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-50"></a>			<span class="n">text</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_link</span><span class="p">)</span>
<a name="RequestPresenter.py-pyg.html-51"></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-52"></a>				<span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="s">&quot;&lt;p&gt;</span><span class="si">%s</span><span class="s"> - &lt;span class=&#39;requester&#39;&gt;Requester&lt;/span&gt;&lt;/p&gt;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
<a name="RequestPresenter.py-pyg.html-53"></a>			<span class="k">else</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-54"></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
<a name="RequestPresenter.py-pyg.html-55"></a>					<span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="s">&quot;&lt;i&gt;&lt;p&gt;No response from requester&lt;/p&gt;&lt;/i&gt;&quot;</span>
<a name="RequestPresenter.py-pyg.html-56"></a>				<span class="k">else</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-57"></a>					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">public</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-58"></a>						<span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="s">&quot;&quot;&quot;</span>
<a name="RequestPresenter.py-pyg.html-59"></a><span class="s">						&lt;form name=&#39;respond_question&#39; class=&#39;form-inline&#39; id=&#39;answer&#39; method=&#39;post&#39; action=&#39;/update_a_qa&#39; autocomplete=&#39;on&#39;&gt;</span>
<a name="RequestPresenter.py-pyg.html-60"></a><span class="s">							&lt;label class=&#39;control-label&#39;&gt;Answer&lt;/label&gt;&lt;input type=&#39;hidden&#39; name=&#39;qa_id&#39; value=&#39;</span><span class="si">%s</span><span class="s">&#39;/&gt;&lt;input type=&#39;hidden&#39; name=&#39;request_id&#39; value=&#39;</span><span class="si">%s</span><span class="s">&#39;/&gt;</span>
<a name="RequestPresenter.py-pyg.html-61"></a><span class="s">							&lt;textarea id=&#39;answerTextarea&#39; name=&#39;answer_text&#39; class=&#39;input-xlarge&#39; rows=&quot;2&quot; type=&#39;text&#39; rows=&#39;1&#39; placeholder=&#39;Can you respond to the above question?&#39; required/&gt;&lt;/textarea&gt;</span>
<a name="RequestPresenter.py-pyg.html-62"></a><span class="s">							&lt;button id=&#39;askQuestion&#39; class=&#39;btn btn-primary&#39; type=&#39;submit&#39;&gt;Respond&lt;/button&gt;</span>
<a name="RequestPresenter.py-pyg.html-63"></a><span class="s">						&lt;/form&gt; </span>
<a name="RequestPresenter.py-pyg.html-64"></a><span class="s">						&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="RequestPresenter.py-pyg.html-65"></a>					<span class="k">else</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-66"></a>						<span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">+</span> <span class="s">&quot;&lt;p&gt;Requester hasn&#39;t answered yet.&lt;/p&gt;&quot;</span>
<a name="RequestPresenter.py-pyg.html-67"></a>			<span class="k">return</span> <span class="n">text</span>
<a name="RequestPresenter.py-pyg.html-68"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;note&quot;</span><span class="p">:</span>
<a name="RequestPresenter.py-pyg.html-69"></a>			<span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> - Requester&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<a name="RequestPresenter.py-pyg.html-70"></a>		
<a name="RequestPresenter.py-pyg.html-71"></a>	<span class="k">def</span> <span class="nf">get_icon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="RequestPresenter.py-pyg.html-72"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon</span>
<a name="RequestPresenter.py-pyg.html-73"></a>
<a name="RequestPresenter.py-pyg.html-74"></a>	<span class="k">def</span> <span class="nf">set_icon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">icon</span><span class="p">):</span>
<a name="RequestPresenter.py-pyg.html-75"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="n">icon</span>
<a name="RequestPresenter.py-pyg.html-76"></a>
<a name="RequestPresenter.py-pyg.html-77"></a>	<span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="RequestPresenter.py-pyg.html-78"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">date_created</span>
</pre></div>

</pre>


<a name="ResponsePresenter">The 'Response' view</a> 
<p>ResponsePresenter.py</p>
<pre>
<div class="highlight"><pre><a name="ResponsePresenter.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="ResponsePresenter.py-pyg.html-2"></a><span class="sd">    public_records_portal.RequestPresenter</span>
<a name="ResponsePresenter.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="ResponsePresenter.py-pyg.html-4"></a>
<a name="ResponsePresenter.py-pyg.html-5"></a><span class="sd">    Returns the html needed for the &#39;Response&#39; portion of the case page.</span>
<a name="ResponsePresenter.py-pyg.html-6"></a>
<a name="ResponsePresenter.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="ResponsePresenter.py-pyg.html-8"></a>
<a name="ResponsePresenter.py-pyg.html-9"></a>
<a name="ResponsePresenter.py-pyg.html-10"></a>
<a name="ResponsePresenter.py-pyg.html-11"></a><span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Record</span><span class="p">,</span> <span class="n">Note</span>
<a name="ResponsePresenter.py-pyg.html-12"></a><span class="kn">import</span> <span class="nn">scribd_helpers</span>
<a name="ResponsePresenter.py-pyg.html-13"></a>
<a name="ResponsePresenter.py-pyg.html-14"></a><span class="k">class</span> <span class="nc">ResponsePresenter</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-15"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">note</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-16"></a>		<span class="k">if</span> <span class="n">record</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-17"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">record</span>
<a name="ResponsePresenter.py-pyg.html-18"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">update_url</span> <span class="o">=</span> <span class="s">&quot;update_a_record_delete&quot;</span>
<a name="ResponsePresenter.py-pyg.html-19"></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">access</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-20"></a>				<span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;offline&quot;</span>
<a name="ResponsePresenter.py-pyg.html-21"></a>			<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">doc_id</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-22"></a>				<span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;document&quot;</span>
<a name="ResponsePresenter.py-pyg.html-23"></a>			<span class="k">else</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-24"></a>				<span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;link&quot;</span>
<a name="ResponsePresenter.py-pyg.html-25"></a>		<span class="k">if</span> <span class="n">note</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-26"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">note</span>
<a name="ResponsePresenter.py-pyg.html-27"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">update_url</span> <span class="o">=</span> <span class="s">&quot;update_a_note_delete&quot;</span>
<a name="ResponsePresenter.py-pyg.html-28"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;note&quot;</span>
<a name="ResponsePresenter.py-pyg.html-29"></a>			<span class="k">if</span> <span class="s">&quot;Request extended:&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-30"></a>				<span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;extension&quot;</span>
<a name="ResponsePresenter.py-pyg.html-31"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s">&quot;offline&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-32"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="s">&quot;icon-file-alt icon-large&quot;</span>
<a name="ResponsePresenter.py-pyg.html-33"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s">&quot;note&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-34"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="s">&quot;icon-edit icon-large&quot;</span>
<a name="ResponsePresenter.py-pyg.html-35"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s">&quot;link&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-36"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="s">&quot;icon-link icon-large&quot;</span>
<a name="ResponsePresenter.py-pyg.html-37"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span><span class="s">&quot;document&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-38"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="s">&quot;icon-file-alt icon-large&quot;</span>
<a name="ResponsePresenter.py-pyg.html-39"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">==</span><span class="s">&quot;extension&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-40"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="s">&quot;icon-calendar icon-large&quot;</span>
<a name="ResponsePresenter.py-pyg.html-41"></a>
<a name="ResponsePresenter.py-pyg.html-42"></a>	
<a name="ResponsePresenter.py-pyg.html-43"></a>	<span class="k">def</span> <span class="nf">get_update_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-44"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_url</span>
<a name="ResponsePresenter.py-pyg.html-45"></a>
<a name="ResponsePresenter.py-pyg.html-46"></a>	<span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-47"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">id</span>
<a name="ResponsePresenter.py-pyg.html-48"></a>
<a name="ResponsePresenter.py-pyg.html-49"></a>	<span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-50"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">user_id</span>
<a name="ResponsePresenter.py-pyg.html-51"></a>
<a name="ResponsePresenter.py-pyg.html-52"></a>	<span class="k">def</span> <span class="nf">staff_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-53"></a>		<span class="k">return</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;alias&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;User&quot;</span><span class="p">)</span>
<a name="ResponsePresenter.py-pyg.html-54"></a>
<a name="ResponsePresenter.py-pyg.html-55"></a>	<span class="k">def</span> <span class="nf">staff_dept</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-56"></a>		<span class="k">return</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;department&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;User&quot;</span><span class="p">)</span>
<a name="ResponsePresenter.py-pyg.html-57"></a>
<a name="ResponsePresenter.py-pyg.html-58"></a>	<span class="k">def</span> <span class="nf">staff_phone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-59"></a>		<span class="k">return</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;phone&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;User&quot;</span><span class="p">)</span>
<a name="ResponsePresenter.py-pyg.html-60"></a>
<a name="ResponsePresenter.py-pyg.html-61"></a>	<span class="k">def</span> <span class="nf">staff_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-62"></a>		<span class="k">return</span> <span class="n">get_attribute</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;email&quot;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&quot;User&quot;</span><span class="p">)</span>
<a name="ResponsePresenter.py-pyg.html-63"></a>
<a name="ResponsePresenter.py-pyg.html-64"></a>	<span class="k">def</span> <span class="nf">display_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-65"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;offline&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-66"></a>			<span class="k">return</span> <span class="s">&quot;Name of Record: </span><span class="si">%s</span><span class="s">&lt;br&gt; How to Access Record: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">access</span><span class="p">)</span>
<a name="ResponsePresenter.py-pyg.html-67"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;document&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-68"></a>			<span class="n">download_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">download_url</span>
<a name="ResponsePresenter.py-pyg.html-69"></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">download_url</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-70"></a>				<span class="n">download_url</span> <span class="o">=</span> <span class="n">scribd_helpers</span><span class="o">.</span><span class="n">get_scribd_download_url</span><span class="p">(</span><span class="n">doc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">record_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="ResponsePresenter.py-pyg.html-71"></a>				<span class="k">if</span> <span class="ow">not</span> <span class="n">download_url</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-72"></a>					<span class="n">download_url</span> <span class="o">=</span> <span class="s">&quot;This document is still being uploaded, but it will be available shortly.&quot;</span>
<a name="ResponsePresenter.py-pyg.html-73"></a>			<span class="k">return</span> <span class="s">&quot;&quot;&quot;</span>
<a name="ResponsePresenter.py-pyg.html-74"></a><span class="s">			&lt;a href=&#39;</span><span class="si">%(download_url)s</span><span class="s">&#39; rel=&#39;tooltip&#39; data-toggle=&#39;tooltip&#39; data-placement=&#39;top&#39; data-original-title=&#39;</span><span class="si">%(download_url)s</span><span class="s">&#39; target=&#39;_blank&#39;&gt;&lt;b&gt;</span><span class="si">%(description)s</span><span class="s"> &lt;/b&gt;&lt;/a&gt;</span>
<a name="ResponsePresenter.py-pyg.html-75"></a><span class="s">			&lt;a href = &#39;</span><span class="si">%(scribd_url)s</span><span class="s">&#39; rel=&#39;tooltip&#39; data-toggle=&#39;tooltip&#39; data-placement=&#39;top&#39; data-original-title=&#39;View document on Scribd hosting service&#39; target=&#39;_blank&#39;&gt;&lt;small&gt;&lt;i class=&#39;icon-external-link&#39;&gt; &lt;/i&gt;&lt;/small&gt;&lt;/a&gt;</span>
<a name="ResponsePresenter.py-pyg.html-76"></a><span class="s">			&quot;&quot;&quot;</span> <span class="o">%</span><span class="p">{</span><span class="s">&quot;download_url&quot;</span><span class="p">:</span> <span class="n">download_url</span><span class="p">,</span> <span class="s">&quot;description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="s">&quot;scribd_url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">}</span> 
<a name="ResponsePresenter.py-pyg.html-77"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;note&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-78"></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span>
<a name="ResponsePresenter.py-pyg.html-79"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;link&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-80"></a>			<span class="k">return</span> <span class="s">&quot;&lt;a href=&#39;</span><span class="si">%s</span><span class="s">&#39; rel=&#39;tooltip&#39; data-toggle=&#39;tooltip&#39; data-placement=&#39;top&#39; data-original-title=&#39;</span><span class="si">%s</span><span class="s">&#39;&gt;</span><span class="si">%s</span><span class="s"> &lt;/a&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
<a name="ResponsePresenter.py-pyg.html-81"></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s">&quot;extension&quot;</span><span class="p">:</span>
<a name="ResponsePresenter.py-pyg.html-82"></a>			<span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;Request extended:&quot;</span><span class="p">)</span>
<a name="ResponsePresenter.py-pyg.html-83"></a>			<span class="k">return</span> <span class="n">text</span>
<a name="ResponsePresenter.py-pyg.html-84"></a>
<a name="ResponsePresenter.py-pyg.html-85"></a>	<span class="k">def</span> <span class="nf">get_icon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-86"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">icon</span>
<a name="ResponsePresenter.py-pyg.html-87"></a>
<a name="ResponsePresenter.py-pyg.html-88"></a>	<span class="k">def</span> <span class="nf">set_icon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">icon</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-89"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">icon</span> <span class="o">=</span> <span class="n">icon</span>
<a name="ResponsePresenter.py-pyg.html-90"></a>
<a name="ResponsePresenter.py-pyg.html-91"></a>	<span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="ResponsePresenter.py-pyg.html-92"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">date_created</span>
</pre></div>

</pre>

<a name="scribd_helpers">Scribd API helpers</a> 
<p>scribd_helpers.py</p>
<pre>
<div class="highlight"><pre><a name="scribd_helpers.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="scribd_helpers.py-pyg.html-2"></a><span class="sd">    public_records_portal.scribd_helpers</span>
<a name="scribd_helpers.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="scribd_helpers.py-pyg.html-4"></a>
<a name="scribd_helpers.py-pyg.html-5"></a><span class="sd">    Implements functions to interact with Scribd API for RecordTrac</span>
<a name="scribd_helpers.py-pyg.html-6"></a>
<a name="scribd_helpers.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="scribd_helpers.py-pyg.html-8"></a>
<a name="scribd_helpers.py-pyg.html-9"></a>
<a name="scribd_helpers.py-pyg.html-10"></a><span class="kn">import</span> <span class="nn">scribd</span>
<a name="scribd_helpers.py-pyg.html-11"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">models</span>
<a name="scribd_helpers.py-pyg.html-12"></a><span class="kn">from</span> <span class="nn">timeout</span> <span class="kn">import</span> <span class="n">timeout</span>
<a name="scribd_helpers.py-pyg.html-13"></a><span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<a name="scribd_helpers.py-pyg.html-14"></a><span class="kn">import</span> <span class="nn">tempfile</span>
<a name="scribd_helpers.py-pyg.html-15"></a>
<a name="scribd_helpers.py-pyg.html-16"></a>
<a name="scribd_helpers.py-pyg.html-17"></a><span class="k">def</span> <span class="nf">should_upload</span><span class="p">():</span>
<a name="scribd_helpers.py-pyg.html-18"></a>    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ENVIRONMENT&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;LOCAL&#39;</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-19"></a>        <span class="k">return</span> <span class="bp">True</span>
<a name="scribd_helpers.py-pyg.html-20"></a>    <span class="k">elif</span> <span class="s">&#39;UPLOAD_DOCS&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-21"></a>        <span class="k">return</span> <span class="bp">True</span>
<a name="scribd_helpers.py-pyg.html-22"></a>    <span class="k">return</span> <span class="bp">False</span>
<a name="scribd_helpers.py-pyg.html-23"></a>
<a name="scribd_helpers.py-pyg.html-24"></a>
<a name="scribd_helpers.py-pyg.html-25"></a><span class="c"># These are the extensions that can be uploaded to Scribd.com:</span>
<a name="scribd_helpers.py-pyg.html-26"></a><span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;txt&#39;</span><span class="p">,</span> <span class="s">&#39;pdf&#39;</span><span class="p">,</span> <span class="s">&#39;doc&#39;</span><span class="p">,</span> <span class="s">&#39;ps&#39;</span><span class="p">,</span> <span class="s">&#39;rtf&#39;</span><span class="p">,</span> <span class="s">&#39;epub&#39;</span><span class="p">,</span> <span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="s">&#39;odt&#39;</span><span class="p">,</span> <span class="s">&#39;odp&#39;</span><span class="p">,</span> <span class="s">&#39;ods&#39;</span><span class="p">,</span> <span class="s">&#39;odg&#39;</span><span class="p">,</span> <span class="s">&#39;odf&#39;</span><span class="p">,</span> <span class="s">&#39;sxw&#39;</span><span class="p">,</span> <span class="s">&#39;sxc&#39;</span><span class="p">,</span> <span class="s">&#39;sxi&#39;</span><span class="p">,</span> <span class="s">&#39;sxd&#39;</span><span class="p">,</span> <span class="s">&#39;ppt&#39;</span><span class="p">,</span> <span class="s">&#39;pps&#39;</span><span class="p">,</span> <span class="s">&#39;xls&#39;</span><span class="p">,</span> <span class="s">&#39;zip&#39;</span><span class="p">,</span> <span class="s">&#39;docx&#39;</span><span class="p">,</span> <span class="s">&#39;pptx&#39;</span><span class="p">,</span> <span class="s">&#39;ppsx&#39;</span><span class="p">,</span> <span class="s">&#39;xlsx&#39;</span><span class="p">,</span> <span class="s">&#39;tif&#39;</span><span class="p">,</span> <span class="s">&#39;tiff&#39;</span><span class="p">]</span>
<a name="scribd_helpers.py-pyg.html-27"></a>
<a name="scribd_helpers.py-pyg.html-28"></a>
<a name="scribd_helpers.py-pyg.html-29"></a><span class="k">def</span> <span class="nf">progress</span><span class="p">(</span><span class="n">bytes_sent</span><span class="p">,</span> <span class="n">bytes_total</span><span class="p">):</span>
<a name="scribd_helpers.py-pyg.html-30"></a>    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Scribd upload in progress: </span><span class="si">%s</span><span class="s"> of </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s%%</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bytes_sent</span><span class="p">,</span> <span class="n">bytes_total</span><span class="p">,</span> <span class="n">bytes_sent</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">bytes_total</span><span class="p">))</span>
<a name="scribd_helpers.py-pyg.html-31"></a>
<a name="scribd_helpers.py-pyg.html-32"></a><span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
<a name="scribd_helpers.py-pyg.html-33"></a>    <span class="c"># Configure the Scribd API.</span>
<a name="scribd_helpers.py-pyg.html-34"></a>    <span class="n">scribd</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-35"></a>    <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">None</span>
<a name="scribd_helpers.py-pyg.html-36"></a>    <span class="k">try</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-37"></a>        <span class="c"># Upload the document from a file.</span>
<a name="scribd_helpers.py-pyg.html-38"></a>        <span class="n">doc</span> <span class="o">=</span> <span class="n">scribd</span><span class="o">.</span><span class="n">api_user</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span>
<a name="scribd_helpers.py-pyg.html-39"></a>            <span class="n">targetfile</span> <span class="o">=</span> <span class="n">document</span><span class="p">,</span>
<a name="scribd_helpers.py-pyg.html-40"></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span>
<a name="scribd_helpers.py-pyg.html-41"></a>            <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
<a name="scribd_helpers.py-pyg.html-42"></a>            <span class="n">req_buffer</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryFile</span><span class="p">()</span>
<a name="scribd_helpers.py-pyg.html-43"></a>            <span class="p">)</span>  
<a name="scribd_helpers.py-pyg.html-44"></a>        <span class="n">doc</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>    
<a name="scribd_helpers.py-pyg.html-45"></a>        <span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> 
<a name="scribd_helpers.py-pyg.html-46"></a>        <span class="n">doc_id</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">id</span>
<a name="scribd_helpers.py-pyg.html-47"></a>        <span class="k">return</span> <span class="n">doc_id</span>
<a name="scribd_helpers.py-pyg.html-48"></a>    <span class="k">except</span> <span class="n">scribd</span><span class="o">.</span><span class="n">ResponseError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-49"></a>        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Scribd failed: code=</span><span class="si">%d</span><span class="s">, error=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
<a name="scribd_helpers.py-pyg.html-50"></a>        <span class="k">return</span> <span class="n">err</span><span class="o">.</span><span class="n">strerror</span>
<a name="scribd_helpers.py-pyg.html-51"></a>
<a name="scribd_helpers.py-pyg.html-52"></a><span class="k">def</span> <span class="nf">get_scribd_download_url</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">record_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="scribd_helpers.py-pyg.html-53"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">should_upload</span><span class="p">():</span>
<a name="scribd_helpers.py-pyg.html-54"></a>        <span class="k">return</span> <span class="bp">None</span>
<a name="scribd_helpers.py-pyg.html-55"></a>	<span class="n">API_KEY</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SCRIBD_API_KEY&#39;</span><span class="p">]</span>
<a name="scribd_helpers.py-pyg.html-56"></a>	<span class="n">API_SECRET</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SCRIBD_API_SECRET&#39;</span><span class="p">]</span>
<a name="scribd_helpers.py-pyg.html-57"></a>	<span class="k">try</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-58"></a>		<span class="n">scribd</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-59"></a>		<span class="n">doc</span> <span class="o">=</span> <span class="n">scribd</span><span class="o">.</span><span class="n">api_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-60"></a>		<span class="n">doc_url</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">get_download_url</span><span class="p">()</span>
<a name="scribd_helpers.py-pyg.html-61"></a>		<span class="k">if</span> <span class="n">record_id</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-62"></a>			<span class="n">set_scribd_download_url</span><span class="p">(</span><span class="n">download_url</span> <span class="o">=</span> <span class="n">doc_url</span><span class="p">,</span> <span class="n">record_id</span> <span class="o">=</span> <span class="n">record_id</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-63"></a>		<span class="k">return</span> <span class="n">doc_url</span>
<a name="scribd_helpers.py-pyg.html-64"></a>	<span class="k">except</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-65"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="scribd_helpers.py-pyg.html-66"></a>
<a name="scribd_helpers.py-pyg.html-67"></a>
<a name="scribd_helpers.py-pyg.html-68"></a><span class="k">def</span> <span class="nf">set_scribd_download_url</span><span class="p">(</span><span class="n">download_url</span><span class="p">,</span> <span class="n">record_id</span><span class="p">):</span>
<a name="scribd_helpers.py-pyg.html-69"></a>    <span class="n">update_obj</span><span class="p">(</span><span class="s">&#39;download_url&#39;</span><span class="p">,</span> <span class="n">download_url</span><span class="p">,</span> <span class="n">obj_type</span> <span class="o">=</span> <span class="s">&#39;Record&#39;</span><span class="p">,</span> <span class="n">obj_id</span> <span class="o">=</span> <span class="n">record_id</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-70"></a>
<a name="scribd_helpers.py-pyg.html-71"></a><span class="k">def</span> <span class="nf">scribd_batch_download</span><span class="p">():</span> 
<a name="scribd_helpers.py-pyg.html-72"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="scribd_helpers.py-pyg.html-73"></a>	<span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">records</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-74"></a>		<span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">download_url</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-75"></a>			<span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">downlaod_url</span><span class="p">,</span> <span class="s">&quot;saved_records/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
<a name="scribd_helpers.py-pyg.html-76"></a>
<a name="scribd_helpers.py-pyg.html-77"></a><span class="k">def</span> <span class="nf">make_public</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">):</span>
<a name="scribd_helpers.py-pyg.html-78"></a>    <span class="n">scribd</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-79"></a>    <span class="n">doc</span> <span class="o">=</span> <span class="n">scribd</span><span class="o">.</span><span class="n">api_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-80"></a>    <span class="n">doc</span><span class="o">.</span><span class="n">access</span> <span class="o">=</span> <span class="s">&#39;public&#39;</span>
<a name="scribd_helpers.py-pyg.html-81"></a>    <span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a name="scribd_helpers.py-pyg.html-82"></a>
<a name="scribd_helpers.py-pyg.html-83"></a><span class="k">def</span> <span class="nf">make_private</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">):</span>
<a name="scribd_helpers.py-pyg.html-84"></a>    <span class="n">scribd</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-85"></a>    <span class="n">doc</span> <span class="o">=</span> <span class="n">scribd</span><span class="o">.</span><span class="n">api_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doc_id</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-86"></a>    <span class="n">doc</span><span class="o">.</span><span class="n">access</span> <span class="o">=</span> <span class="s">&#39;private&#39;</span>
<a name="scribd_helpers.py-pyg.html-87"></a>    <span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a name="scribd_helpers.py-pyg.html-88"></a>
<a name="scribd_helpers.py-pyg.html-89"></a>
<a name="scribd_helpers.py-pyg.html-90"></a><span class="k">def</span> <span class="nf">update_descriptions</span><span class="p">(</span><span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">):</span>
<a name="scribd_helpers.py-pyg.html-91"></a>    <span class="n">scribd</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">API_KEY</span><span class="p">,</span> <span class="n">API_SECRET</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-92"></a>    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">scribd</span><span class="o">.</span><span class="n">api_user</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<a name="scribd_helpers.py-pyg.html-93"></a>        <span class="n">record</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Record</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">doc_id</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="scribd_helpers.py-pyg.html-94"></a>        <span class="k">if</span> <span class="n">record</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-95"></a>            <span class="n">link_back</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;APPLICATION_URL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;request/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">request_id</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-96"></a>            <span class="n">description</span> <span class="o">=</span>  <span class="s">&quot;This document was uploaded via RecordTrac in response to a public records request for the </span><span class="si">%s</span><span class="s">. You can view the original request here: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;AGENCY_NAME&#39;</span><span class="p">],</span> <span class="n">link_back</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-97"></a>            <span class="n">doc</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
<a name="scribd_helpers.py-pyg.html-98"></a>            <span class="n">doc</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<a name="scribd_helpers.py-pyg.html-99"></a>            <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Updated Scribd document </span><span class="si">%s</span><span class="s">&#39;s description to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">doc</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">description</span><span class="p">))</span>
<a name="scribd_helpers.py-pyg.html-100"></a>
<a name="scribd_helpers.py-pyg.html-101"></a>
<a name="scribd_helpers.py-pyg.html-102"></a>
<a name="scribd_helpers.py-pyg.html-103"></a><span class="nd">@timeout</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-104"></a><span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span> 
<a name="scribd_helpers.py-pyg.html-105"></a><span class="c"># Uploads file to scribd.com and returns doc ID. File can be accessed at scribd.com/doc/id</span>
<a name="scribd_helpers.py-pyg.html-106"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">should_upload</span><span class="p">():</span>
<a name="scribd_helpers.py-pyg.html-107"></a>        <span class="k">return</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="bp">None</span> <span class="c"># Don&#39;t need to do real uploads locally</span>
<a name="scribd_helpers.py-pyg.html-108"></a>    <span class="k">if</span> <span class="n">document</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-109"></a>        <span class="n">allowed</span> <span class="o">=</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-110"></a>        <span class="k">if</span> <span class="n">allowed</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
<a name="scribd_helpers.py-pyg.html-111"></a>            <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-112"></a>            <span class="n">link_back</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;APPLICATION_URL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;request/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_id</span><span class="p">)</span>
<a name="scribd_helpers.py-pyg.html-113"></a>            <span class="n">doc_id</span> <span class="o">=</span> <span class="n">upload</span><span class="p">(</span><span class="n">document</span> <span class="o">=</span> <span class="n">document</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">,</span> <span class="n">API_KEY</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SCRIBD_API_KEY&#39;</span><span class="p">],</span> <span class="n">API_SECRET</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SCRIBD_API_SECRET&#39;</span><span class="p">],</span> <span class="n">description</span> <span class="o">=</span> <span class="s">&quot;This document was uploaded via RecordTrac in response to a public records request for the </span><span class="si">%s</span><span class="s">. You can view the original request here: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;AGENCY_NAME&#39;</span><span class="p">],</span> <span class="n">link_back</span><span class="p">))</span>
<a name="scribd_helpers.py-pyg.html-114"></a>            <span class="k">return</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">filename</span>
<a name="scribd_helpers.py-pyg.html-115"></a>        <span class="k">else</span><span class="p">:</span>
<a name="scribd_helpers.py-pyg.html-116"></a>            <span class="k">return</span> <span class="n">allowed</span> <span class="c"># Returns false and extension</span>
<a name="scribd_helpers.py-pyg.html-117"></a>    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
<a name="scribd_helpers.py-pyg.html-118"></a>
<a name="scribd_helpers.py-pyg.html-119"></a><span class="c">### @export &quot;allowed_file&quot;</span>
<a name="scribd_helpers.py-pyg.html-120"></a><span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<a name="scribd_helpers.py-pyg.html-121"></a>    <span class="n">ext</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a name="scribd_helpers.py-pyg.html-122"></a>    <span class="k">return</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span><span class="p">,</span> <span class="n">ext</span>
</pre></div>

</pre>

<a name="spam">Spam</a> 
<p>spam.py</p>
<pre>
<div class="highlight"><pre><a name="spam.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="spam.py-pyg.html-2"></a><span class="sd">    public_records_portal.spam</span>
<a name="spam.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="spam.py-pyg.html-4"></a>
<a name="spam.py-pyg.html-5"></a><span class="sd">    Implements spam filters used on RecordTrac&#39;s forms that don&#39;t require login. Akismet is a dependency (https://akismet.com) and the following environment variables need to be set in order for this to work: AKISMET_KEY, APPLICATION_URL</span>
<a name="spam.py-pyg.html-6"></a>
<a name="spam.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="spam.py-pyg.html-8"></a>
<a name="spam.py-pyg.html-9"></a>
<a name="spam.py-pyg.html-10"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">app</span>
<a name="spam.py-pyg.html-11"></a><span class="kn">import</span> <span class="nn">akismet</span>
<a name="spam.py-pyg.html-12"></a><span class="kn">import</span> <span class="nn">logging</span>
<a name="spam.py-pyg.html-13"></a><span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">current_user</span>
<a name="spam.py-pyg.html-14"></a>
<a name="spam.py-pyg.html-15"></a><span class="k">def</span> <span class="nf">check_for_spam</span><span class="p">():</span>
<a name="spam.py-pyg.html-16"></a>	<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span> <span class="c"># Spam filter is currently implemented to prevent bot spamming, so if someone is logged in they have already verified they are human</span>
<a name="spam.py-pyg.html-17"></a>		<span class="k">return</span> <span class="bp">False</span>
<a name="spam.py-pyg.html-18"></a>	<span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;ENVIRONMENT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;PRODUCTION&#39;</span><span class="p">:</span> <span class="c"># This only needs to work in production, unless a local config variable is set to indicate otherwise</span>
<a name="spam.py-pyg.html-19"></a>		<span class="k">return</span> <span class="bp">True</span>
<a name="spam.py-pyg.html-20"></a>	<span class="k">elif</span> <span class="s">&#39;CHECK_FOR_SPAM&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="spam.py-pyg.html-21"></a>		<span class="k">return</span> <span class="bp">True</span>
<a name="spam.py-pyg.html-22"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="spam.py-pyg.html-23"></a>
<a name="spam.py-pyg.html-24"></a><span class="k">def</span> <span class="nf">is_spam</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="n">user_ip</span><span class="p">,</span> <span class="n">user_agent</span><span class="p">):</span>
<a name="spam.py-pyg.html-25"></a>	<span class="k">if</span> <span class="n">check_for_spam</span><span class="p">():</span>
<a name="spam.py-pyg.html-26"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Attempting to check for spam...&quot;</span><span class="p">)</span>
<a name="spam.py-pyg.html-27"></a>		<span class="n">key</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;AKISMET_KEY&#39;</span><span class="p">]</span>
<a name="spam.py-pyg.html-28"></a>		<span class="n">blog</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;APPLICATION_URL&#39;</span><span class="p">]</span>
<a name="spam.py-pyg.html-29"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">is_working_akismet_key</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">blog</span> <span class="o">=</span> <span class="n">blog</span><span class="p">):</span>
<a name="spam.py-pyg.html-30"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">There was a problem verifying the supplied AKISMET_KEY. Unable to check for spam.&quot;</span><span class="p">)</span>
<a name="spam.py-pyg.html-31"></a>			<span class="k">return</span> <span class="bp">False</span>
<a name="spam.py-pyg.html-32"></a>		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comment</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
<a name="spam.py-pyg.html-33"></a>			<span class="n">comment</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>
<a name="spam.py-pyg.html-34"></a>		<span class="k">if</span> <span class="n">akismet</span><span class="o">.</span><span class="n">comment_check</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">blog</span> <span class="o">=</span> <span class="n">blog</span><span class="p">,</span> <span class="n">user_ip</span> <span class="o">=</span> <span class="n">user_ip</span><span class="p">,</span> <span class="n">user_agent</span> <span class="o">=</span> <span class="n">user_agent</span><span class="p">,</span> <span class="n">comment_content</span> <span class="o">=</span> <span class="n">comment</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;http&#39;</span> <span class="ow">in</span> <span class="n">comment</span><span class="p">:</span>
<a name="spam.py-pyg.html-35"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Spam detected: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">comment</span> <span class="p">)</span>
<a name="spam.py-pyg.html-36"></a>			<span class="k">return</span> <span class="bp">True</span>
<a name="spam.py-pyg.html-37"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="spam.py-pyg.html-38"></a>
<a name="spam.py-pyg.html-39"></a><span class="k">def</span> <span class="nf">is_working_akismet_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">blog</span><span class="p">):</span>
<a name="spam.py-pyg.html-40"></a>	<span class="n">key</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;AKISMET_KEY&#39;</span><span class="p">]</span>
<a name="spam.py-pyg.html-41"></a>	<span class="n">blog</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;APPLICATION_URL&#39;</span><span class="p">]</span>
<a name="spam.py-pyg.html-42"></a>	<span class="k">return</span> <span class="n">akismet</span><span class="o">.</span><span class="n">verify_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">blog</span><span class="o">=</span><span class="n">blog</span><span class="p">)</span>
</pre></div>

</pre>

<a name="views">Views</a> 
<p>views.py</p>
<pre>
<div class="highlight"><pre><a name="views.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="views.py-pyg.html-2"></a><span class="sd">    public_records_portal.views</span>
<a name="views.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="views.py-pyg.html-4"></a>
<a name="views.py-pyg.html-5"></a><span class="sd">    Implements functions that render the Jinja (http://jinja.pocoo.org/) templates/html for RecordTrac.</span>
<a name="views.py-pyg.html-6"></a>
<a name="views.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="views.py-pyg.html-8"></a>
<a name="views.py-pyg.html-9"></a>
<a name="views.py-pyg.html-10"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">jsonify</span>
<a name="views.py-pyg.html-11"></a><span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">LoginManager</span><span class="p">,</span> <span class="n">login_user</span><span class="p">,</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">login_required</span>
<a name="views.py-pyg.html-12"></a><span class="kn">from</span> <span class="nn">flaskext.browserid</span> <span class="kn">import</span> <span class="n">BrowserID</span>
<a name="views.py-pyg.html-13"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">models</span>
<a name="views.py-pyg.html-14"></a><span class="kn">from</span> <span class="nn">prr</span> <span class="kn">import</span> <span class="n">add_resource</span><span class="p">,</span> <span class="n">update_resource</span><span class="p">,</span> <span class="n">make_request</span><span class="p">,</span> <span class="n">close_request</span>
<a name="views.py-pyg.html-15"></a><span class="kn">from</span> <span class="nn">db_helpers</span> <span class="kn">import</span> <span class="n">get_user_by_id</span> <span class="c"># finds a user by their id</span>
<a name="views.py-pyg.html-16"></a><span class="kn">from</span> <span class="nn">db_helpers</span> <span class="kn">import</span> <span class="n">get_user</span> <span class="c"># finds a user based on BrowserID response</span>
<a name="views.py-pyg.html-17"></a><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">json</span>
<a name="views.py-pyg.html-18"></a><span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">urljoin</span>
<a name="views.py-pyg.html-19"></a><span class="kn">from</span> <span class="nn">notifications</span> <span class="kn">import</span> <span class="n">send_prr_email</span><span class="p">,</span> <span class="n">format_date</span>
<a name="views.py-pyg.html-20"></a><span class="kn">from</span> <span class="nn">spam</span> <span class="kn">import</span> <span class="n">is_spam</span><span class="p">,</span> <span class="n">is_working_akismet_key</span>
<a name="views.py-pyg.html-21"></a><span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">get</span>
<a name="views.py-pyg.html-22"></a><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<a name="views.py-pyg.html-23"></a><span class="kn">from</span> <span class="nn">flask.ext.cache</span> <span class="kn">import</span> <span class="n">Cache</span>
<a name="views.py-pyg.html-24"></a><span class="kn">from</span> <span class="nn">recaptcha.client</span> <span class="kn">import</span> <span class="n">captcha</span>
<a name="views.py-pyg.html-25"></a><span class="kn">from</span> <span class="nn">timeout</span> <span class="kn">import</span> <span class="n">timeout</span>
<a name="views.py-pyg.html-26"></a><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span>
<a name="views.py-pyg.html-27"></a><span class="kn">import</span> <span class="nn">anyjson</span>
<a name="views.py-pyg.html-28"></a><span class="kn">import</span> <span class="nn">helpers</span>
<a name="views.py-pyg.html-29"></a><span class="kn">import</span> <span class="nn">csv_export</span>
<a name="views.py-pyg.html-30"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a name="views.py-pyg.html-31"></a><span class="kn">from</span> <span class="nn">filters</span> <span class="kn">import</span> <span class="o">*</span>
<a name="views.py-pyg.html-32"></a><span class="kn">import</span> <span class="nn">re</span>
<a name="views.py-pyg.html-33"></a><span class="kn">from</span> <span class="nn">db_helpers</span> <span class="kn">import</span> <span class="n">get_count</span><span class="p">,</span> <span class="n">get_obj</span>
<a name="views.py-pyg.html-34"></a><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">not_</span><span class="p">,</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span>
<a name="views.py-pyg.html-35"></a><span class="kn">import</span> <span class="nn">pytz</span>
<a name="views.py-pyg.html-36"></a>
<a name="views.py-pyg.html-37"></a><span class="c"># Initialize login</span>
<a name="views.py-pyg.html-38"></a>
<a name="views.py-pyg.html-39"></a><span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>
<a name="views.py-pyg.html-40"></a><span class="n">login_manager</span><span class="o">.</span><span class="n">user_loader</span><span class="p">(</span><span class="n">get_user_by_id</span><span class="p">)</span>
<a name="views.py-pyg.html-41"></a><span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a name="views.py-pyg.html-42"></a>
<a name="views.py-pyg.html-43"></a><span class="n">browser_id</span> <span class="o">=</span> <span class="n">BrowserID</span><span class="p">()</span>
<a name="views.py-pyg.html-44"></a><span class="n">browser_id</span><span class="o">.</span><span class="n">user_loader</span><span class="p">(</span><span class="n">get_user</span><span class="p">)</span>
<a name="views.py-pyg.html-45"></a><span class="n">browser_id</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<a name="views.py-pyg.html-46"></a>
<a name="views.py-pyg.html-47"></a>
<a name="views.py-pyg.html-48"></a><span class="c"># Submitting a new request</span>
<a name="views.py-pyg.html-49"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/new&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-50"></a><span class="k">def</span> <span class="nf">new_request</span><span class="p">(</span><span class="n">passed_recaptcha</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="views.py-pyg.html-51"></a>	<span class="k">if</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
<a name="views.py-pyg.html-52"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">passed_recaptcha</span><span class="p">:</span>
<a name="views.py-pyg.html-53"></a>			<span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a name="views.py-pyg.html-54"></a>		<span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;request_email&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-55"></a>		<span class="n">request_text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;request_text&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-56"></a>		<span class="k">if</span> <span class="n">request_text</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-57"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;You cannot submit an empty request.&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-58"></a>		<span class="k">if</span> <span class="n">email</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="s">&#39;ignore_email&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">passed_recaptcha</span><span class="p">:</span>
<a name="views.py-pyg.html-59"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;missing_email.html&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="n">data</span><span class="p">)</span>
<a name="views.py-pyg.html-60"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">passed_recaptcha</span> <span class="ow">and</span> <span class="p">(</span><span class="n">is_spam</span><span class="p">(</span><span class="n">comment</span> <span class="o">=</span> <span class="n">request_text</span><span class="p">,</span> <span class="n">user_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;User-Agent&#39;</span><span class="p">))):</span>
<a name="views.py-pyg.html-61"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;recaptcha_request.html&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Hmm, your request looks like spam. To submit your request, type the numbers or letters you see in the field below.&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-62"></a>
<a name="views.py-pyg.html-63"></a>		<span class="n">alias</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-64"></a>		<span class="n">phone</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-65"></a>		<span class="n">offline_submission_type</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-66"></a>		<span class="n">date_received</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-67"></a>		<span class="n">department</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-68"></a>		<span class="k">if</span> <span class="s">&#39;request_department&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<a name="views.py-pyg.html-69"></a>			<span class="n">department</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;request_department&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-70"></a>		<span class="k">if</span> <span class="s">&#39;request_alias&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<a name="views.py-pyg.html-71"></a>			<span class="n">alias</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;request_alias&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-72"></a>		<span class="k">if</span> <span class="s">&#39;request_phone&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<a name="views.py-pyg.html-73"></a>			<span class="n">phone</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;request_phone&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-74"></a>		<span class="k">if</span> <span class="s">&#39;format_received&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<a name="views.py-pyg.html-75"></a>			<span class="n">offline_submission_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;format_received&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-76"></a>		<span class="k">if</span> <span class="s">&#39;date_received&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span> <span class="c"># From the jQuery datepicker</span>
<a name="views.py-pyg.html-77"></a>			<span class="n">date_received</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;date_received&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-78"></a>			<span class="k">if</span> <span class="n">date_received</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-79"></a>				<span class="k">try</span><span class="p">:</span>
<a name="views.py-pyg.html-80"></a>					<span class="n">date_received</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_received</span><span class="p">,</span> <span class="s">&#39;%m/</span><span class="si">%d</span><span class="s">/%Y&#39;</span><span class="p">)</span> 
<a name="views.py-pyg.html-81"></a>					<span class="n">tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;TIMEZONE&#39;</span><span class="p">])</span>
<a name="views.py-pyg.html-82"></a>					<span class="n">offset</span> <span class="o">=</span> <span class="n">tz</span><span class="o">.</span><span class="n">utcoffset</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<a name="views.py-pyg.html-83"></a>					<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">days</span> <span class="o">*</span> <span class="mi">86400</span> <span class="o">+</span> <span class="n">offset</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span>
<a name="views.py-pyg.html-84"></a>					<span class="n">date_received</span> <span class="o">=</span> <span class="n">date_received</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span> <span class="o">=</span> <span class="n">offset</span><span class="p">)</span> <span class="c"># This is somewhat of a hack, but we need to get this back in UTC time but still treat it as a &#39;naive&#39; datetime object</span>
<a name="views.py-pyg.html-85"></a>				<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<a name="views.py-pyg.html-86"></a>					<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Please use the datepicker to select a date.&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-87"></a>		<span class="n">request_id</span><span class="p">,</span> <span class="n">is_new</span> <span class="o">=</span> <span class="n">make_request</span><span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="n">request_text</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="n">email</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span><span class="p">,</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span><span class="p">,</span> <span class="n">passed_spam_filter</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="n">department</span><span class="p">,</span> <span class="n">offline_submission_type</span> <span class="o">=</span> <span class="n">offline_submission_type</span><span class="p">,</span> <span class="n">date_received</span> <span class="o">=</span> <span class="n">date_received</span><span class="p">)</span>
<a name="views.py-pyg.html-88"></a>		<span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
<a name="views.py-pyg.html-89"></a>			<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;show_request_for_x&#39;</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">audience</span> <span class="o">=</span> <span class="s">&#39;new&#39;</span><span class="p">))</span>
<a name="views.py-pyg.html-90"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">request_id</span><span class="p">:</span>
<a name="views.py-pyg.html-91"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Your request looks a lot like spam.&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-92"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Duplicate request entered: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">request_text</span><span class="p">)</span>
<a name="views.py-pyg.html-93"></a>		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Your request is the same as /request/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
<a name="views.py-pyg.html-94"></a>	<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-95"></a>		<span class="n">departments</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-96"></a>		<span class="n">routing_available</span> <span class="o">=</span> <span class="bp">False</span>
<a name="views.py-pyg.html-97"></a>		<span class="k">if</span> <span class="s">&#39;LIAISONS_URL&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
<a name="views.py-pyg.html-98"></a>			<span class="n">routing_available</span> <span class="o">=</span> <span class="bp">True</span>
<a name="views.py-pyg.html-99"></a>			<span class="n">departments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Department</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="views.py-pyg.html-100"></a>		<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<a name="views.py-pyg.html-101"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;offline_request.html&#39;</span><span class="p">,</span> <span class="n">routing_available</span> <span class="o">=</span> <span class="n">routing_available</span><span class="p">,</span> <span class="n">departments</span> <span class="o">=</span> <span class="n">departments</span><span class="p">)</span>
<a name="views.py-pyg.html-102"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-103"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;new_request.html&#39;</span><span class="p">,</span> <span class="n">routing_available</span> <span class="o">=</span> <span class="n">routing_available</span><span class="p">,</span> <span class="n">departments</span> <span class="o">=</span> <span class="n">departments</span><span class="p">)</span>
<a name="views.py-pyg.html-104"></a>
<a name="views.py-pyg.html-105"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/export&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-106"></a><span class="nd">@login_required</span>
<a name="views.py-pyg.html-107"></a><span class="k">def</span> <span class="nf">to_csv</span><span class="p">():</span>
<a name="views.py-pyg.html-108"></a>	<span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">csv_export</span><span class="o">.</span><span class="n">export</span><span class="p">(),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s">&#39;text/csv&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-109"></a>
<a name="views.py-pyg.html-110"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-111"></a><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
<a name="views.py-pyg.html-112"></a>	<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
<a name="views.py-pyg.html-113"></a>		<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;display_all_requests&#39;</span><span class="p">))</span>
<a name="views.py-pyg.html-114"></a>	<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-115"></a>		<span class="k">return</span> <span class="n">landing</span><span class="p">()</span>
<a name="views.py-pyg.html-116"></a>
<a name="views.py-pyg.html-117"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/landing&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-118"></a><span class="k">def</span> <span class="nf">landing</span><span class="p">():</span>
<a name="views.py-pyg.html-119"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;landing.html&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-120"></a>
<a name="views.py-pyg.html-121"></a><span class="nd">@login_manager.unauthorized_handler</span>
<a name="views.py-pyg.html-122"></a><span class="k">def</span> <span class="nf">unauthorized</span><span class="p">():</span>
<a name="views.py-pyg.html-123"></a>    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;alpha.html&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-124"></a>
<a name="views.py-pyg.html-125"></a><span class="nd">@app.errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<a name="views.py-pyg.html-126"></a><span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
<a name="views.py-pyg.html-127"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;404.html&#39;</span><span class="p">),</span> <span class="mi">404</span>
<a name="views.py-pyg.html-128"></a>
<a name="views.py-pyg.html-129"></a><span class="k">def</span> <span class="nf">explain_all_actions</span><span class="p">():</span>
<a name="views.py-pyg.html-130"></a>	<span class="n">action_json</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&#39;static/json/actions.json&#39;</span><span class="p">))</span>
<a name="views.py-pyg.html-131"></a>	<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">action_json</span><span class="p">)</span>
<a name="views.py-pyg.html-132"></a>	<span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
<a name="views.py-pyg.html-133"></a>	<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
<a name="views.py-pyg.html-134"></a>		<span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">json_data</span><span class="p">[</span><span class="n">data</span><span class="p">][</span><span class="s">&quot;What&quot;</span><span class="p">]))</span>
<a name="views.py-pyg.html-135"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;actions.html&#39;</span><span class="p">,</span> <span class="n">actions</span> <span class="o">=</span> <span class="n">actions</span><span class="p">)</span>
<a name="views.py-pyg.html-136"></a>
<a name="views.py-pyg.html-137"></a><span class="c"># Returns a view of the case based on the audience. Currently views exist for city staff or general public.</span>
<a name="views.py-pyg.html-138"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&lt;string:audience&gt;/request/&lt;int:request_id&gt;&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-139"></a><span class="k">def</span> <span class="nf">show_request_for_x</span><span class="p">(</span><span class="n">audience</span><span class="p">,</span> <span class="n">request_id</span><span class="p">):</span>
<a name="views.py-pyg.html-140"></a>	<span class="k">if</span> <span class="s">&quot;city&quot;</span> <span class="ow">in</span> <span class="n">audience</span><span class="p">:</span>
<a name="views.py-pyg.html-141"></a>		<span class="k">return</span> <span class="n">show_request_for_city</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">)</span>
<a name="views.py-pyg.html-142"></a>	<span class="k">return</span> <span class="n">show_request</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;manage_request_</span><span class="si">%s</span><span class="s">.html&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">audience</span><span class="p">))</span>
<a name="views.py-pyg.html-143"></a><span class="n">show_request_for_x</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-144"></a>
<a name="views.py-pyg.html-145"></a>
<a name="views.py-pyg.html-146"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/city/request/&lt;int:request_id&gt;&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-147"></a><span class="nd">@login_required</span>
<a name="views.py-pyg.html-148"></a><span class="k">def</span> <span class="nf">show_request_for_city</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
<a name="views.py-pyg.html-149"></a>	<span class="k">if</span> <span class="n">is_supported_browser</span><span class="p">():</span>
<a name="views.py-pyg.html-150"></a>		<span class="k">return</span> <span class="n">show_request</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;manage_request_city.html&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-151"></a>	<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-152"></a>		<span class="k">return</span> <span class="n">show_request</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;manage_request_city_less_js.html&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-153"></a>
<a name="views.py-pyg.html-154"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/response/&lt;int:request_id&gt;&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-155"></a><span class="k">def</span> <span class="nf">show_response</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
<a name="views.py-pyg.html-156"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a name="views.py-pyg.html-157"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="p">:</span>
<a name="views.py-pyg.html-158"></a>		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;A request with ID </span><span class="si">%s</span><span class="s"> does not exist.&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
<a name="views.py-pyg.html-159"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;response.html&quot;</span><span class="p">,</span> <span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">)</span>
<a name="views.py-pyg.html-160"></a>
<a name="views.py-pyg.html-161"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/track&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-162"></a><span class="k">def</span> <span class="nf">track</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="views.py-pyg.html-163"></a>	<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
<a name="views.py-pyg.html-164"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">request_id</span><span class="p">:</span>
<a name="views.py-pyg.html-165"></a>			<span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-166"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">():</span>
<a name="views.py-pyg.html-167"></a>			<span class="n">audience</span> <span class="o">=</span> <span class="s">&#39;city&#39;</span>
<a name="views.py-pyg.html-168"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-169"></a>			<span class="n">audience</span> <span class="o">=</span> <span class="s">&#39;public&#39;</span>
<a name="views.py-pyg.html-170"></a>		<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;show_request_for_x&#39;</span><span class="p">,</span> <span class="n">audience</span><span class="o">=</span> <span class="n">audience</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">))</span>
<a name="views.py-pyg.html-171"></a>	<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-172"></a>		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;track.html&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-173"></a>
<a name="views.py-pyg.html-174"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/unfollow/&lt;int:request_id&gt;/&lt;string:email&gt;&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-175"></a><span class="k">def</span> <span class="nf">unfollow</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
<a name="views.py-pyg.html-176"></a>	<span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
<a name="views.py-pyg.html-177"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">create_or_return_user</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<a name="views.py-pyg.html-178"></a>	<span class="n">subscriber</span> <span class="o">=</span> <span class="n">get_subscriber</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="views.py-pyg.html-179"></a>	<span class="k">if</span> <span class="n">subscriber</span><span class="p">:</span>
<a name="views.py-pyg.html-180"></a>		<span class="n">success</span> <span class="o">=</span> <span class="n">update_obj</span><span class="p">(</span><span class="n">attribute</span> <span class="o">=</span> <span class="s">&quot;should_notify&quot;</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">subscriber</span><span class="p">)</span>
<a name="views.py-pyg.html-181"></a>	<span class="k">if</span> <span class="n">success</span><span class="p">:</span>
<a name="views.py-pyg.html-182"></a>		<span class="k">return</span> <span class="n">show_request</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;manage_request_unfollow.html&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-183"></a>	<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-184"></a>		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Unfollowing this request was unsuccessful. You probably weren&#39;t following it to begin with.&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-185"></a>
<a name="views.py-pyg.html-186"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/request/&lt;int:request_id&gt;&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-187"></a><span class="k">def</span> <span class="nf">show_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">template</span> <span class="o">=</span> <span class="s">&quot;manage_request_public.html&quot;</span><span class="p">):</span>
<a name="views.py-pyg.html-188"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a name="views.py-pyg.html-189"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="p">:</span>
<a name="views.py-pyg.html-190"></a>		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;A request with ID </span><span class="si">%s</span><span class="s"> does not exist.&quot;</span> <span class="o">%</span> <span class="n">request_id</span><span class="p">)</span>
<a name="views.py-pyg.html-191"></a>	<span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="s">&quot;Closed&quot;</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="n">template</span> <span class="o">!=</span> <span class="s">&quot;manage_request_feedback.html&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-192"></a>		<span class="n">template</span> <span class="o">=</span> <span class="s">&quot;closed.html&quot;</span>
<a name="views.py-pyg.html-193"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">)</span>
<a name="views.py-pyg.html-194"></a>
<a name="views.py-pyg.html-195"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/api/staff&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-196"></a><span class="k">def</span> <span class="nf">staff_to_json</span><span class="p">():</span>
<a name="views.py-pyg.html-197"></a>	<span class="n">users</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="views.py-pyg.html-198"></a>	<span class="n">staff_data</span> <span class="o">=</span> <span class="p">[]</span>
<a name="views.py-pyg.html-199"></a>	<span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
<a name="views.py-pyg.html-200"></a>		<span class="n">staff_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;alias&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">email</span><span class="p">})</span>
<a name="views.py-pyg.html-201"></a>	<span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s">&#39;objects&#39;</span><span class="p">:</span> <span class="n">staff_data</span><span class="p">})</span>
<a name="views.py-pyg.html-202"></a>
<a name="views.py-pyg.html-203"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/api/departments&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-204"></a><span class="k">def</span> <span class="nf">departments_to_json</span><span class="p">():</span>
<a name="views.py-pyg.html-205"></a>	<span class="n">departments</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Department</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="views.py-pyg.html-206"></a>	<span class="n">department_data</span> <span class="o">=</span> <span class="p">[]</span>
<a name="views.py-pyg.html-207"></a>	<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">departments</span><span class="p">:</span>
<a name="views.py-pyg.html-208"></a>		<span class="n">department_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;department&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
<a name="views.py-pyg.html-209"></a>	<span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s">&#39;objects&#39;</span><span class="p">:</span> <span class="n">department_data</span><span class="p">})</span>
<a name="views.py-pyg.html-210"></a>
<a name="views.py-pyg.html-211"></a><span class="k">def</span> <span class="nf">docs</span><span class="p">():</span>
<a name="views.py-pyg.html-212"></a>	<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">&#39;http://codeforamerica.github.io/public-records/docs/1.0.0&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-213"></a>
<a name="views.py-pyg.html-214"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/edit/request/&lt;int:request_id&gt;&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-215"></a><span class="nd">@login_required</span>
<a name="views.py-pyg.html-216"></a><span class="k">def</span> <span class="nf">edit_case</span><span class="p">(</span><span class="n">request_id</span><span class="p">):</span>
<a name="views.py-pyg.html-217"></a>	<span class="n">req</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">)</span>
<a name="views.py-pyg.html-218"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;edit_case.html&quot;</span><span class="p">,</span> <span class="n">req</span> <span class="o">=</span> <span class="n">req</span><span class="p">)</span>
<a name="views.py-pyg.html-219"></a>
<a name="views.py-pyg.html-220"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/add_a_&lt;string:resource&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-221"></a><span class="nd">@login_required</span>
<a name="views.py-pyg.html-222"></a><span class="k">def</span> <span class="nf">add_a_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
<a name="views.py-pyg.html-223"></a>	<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
<a name="views.py-pyg.html-224"></a>		<span class="n">resource_id</span> <span class="o">=</span> <span class="n">add_resource</span><span class="p">(</span><span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="p">,</span> <span class="n">request_body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">())</span>
<a name="views.py-pyg.html-225"></a>		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
<a name="views.py-pyg.html-226"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Successfully added resource: </span><span class="si">%s</span><span class="s"> with id: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">resource_id</span><span class="p">))</span>
<a name="views.py-pyg.html-227"></a>			<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;show_request_for_city&#39;</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]))</span>
<a name="views.py-pyg.html-228"></a>		<span class="k">elif</span> <span class="n">resource_id</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
<a name="views.py-pyg.html-229"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">There was an issue with adding resource: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">resource</span><span class="p">)</span>
<a name="views.py-pyg.html-230"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-231"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-232"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">There was an issue with the upload: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">resource_id</span><span class="p">)</span>
<a name="views.py-pyg.html-233"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;help_with_uploads.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">resource_id</span><span class="p">)</span>
<a name="views.py-pyg.html-234"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;You can only update requests from a request page!&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-235"></a>
<a name="views.py-pyg.html-236"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/public_add_a_&lt;string:resource&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-237"></a><span class="k">def</span> <span class="nf">public_add_a_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">passed_recaptcha</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="views.py-pyg.html-238"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;note&#39;</span> <span class="ow">in</span> <span class="n">resource</span> <span class="ow">or</span> <span class="s">&#39;subscriber&#39;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">):</span>
<a name="views.py-pyg.html-239"></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
<a name="views.py-pyg.html-240"></a>					<span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a name="views.py-pyg.html-241"></a>			<span class="k">if</span> <span class="s">&#39;note&#39;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="views.py-pyg.html-242"></a>				<span class="k">if</span> <span class="ow">not</span> <span class="n">passed_recaptcha</span> <span class="ow">and</span> <span class="n">is_spam</span><span class="p">(</span><span class="n">comment</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;note_text&#39;</span><span class="p">],</span> <span class="n">user_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;User-Agent&#39;</span><span class="p">)):</span>
<a name="views.py-pyg.html-243"></a>					<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;recaptcha_note.html&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Hmm, your note looks like spam. To submit your note, type the numbers or letters you see in the field below.&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-244"></a>				<span class="n">resource_id</span> <span class="o">=</span> <span class="n">prr</span><span class="o">.</span><span class="n">add_note</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">],</span> <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;note_text&#39;</span><span class="p">],</span> <span class="n">passed_spam_filter</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-245"></a>			<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-246"></a>				<span class="n">resource_id</span> <span class="o">=</span> <span class="n">prr</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">resource</span> <span class="o">=</span> <span class="n">resource</span><span class="p">,</span> <span class="n">request_body</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">current_user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">)</span>
<a name="views.py-pyg.html-247"></a>			<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
<a name="views.py-pyg.html-248"></a>				<span class="n">request_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-249"></a>				<span class="n">audience</span> <span class="o">=</span> <span class="s">&#39;public&#39;</span>
<a name="views.py-pyg.html-250"></a>				<span class="k">if</span> <span class="s">&#39;subscriber&#39;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="views.py-pyg.html-251"></a>					<span class="n">audience</span> <span class="o">=</span> <span class="s">&#39;follower&#39;</span>
<a name="views.py-pyg.html-252"></a>				<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;show_request_for_x&#39;</span><span class="p">,</span> <span class="n">audience</span><span class="o">=</span><span class="n">audience</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">))</span>
<a name="views.py-pyg.html-253"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-254"></a>
<a name="views.py-pyg.html-255"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/update_a_&lt;string:resource&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-256"></a><span class="k">def</span> <span class="nf">update_a_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">passed_recaptcha</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="views.py-pyg.html-257"></a>	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">):</span>
<a name="views.py-pyg.html-258"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
<a name="views.py-pyg.html-259"></a>			<span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a name="views.py-pyg.html-260"></a>		<span class="k">if</span> <span class="s">&#39;qa&#39;</span> <span class="ow">in</span> <span class="n">resource</span><span class="p">:</span>
<a name="views.py-pyg.html-261"></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">passed_recaptcha</span> <span class="ow">and</span> <span class="n">is_spam</span><span class="p">(</span><span class="n">comment</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;answer_text&#39;</span><span class="p">],</span> <span class="n">user_ip</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;User-Agent&#39;</span><span class="p">)):</span>
<a name="views.py-pyg.html-262"></a>				<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;recaptcha_answer.html&#39;</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Hmm, your answer looks like spam. To submit your answer, type the numbers or letters you see in the fiel dbelow.&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-263"></a>			<span class="n">prr</span><span class="o">.</span><span class="n">answer_a_question</span><span class="p">(</span><span class="n">qa_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;qa_id&#39;</span><span class="p">]),</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;answer_text&#39;</span><span class="p">],</span> <span class="n">passed_spam_filter</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-264"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-265"></a>			<span class="n">update_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>			
<a name="views.py-pyg.html-266"></a>		<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">()</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
<a name="views.py-pyg.html-267"></a>			<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;show_request_for_city&#39;</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]))</span>
<a name="views.py-pyg.html-268"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-269"></a>			<span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;show_request&#39;</span><span class="p">,</span> <span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]))</span>
<a name="views.py-pyg.html-270"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;You can only update requests from a request page!&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-271"></a>
<a name="views.py-pyg.html-272"></a><span class="c"># Closing is specific to a case, so this only gets called from a case (that only city staff have a view of)</span>
<a name="views.py-pyg.html-273"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/close&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-274"></a><span class="nd">@login_required</span>
<a name="views.py-pyg.html-275"></a><span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="views.py-pyg.html-276"></a>	<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
<a name="views.py-pyg.html-277"></a>		<span class="n">template</span> <span class="o">=</span> <span class="s">&#39;closed.html&#39;</span>
<a name="views.py-pyg.html-278"></a>		<span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-279"></a>		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<a name="views.py-pyg.html-280"></a>		<span class="k">if</span> <span class="s">&#39;close_reason&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
<a name="views.py-pyg.html-281"></a>			<span class="n">reason</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;close_reason&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-282"></a>		<span class="k">elif</span> <span class="s">&#39;close_reasons&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
<a name="views.py-pyg.html-283"></a>			<span class="k">for</span> <span class="n">close_reason</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">&#39;close_reasons&#39;</span><span class="p">):</span>
<a name="views.py-pyg.html-284"></a>				<span class="n">reason</span> <span class="o">+=</span> <span class="n">close_reason</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>
<a name="views.py-pyg.html-285"></a>		<span class="n">close_request</span><span class="p">(</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">())</span>
<a name="views.py-pyg.html-286"></a>		<span class="k">return</span> <span class="n">show_request</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span> <span class="n">template</span><span class="p">)</span>
<a name="views.py-pyg.html-287"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;You can only close from a requests page!&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-288"></a>
<a name="views.py-pyg.html-289"></a>
<a name="views.py-pyg.html-290"></a><span class="k">def</span> <span class="nf">filter_department</span><span class="p">(</span><span class="n">departments_selected</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<a name="views.py-pyg.html-291"></a>	<span class="k">if</span> <span class="n">departments_selected</span> <span class="ow">and</span> <span class="s">&#39;All departments&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">departments_selected</span><span class="p">:</span>
<a name="views.py-pyg.html-292"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Department filters:</span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">departments_selected</span><span class="p">)</span>
<a name="views.py-pyg.html-293"></a>		<span class="n">department_ids</span> <span class="o">=</span> <span class="p">[]</span>
<a name="views.py-pyg.html-294"></a>		<span class="k">for</span> <span class="n">department_name</span> <span class="ow">in</span> <span class="n">departments_selected</span><span class="p">:</span>
<a name="views.py-pyg.html-295"></a>			<span class="k">if</span> <span class="n">department_name</span><span class="p">:</span>
<a name="views.py-pyg.html-296"></a>				<span class="n">department</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Department</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">department_name</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<a name="views.py-pyg.html-297"></a>				<span class="k">if</span> <span class="n">department</span><span class="p">:</span>
<a name="views.py-pyg.html-298"></a>					<span class="n">department_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">department</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="views.py-pyg.html-299"></a>		<span class="k">if</span> <span class="n">department_ids</span><span class="p">:</span>
<a name="views.py-pyg.html-300"></a>			<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">department_id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">department_ids</span><span class="p">))</span>
<a name="views.py-pyg.html-301"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-302"></a>			<span class="c"># Just return an empty query set</span>
<a name="views.py-pyg.html-303"></a>			<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">department_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<a name="views.py-pyg.html-304"></a>	<span class="k">return</span> <span class="n">results</span>
<a name="views.py-pyg.html-305"></a>
<a name="views.py-pyg.html-306"></a><span class="k">def</span> <span class="nf">filter_search_term</span><span class="p">(</span><span class="n">search_input</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
<a name="views.py-pyg.html-307"></a>	<span class="k">if</span> <span class="n">search_input</span><span class="p">:</span>
<a name="views.py-pyg.html-308"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Searching for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">search_input</span><span class="p">)</span>
<a name="views.py-pyg.html-309"></a>		<span class="n">search_terms</span> <span class="o">=</span> <span class="n">search_input</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span> <span class="c"># Get rid of leading and trailing spaces and generate a list of the search terms</span>
<a name="views.py-pyg.html-310"></a>		<span class="n">num_terms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">search_terms</span><span class="p">)</span>
<a name="views.py-pyg.html-311"></a>		<span class="c"># Set up the query</span>
<a name="views.py-pyg.html-312"></a>		<span class="n">search_query</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<a name="views.py-pyg.html-313"></a>		<span class="k">if</span> <span class="n">num_terms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a name="views.py-pyg.html-314"></a>			<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_terms</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<a name="views.py-pyg.html-315"></a>				<span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span> <span class="o">+</span> <span class="n">search_terms</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; &amp; &#39;</span> 
<a name="views.py-pyg.html-316"></a>		<span class="n">search_query</span> <span class="o">=</span> <span class="n">search_query</span> <span class="o">+</span> <span class="n">search_terms</span><span class="p">[</span><span class="n">num_terms</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;:*&quot;</span> <span class="c"># Catch substrings</span>
<a name="views.py-pyg.html-317"></a>		<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&quot;to_tsvector(text) @@ to_tsquery(&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">search_query</span><span class="p">)</span>
<a name="views.py-pyg.html-318"></a>	<span class="k">return</span> <span class="n">results</span>
<a name="views.py-pyg.html-319"></a>
<a name="views.py-pyg.html-320"></a><span class="k">def</span> <span class="nf">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">,</span> <span class="n">is_list</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">is_boolean</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="views.py-pyg.html-321"></a>	<span class="k">if</span> <span class="n">filter_name</span> <span class="ow">in</span> <span class="n">filters_map</span><span class="p">:</span>
<a name="views.py-pyg.html-322"></a>		<span class="n">val</span> <span class="o">=</span> <span class="n">filters_map</span><span class="p">[</span><span class="n">filter_name</span><span class="p">]</span>
<a name="views.py-pyg.html-323"></a>		<span class="k">if</span> <span class="n">filter_name</span> <span class="o">==</span> <span class="s">&#39;department&#39;</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
<a name="views.py-pyg.html-324"></a>			<span class="k">return</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
<a name="views.py-pyg.html-325"></a>		<span class="k">elif</span> <span class="n">is_list</span><span class="p">:</span>
<a name="views.py-pyg.html-326"></a>			<span class="k">return</span> <span class="n">filters_map</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">filter_name</span><span class="p">)</span>
<a name="views.py-pyg.html-327"></a>		<span class="k">elif</span> <span class="n">is_boolean</span><span class="p">:</span>
<a name="views.py-pyg.html-328"></a>			<span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<a name="views.py-pyg.html-329"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-330"></a>			<span class="k">return</span> <span class="n">val</span>
<a name="views.py-pyg.html-331"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="views.py-pyg.html-332"></a>
<a name="views.py-pyg.html-333"></a><span class="k">def</span> <span class="nf">is_supported_browser</span><span class="p">():</span>
<a name="views.py-pyg.html-334"></a>	<span class="n">browser</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">browser</span>
<a name="views.py-pyg.html-335"></a>	<span class="n">version</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">version</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
<a name="views.py-pyg.html-336"></a>	<span class="n">platform</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">platform</span>
<a name="views.py-pyg.html-337"></a>	<span class="n">uas</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">string</span>
<a name="views.py-pyg.html-338"></a>	<span class="k">if</span> <span class="n">browser</span> <span class="ow">and</span> <span class="n">version</span><span class="p">:</span>
<a name="views.py-pyg.html-339"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">browser</span> <span class="o">==</span> <span class="s">&#39;msie&#39;</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> \
<a name="views.py-pyg.html-340"></a>		<span class="ow">or</span> <span class="p">(</span><span class="n">browser</span> <span class="o">==</span> <span class="s">&#39;firefox&#39;</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> \
<a name="views.py-pyg.html-341"></a>		<span class="ow">or</span> <span class="p">(</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;android&#39;</span> <span class="ow">and</span> <span class="n">browser</span> <span class="o">==</span> <span class="s">&#39;safari&#39;</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">534</span><span class="p">)</span> \
<a name="views.py-pyg.html-342"></a>		<span class="ow">or</span> <span class="p">(</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;iphone&#39;</span> <span class="ow">and</span> <span class="n">browser</span> <span class="o">==</span> <span class="s">&#39;safari&#39;</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">7000</span><span class="p">)</span> \
<a name="views.py-pyg.html-343"></a>		<span class="ow">or</span> <span class="p">((</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;macos&#39;</span> <span class="ow">or</span> <span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;windows&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">browser</span> <span class="o">==</span> <span class="s">&#39;safari&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;Mobile&#39;</span><span class="p">,</span> <span class="n">uas</span><span class="p">)</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">534</span><span class="p">)</span> \
<a name="views.py-pyg.html-344"></a>		<span class="ow">or</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;iPad&#39;</span><span class="p">,</span> <span class="n">uas</span><span class="p">)</span> <span class="ow">and</span> <span class="n">browser</span> <span class="o">==</span> <span class="s">&#39;safari&#39;</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">7000</span><span class="p">)</span> \
<a name="views.py-pyg.html-345"></a>		<span class="ow">or</span> <span class="p">(</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;windows&#39;</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;Windows Phone OS&#39;</span><span class="p">,</span> <span class="n">uas</span><span class="p">))</span> \
<a name="views.py-pyg.html-346"></a>		<span class="ow">or</span> <span class="p">(</span><span class="n">browser</span> <span class="o">==</span> <span class="s">&#39;opera&#39;</span><span class="p">)</span> \
<a name="views.py-pyg.html-347"></a>		<span class="ow">or</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;BlackBerry&#39;</span><span class="p">,</span> <span class="n">uas</span><span class="p">)):</span>
<a name="views.py-pyg.html-348"></a>			<span class="k">return</span> <span class="bp">False</span>
<a name="views.py-pyg.html-349"></a>	<span class="k">return</span> <span class="bp">False</span>
<a name="views.py-pyg.html-350"></a>
<a name="views.py-pyg.html-351"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/view_requests&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-352"></a><span class="k">def</span> <span class="nf">display_all_requests</span><span class="p">(</span><span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">]):</span>
<a name="views.py-pyg.html-353"></a>	<span class="sd">&quot;&quot;&quot; Dynamically load requests page depending on browser. &quot;&quot;&quot;</span> 
<a name="views.py-pyg.html-354"></a>	<span class="k">if</span> <span class="n">is_supported_browser</span><span class="p">():</span>
<a name="views.py-pyg.html-355"></a>		<span class="k">return</span> <span class="n">backbone_requests</span><span class="p">()</span>
<a name="views.py-pyg.html-356"></a>	<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-357"></a>		<span class="k">return</span> <span class="n">no_backbone_requests</span><span class="p">()</span>
<a name="views.py-pyg.html-358"></a>
<a name="views.py-pyg.html-359"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/view_requests_backbone&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-360"></a><span class="k">def</span> <span class="nf">backbone_requests</span><span class="p">():</span>
<a name="views.py-pyg.html-361"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;all_requests.html&quot;</span><span class="p">,</span> <span class="n">departments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Department</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">total_requests_count</span> <span class="o">=</span> <span class="n">get_count</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">))</span>
<a name="views.py-pyg.html-362"></a>
<a name="views.py-pyg.html-363"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/view_requests_no_backbone&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-364"></a><span class="k">def</span> <span class="nf">no_backbone_requests</span><span class="p">():</span>
<a name="views.py-pyg.html-365"></a>	<span class="k">return</span> <span class="n">fetch_requests</span><span class="p">()</span>
<a name="views.py-pyg.html-366"></a>
<a name="views.py-pyg.html-367"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/requests&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-368"></a><span class="k">def</span> <span class="nf">fetch_requests</span><span class="p">(</span><span class="n">output_results_only</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">filters_map</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">date_format</span> <span class="o">=</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">checkbox_value</span> <span class="o">=</span> <span class="s">&#39;on&#39;</span><span class="p">):</span>
<a name="views.py-pyg.html-369"></a>
<a name="views.py-pyg.html-370"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">()</span>
<a name="views.py-pyg.html-371"></a>
<a name="views.py-pyg.html-372"></a>	<span class="k">if</span> <span class="ow">not</span> <span class="n">filters_map</span><span class="p">:</span>
<a name="views.py-pyg.html-373"></a>		<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span> 
<a name="views.py-pyg.html-374"></a>			<span class="k">if</span> <span class="n">is_supported_browser</span><span class="p">():</span>
<a name="views.py-pyg.html-375"></a>				<span class="k">return</span> <span class="n">backbone_requests</span><span class="p">()</span>
<a name="views.py-pyg.html-376"></a>			<span class="k">else</span><span class="p">:</span> <span class="c"># Clear URL</span>
<a name="views.py-pyg.html-377"></a>				<span class="n">filters_map</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span>
<a name="views.py-pyg.html-378"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-379"></a>			<span class="n">filters_map</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>
<a name="views.py-pyg.html-380"></a>
<a name="views.py-pyg.html-381"></a>	<span class="c"># Set defaults </span>
<a name="views.py-pyg.html-382"></a>	<span class="n">is_open</span> <span class="o">=</span> <span class="n">checkbox_value</span>
<a name="views.py-pyg.html-383"></a>	<span class="n">is_closed</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-384"></a>	<span class="n">due_soon</span> <span class="o">=</span> <span class="n">checkbox_value</span>
<a name="views.py-pyg.html-385"></a>	<span class="n">overdue</span> <span class="o">=</span> <span class="n">checkbox_value</span>
<a name="views.py-pyg.html-386"></a>	<span class="n">mine_as_poc</span> <span class="o">=</span> <span class="n">checkbox_value</span>
<a name="views.py-pyg.html-387"></a>	<span class="n">mine_as_helper</span> <span class="o">=</span> <span class="n">checkbox_value</span>
<a name="views.py-pyg.html-388"></a>	<span class="n">departments_selected</span> <span class="o">=</span> <span class="p">[]</span>
<a name="views.py-pyg.html-389"></a>	<span class="n">sort_column</span> <span class="o">=</span> <span class="s">&quot;id&quot;</span>
<a name="views.py-pyg.html-390"></a>	<span class="n">sort_direction</span> <span class="o">=</span> <span class="s">&quot;asc&quot;</span>
<a name="views.py-pyg.html-391"></a>	<span class="n">min_due_date</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-392"></a>	<span class="n">max_due_date</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-393"></a>	<span class="n">min_date_received</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-394"></a>	<span class="n">max_date_received</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-395"></a>	<span class="n">requester_name</span> <span class="o">=</span> <span class="bp">None</span> 
<a name="views.py-pyg.html-396"></a>	<span class="n">page_number</span> <span class="o">=</span> <span class="mi">1</span>
<a name="views.py-pyg.html-397"></a>	<span class="n">search_term</span> <span class="o">=</span> <span class="bp">None</span>
<a name="views.py-pyg.html-398"></a>
<a name="views.py-pyg.html-399"></a>	<span class="k">if</span> <span class="n">filters_map</span><span class="p">:</span>
<a name="views.py-pyg.html-400"></a>		<span class="n">departments_selected</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span> <span class="o">=</span> <span class="n">filters_map</span><span class="p">,</span> <span class="n">filter_name</span> <span class="o">=</span> <span class="s">&#39;departments_selected&#39;</span><span class="p">,</span> <span class="n">is_list</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;department&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-401"></a>		<span class="n">is_open</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span> <span class="o">=</span> <span class="n">filters_map</span><span class="p">,</span> <span class="n">filter_name</span> <span class="o">=</span> <span class="s">&#39;is_open&#39;</span><span class="p">,</span> <span class="n">is_boolean</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-402"></a>		<span class="n">is_closed</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span> <span class="o">=</span> <span class="n">filters_map</span><span class="p">,</span> <span class="n">filter_name</span> <span class="o">=</span> <span class="s">&#39;is_closed&#39;</span><span class="p">,</span> <span class="n">is_boolean</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-403"></a>		<span class="n">due_soon</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span> <span class="o">=</span> <span class="n">filters_map</span><span class="p">,</span> <span class="n">filter_name</span> <span class="o">=</span> <span class="s">&#39;due_soon&#39;</span><span class="p">,</span> <span class="n">is_boolean</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-404"></a>		<span class="n">overdue</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span> <span class="o">=</span> <span class="n">filters_map</span><span class="p">,</span> <span class="n">filter_name</span> <span class="o">=</span> <span class="s">&#39;overdue&#39;</span><span class="p">,</span> <span class="n">is_boolean</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-405"></a>		<span class="n">mine_as_poc</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span> <span class="o">=</span> <span class="n">filters_map</span><span class="p">,</span> <span class="n">filter_name</span> <span class="o">=</span> <span class="s">&#39;mine_as_poc&#39;</span><span class="p">,</span> <span class="n">is_boolean</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-406"></a>		<span class="n">mine_as_helper</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span> <span class="o">=</span> <span class="n">filters_map</span><span class="p">,</span> <span class="n">filter_name</span> <span class="o">=</span> <span class="s">&#39;mine_as_helper&#39;</span><span class="p">,</span> <span class="n">is_boolean</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-407"></a>		<span class="n">sort_column</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;sort_column&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;id&#39;</span>
<a name="views.py-pyg.html-408"></a>		<span class="n">sort_direction</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;sort_direction&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;asc&#39;</span>
<a name="views.py-pyg.html-409"></a>		<span class="n">search_term</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;search_term&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-410"></a>		<span class="n">min_due_date</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;min_due_date&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-411"></a>		<span class="n">max_due_date</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;max_due_date&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-412"></a>		<span class="n">min_date_received</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;min_date_received&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-413"></a>		<span class="n">max_date_received</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;max_date_received&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-414"></a>		<span class="n">requester_name</span> <span class="o">=</span> <span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;requester_name&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-415"></a>		<span class="n">page_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_filter_value</span><span class="p">(</span><span class="n">filters_map</span><span class="p">,</span> <span class="s">&#39;page_number&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;1&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-416"></a>
<a name="views.py-pyg.html-417"></a>
<a name="views.py-pyg.html-418"></a>	<span class="n">results</span> <span class="o">=</span> <span class="n">get_results_by_filters</span><span class="p">(</span><span class="n">departments_selected</span> <span class="o">=</span> <span class="n">departments_selected</span><span class="p">,</span> <span class="n">is_open</span> <span class="o">=</span> <span class="n">is_open</span><span class="p">,</span> <span class="n">is_closed</span> <span class="o">=</span> <span class="n">is_closed</span><span class="p">,</span> <span class="n">due_soon</span> <span class="o">=</span> <span class="n">due_soon</span><span class="p">,</span> <span class="n">overdue</span> <span class="o">=</span> <span class="n">overdue</span><span class="p">,</span> <span class="n">mine_as_poc</span> <span class="o">=</span> <span class="n">mine_as_poc</span><span class="p">,</span> <span class="n">mine_as_helper</span> <span class="o">=</span> <span class="n">mine_as_helper</span><span class="p">,</span> <span class="n">sort_column</span> <span class="o">=</span> <span class="n">sort_column</span><span class="p">,</span> <span class="n">sort_direction</span> <span class="o">=</span> <span class="n">sort_direction</span><span class="p">,</span> <span class="n">search_term</span> <span class="o">=</span> <span class="n">search_term</span><span class="p">,</span> <span class="n">min_due_date</span> <span class="o">=</span> <span class="n">min_due_date</span><span class="p">,</span> <span class="n">max_due_date</span> <span class="o">=</span> <span class="n">max_due_date</span><span class="p">,</span> <span class="n">min_date_received</span> <span class="o">=</span> <span class="n">min_date_received</span><span class="p">,</span> <span class="n">max_date_received</span> <span class="o">=</span> <span class="n">max_date_received</span><span class="p">,</span> <span class="n">requester_name</span> <span class="o">=</span> <span class="n">requester_name</span><span class="p">,</span> <span class="n">page_number</span> <span class="o">=</span> <span class="n">page_number</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">date_format</span> <span class="o">=</span> <span class="n">date_format</span><span class="p">,</span> <span class="n">checkbox_value</span> <span class="o">=</span> <span class="n">checkbox_value</span><span class="p">)</span>
<a name="views.py-pyg.html-419"></a>
<a name="views.py-pyg.html-420"></a>	<span class="c"># Execute query</span>
<a name="views.py-pyg.html-421"></a>	<span class="n">limit</span> <span class="o">=</span> <span class="mi">15</span>
<a name="views.py-pyg.html-422"></a>	<span class="n">offset</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">*</span> <span class="p">(</span><span class="n">page_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<a name="views.py-pyg.html-423"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Page Number: {0}, Limit: {1}, Offset: {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">page_number</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
<a name="views.py-pyg.html-424"></a>	<span class="n">more_results</span> <span class="o">=</span> <span class="bp">False</span>
<a name="views.py-pyg.html-425"></a>	<span class="n">num_results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a name="views.py-pyg.html-426"></a>	<span class="n">start_index</span> <span class="o">=</span> <span class="mi">0</span>
<a name="views.py-pyg.html-427"></a>	<span class="n">end_index</span> <span class="o">=</span> <span class="mi">0</span>
<a name="views.py-pyg.html-428"></a>
<a name="views.py-pyg.html-429"></a>	<span class="k">if</span> <span class="n">num_results</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<a name="views.py-pyg.html-430"></a>		<span class="n">start_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">limit</span>
<a name="views.py-pyg.html-431"></a>		<span class="k">if</span> <span class="n">start_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a name="views.py-pyg.html-432"></a>			<span class="n">start_index</span> <span class="o">=</span> <span class="mi">1</span>
<a name="views.py-pyg.html-433"></a>		<span class="k">if</span> <span class="n">num_results</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">limit</span> <span class="o">*</span> <span class="n">page_number</span><span class="p">):</span>
<a name="views.py-pyg.html-434"></a>			<span class="n">more_results</span> <span class="o">=</span> <span class="bp">True</span>
<a name="views.py-pyg.html-435"></a>			<span class="n">end_index</span> <span class="o">=</span> <span class="n">start_index</span> <span class="o">+</span> <span class="mi">14</span>
<a name="views.py-pyg.html-436"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-437"></a>			<span class="n">end_index</span> <span class="o">=</span> <span class="n">num_results</span>
<a name="views.py-pyg.html-438"></a>
<a name="views.py-pyg.html-439"></a>	<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="views.py-pyg.html-440"></a>	<span class="n">requests</span> <span class="o">=</span> <span class="n">prepare_request_fields</span><span class="p">(</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">)</span>
<a name="views.py-pyg.html-441"></a>	<span class="k">if</span> <span class="n">output_results_only</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
<a name="views.py-pyg.html-442"></a>		<span class="k">return</span> <span class="n">requests</span><span class="p">,</span> <span class="n">num_results</span><span class="p">,</span> <span class="n">more_results</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span>
<a name="views.py-pyg.html-443"></a>
<a name="views.py-pyg.html-444"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;all_requests_less_js.html&quot;</span><span class="p">,</span> <span class="n">total_requests_count</span> <span class="o">=</span> <span class="n">get_count</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">),</span> <span class="n">requests</span> <span class="o">=</span> <span class="n">requests</span><span class="p">,</span> <span class="n">departments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Department</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">departments_selected</span> <span class="o">=</span> <span class="n">departments_selected</span><span class="p">,</span> <span class="n">is_open</span> <span class="o">=</span> <span class="n">is_open</span><span class="p">,</span> <span class="n">is_closed</span> <span class="o">=</span> <span class="n">is_closed</span><span class="p">,</span> <span class="n">due_soon</span> <span class="o">=</span> <span class="n">due_soon</span><span class="p">,</span> <span class="n">overdue</span> <span class="o">=</span> <span class="n">overdue</span><span class="p">,</span> <span class="n">mine_as_poc</span> <span class="o">=</span> <span class="n">mine_as_poc</span><span class="p">,</span> <span class="n">mine_as_helper</span> <span class="o">=</span> <span class="n">mine_as_helper</span><span class="p">,</span> <span class="n">sort_column</span> <span class="o">=</span> <span class="n">sort_column</span><span class="p">,</span> <span class="n">sort_direction</span> <span class="o">=</span> <span class="n">sort_direction</span><span class="p">,</span> <span class="n">search_term</span> <span class="o">=</span> <span class="n">search_term</span><span class="p">,</span> <span class="n">min_due_date</span> <span class="o">=</span> <span class="n">min_due_date</span><span class="p">,</span> <span class="n">max_due_date</span> <span class="o">=</span> <span class="n">max_due_date</span><span class="p">,</span> <span class="n">min_date_received</span> <span class="o">=</span> <span class="n">min_date_received</span><span class="p">,</span> <span class="n">max_date_received</span> <span class="o">=</span> <span class="n">max_date_received</span><span class="p">,</span> <span class="n">requester_name</span> <span class="o">=</span> <span class="n">requester_name</span><span class="p">,</span> <span class="n">page_number</span> <span class="o">=</span> <span class="n">page_number</span><span class="p">,</span> <span class="n">more_results</span> <span class="o">=</span> <span class="n">more_results</span><span class="p">,</span> <span class="n">num_results</span> <span class="o">=</span> <span class="n">num_results</span><span class="p">,</span> <span class="n">start_index</span> <span class="o">=</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span> <span class="o">=</span> <span class="n">end_index</span><span class="p">)</span>
<a name="views.py-pyg.html-445"></a>
<a name="views.py-pyg.html-446"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/custom/request&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-447"></a><span class="k">def</span> <span class="nf">json_requests</span><span class="p">():</span>
<a name="views.py-pyg.html-448"></a>	<span class="sd">&quot;&quot;&quot;</span>
<a name="views.py-pyg.html-449"></a><span class="sd">	Ultra-custom API endpoint for serving up requests.</span>
<a name="views.py-pyg.html-450"></a><span class="sd">	Supports limit, search, and page parameters and returns json with an object that</span>
<a name="views.py-pyg.html-451"></a><span class="sd">	has a list of results in the &#39;objects&#39; field.</span>
<a name="views.py-pyg.html-452"></a><span class="sd">	&quot;&quot;&quot;</span>
<a name="views.py-pyg.html-453"></a>	<span class="n">objects</span><span class="p">,</span> <span class="n">num_results</span><span class="p">,</span> <span class="n">more_results</span><span class="p">,</span> <span class="n">start_index</span><span class="p">,</span> <span class="n">end_index</span> <span class="o">=</span> <span class="n">fetch_requests</span><span class="p">(</span><span class="n">output_results_only</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">filters_map</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">date_format</span> <span class="o">=</span> <span class="s">&#39;%m/</span><span class="si">%d</span><span class="s">/%Y&#39;</span><span class="p">,</span> <span class="n">checkbox_value</span> <span class="o">=</span> <span class="s">&#39;true&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-454"></a>	<span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
<a name="views.py-pyg.html-455"></a>		<span class="s">&quot;objects&quot;</span><span class="p">:</span> 		<span class="n">objects</span><span class="p">,</span>
<a name="views.py-pyg.html-456"></a>		<span class="s">&quot;num_results&quot;</span><span class="p">:</span> 	<span class="n">num_results</span><span class="p">,</span>
<a name="views.py-pyg.html-457"></a>		<span class="s">&quot;more_results&quot;</span><span class="p">:</span> <span class="n">more_results</span><span class="p">,</span>
<a name="views.py-pyg.html-458"></a>		<span class="s">&quot;start_index&quot;</span><span class="p">:</span> 	<span class="n">start_index</span><span class="p">,</span>
<a name="views.py-pyg.html-459"></a>		<span class="s">&quot;end_index&quot;</span><span class="p">:</span> 	<span class="n">end_index</span>
<a name="views.py-pyg.html-460"></a>		<span class="p">}</span>
<a name="views.py-pyg.html-461"></a>	<span class="n">response</span> <span class="o">=</span> <span class="n">anyjson</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
<a name="views.py-pyg.html-462"></a>	<span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">mimetype</span> <span class="o">=</span> <span class="s">&quot;application/json&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-463"></a>
<a name="views.py-pyg.html-464"></a><span class="k">def</span> <span class="nf">prepare_request_fields</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
<a name="views.py-pyg.html-465"></a>	<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">():</span>
<a name="views.py-pyg.html-466"></a>		<span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">{</span>     
<a name="views.py-pyg.html-467"></a>			  <span class="s">&quot;id&quot;</span><span class="p">:</span>           <span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> \
<a name="views.py-pyg.html-468"></a>			  <span class="s">&quot;text&quot;</span><span class="p">:</span>         <span class="n">helpers</span><span class="o">.</span><span class="n">clean_text</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> \
<a name="views.py-pyg.html-469"></a>			  <span class="s">&quot;date_received&quot;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">date_received</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">date_created</span><span class="p">),</span> \
<a name="views.py-pyg.html-470"></a>			  <span class="s">&quot;department&quot;</span><span class="p">:</span>   <span class="n">r</span><span class="o">.</span><span class="n">department_name</span><span class="p">(),</span> \
<a name="views.py-pyg.html-471"></a>			  <span class="s">&quot;status&quot;</span><span class="p">:</span>       <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> \
<a name="views.py-pyg.html-472"></a>			  <span class="c"># The following two attributes are defined as model methods,</span>
<a name="views.py-pyg.html-473"></a>			  <span class="c"># and not regular SQLAlchemy attributes.</span>
<a name="views.py-pyg.html-474"></a>			  <span class="s">&quot;contact_name&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">point_person_name</span><span class="p">(),</span> \
<a name="views.py-pyg.html-475"></a>			  <span class="s">&quot;solid_status&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">solid_status</span><span class="p">()</span>
<a name="views.py-pyg.html-476"></a>			   <span class="p">},</span> <span class="n">results</span><span class="p">)</span>
<a name="views.py-pyg.html-477"></a>	<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-478"></a>		<span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">{</span>     
<a name="views.py-pyg.html-479"></a>			  <span class="s">&quot;id&quot;</span><span class="p">:</span>           <span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> \
<a name="views.py-pyg.html-480"></a>			  <span class="s">&quot;text&quot;</span><span class="p">:</span>         <span class="n">helpers</span><span class="o">.</span><span class="n">clean_text</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> \
<a name="views.py-pyg.html-481"></a>			  <span class="s">&quot;date_received&quot;</span><span class="p">:</span> <span class="n">helpers</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">date_received</span> <span class="ow">or</span> <span class="n">r</span><span class="o">.</span><span class="n">date_created</span><span class="p">),</span> \
<a name="views.py-pyg.html-482"></a>			  <span class="s">&quot;department&quot;</span><span class="p">:</span>   <span class="n">r</span><span class="o">.</span><span class="n">department_name</span><span class="p">(),</span> \
<a name="views.py-pyg.html-483"></a>			  <span class="s">&quot;requester&quot;</span><span class="p">:</span>    <span class="n">r</span><span class="o">.</span><span class="n">requester_name</span><span class="p">(),</span> \
<a name="views.py-pyg.html-484"></a>			  <span class="s">&quot;due_date&quot;</span><span class="p">:</span>     <span class="n">format_date</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">due_date</span><span class="p">),</span> \
<a name="views.py-pyg.html-485"></a>			  <span class="s">&quot;status&quot;</span><span class="p">:</span>       <span class="n">r</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> \
<a name="views.py-pyg.html-486"></a>			  <span class="c"># The following two attributes are defined as model methods,</span>
<a name="views.py-pyg.html-487"></a>			  <span class="c"># and not regular SQLAlchemy attributes.</span>
<a name="views.py-pyg.html-488"></a>			  <span class="s">&quot;contact_name&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">point_person_name</span><span class="p">(),</span> \
<a name="views.py-pyg.html-489"></a>			  <span class="s">&quot;solid_status&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">solid_status</span><span class="p">()</span>
<a name="views.py-pyg.html-490"></a>			   <span class="p">},</span> <span class="n">results</span><span class="p">)</span>
<a name="views.py-pyg.html-491"></a>
<a name="views.py-pyg.html-492"></a>
<a name="views.py-pyg.html-493"></a><span class="k">def</span> <span class="nf">get_results_by_filters</span><span class="p">(</span><span class="n">departments_selected</span><span class="p">,</span> <span class="n">is_open</span><span class="p">,</span> <span class="n">is_closed</span><span class="p">,</span> <span class="n">due_soon</span><span class="p">,</span> <span class="n">overdue</span><span class="p">,</span> <span class="n">mine_as_poc</span><span class="p">,</span> <span class="n">mine_as_helper</span><span class="p">,</span> <span class="n">sort_column</span><span class="p">,</span> <span class="n">sort_direction</span><span class="p">,</span> <span class="n">search_term</span><span class="p">,</span> <span class="n">min_due_date</span><span class="p">,</span> <span class="n">max_due_date</span><span class="p">,</span> <span class="n">min_date_received</span><span class="p">,</span> <span class="n">max_date_received</span><span class="p">,</span> <span class="n">requester_name</span><span class="p">,</span> <span class="n">page_number</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">date_format</span><span class="p">,</span> <span class="n">checkbox_value</span><span class="p">):</span>
<a name="views.py-pyg.html-494"></a>	<span class="c"># Initialize query</span>
<a name="views.py-pyg.html-495"></a>	<span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span>
<a name="views.py-pyg.html-496"></a>
<a name="views.py-pyg.html-497"></a>	<span class="c"># Set filters on the query</span>
<a name="views.py-pyg.html-498"></a>
<a name="views.py-pyg.html-499"></a>	<span class="n">results</span> <span class="o">=</span> <span class="n">filter_department</span><span class="p">(</span><span class="n">departments_selected</span> <span class="o">=</span> <span class="n">departments_selected</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">)</span>
<a name="views.py-pyg.html-500"></a>	<span class="n">results</span> <span class="o">=</span> <span class="n">filter_search_term</span><span class="p">(</span><span class="n">search_input</span> <span class="o">=</span> <span class="n">search_term</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">)</span>
<a name="views.py-pyg.html-501"></a>
<a name="views.py-pyg.html-502"></a>	<span class="c"># Accumulate status filters</span>
<a name="views.py-pyg.html-503"></a>	<span class="n">status_filters</span> <span class="o">=</span> <span class="p">[]</span>
<a name="views.py-pyg.html-504"></a>
<a name="views.py-pyg.html-505"></a>	<span class="k">if</span> <span class="n">is_open</span> <span class="o">==</span> <span class="n">checkbox_value</span><span class="p">:</span>
<a name="views.py-pyg.html-506"></a>		<span class="n">status_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">open</span><span class="p">)</span>
<a name="views.py-pyg.html-507"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
<a name="views.py-pyg.html-508"></a>			<span class="n">status_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">due_soon</span><span class="p">)</span>
<a name="views.py-pyg.html-509"></a>			<span class="n">status_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">overdue</span><span class="p">)</span>
<a name="views.py-pyg.html-510"></a>
<a name="views.py-pyg.html-511"></a>	<span class="k">if</span> <span class="n">is_closed</span> <span class="o">==</span> <span class="n">checkbox_value</span><span class="p">:</span>
<a name="views.py-pyg.html-512"></a>		<span class="n">status_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
<a name="views.py-pyg.html-513"></a>
<a name="views.py-pyg.html-514"></a>	<span class="k">if</span> <span class="n">min_date_received</span> <span class="ow">and</span> <span class="n">max_date_received</span> <span class="ow">and</span> <span class="n">min_date_received</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="n">max_date_received</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-515"></a>		<span class="k">try</span><span class="p">:</span>
<a name="views.py-pyg.html-516"></a>			<span class="n">min_date_received</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">min_date_received</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span>
<a name="views.py-pyg.html-517"></a>			<span class="n">max_date_received</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">max_date_received</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="mi">59</span><span class="p">)</span> 
<a name="views.py-pyg.html-518"></a>			<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">date_received</span> <span class="o">&gt;=</span> <span class="n">min_date_received</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">date_received</span> <span class="o">&lt;=</span> <span class="n">max_date_received</span><span class="p">))</span>
<a name="views.py-pyg.html-519"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Request Date Bounding. Min: {0}, Max: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_date_received</span><span class="p">,</span> <span class="n">max_date_received</span><span class="p">))</span>
<a name="views.py-pyg.html-520"></a>		<span class="k">except</span><span class="p">:</span>
<a name="views.py-pyg.html-521"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;There was an error parsing the request date filters. Received Min: {0}, Max {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_date_received</span><span class="p">,</span> <span class="n">max_date_received</span><span class="p">))</span>
<a name="views.py-pyg.html-522"></a>
<a name="views.py-pyg.html-523"></a>
<a name="views.py-pyg.html-524"></a>	<span class="c"># Filters for agency staff only:</span>
<a name="views.py-pyg.html-525"></a>	<span class="k">if</span> <span class="n">user_id</span><span class="p">:</span>
<a name="views.py-pyg.html-526"></a>
<a name="views.py-pyg.html-527"></a>		<span class="k">if</span> <span class="n">due_soon</span> <span class="o">==</span> <span class="n">checkbox_value</span><span class="p">:</span>
<a name="views.py-pyg.html-528"></a>			<span class="n">status_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">due_soon</span><span class="p">)</span>
<a name="views.py-pyg.html-529"></a>
<a name="views.py-pyg.html-530"></a>		<span class="k">if</span> <span class="n">overdue</span> <span class="o">==</span> <span class="n">checkbox_value</span><span class="p">:</span>
<a name="views.py-pyg.html-531"></a>			<span class="n">status_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">overdue</span><span class="p">)</span>
<a name="views.py-pyg.html-532"></a>
<a name="views.py-pyg.html-533"></a>		<span class="k">if</span> <span class="n">min_due_date</span> <span class="ow">and</span> <span class="n">max_due_date</span> <span class="ow">and</span> <span class="n">min_due_date</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span> <span class="ow">and</span> <span class="n">max_due_date</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-534"></a>			<span class="k">try</span><span class="p">:</span>
<a name="views.py-pyg.html-535"></a>				<span class="n">min_due_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">min_due_date</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span>
<a name="views.py-pyg.html-536"></a>				<span class="n">max_due_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">max_due_date</span><span class="p">,</span> <span class="n">date_format</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="mi">59</span><span class="p">)</span>  
<a name="views.py-pyg.html-537"></a>				<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">due_date</span> <span class="o">&gt;=</span> <span class="n">min_due_date</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">due_date</span> <span class="o">&lt;=</span> <span class="n">max_due_date</span><span class="p">))</span>
<a name="views.py-pyg.html-538"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Due Date Bounding. Min: {0}, Max: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_due_date</span><span class="p">,</span> <span class="n">max_due_date</span><span class="p">))</span>
<a name="views.py-pyg.html-539"></a>			<span class="k">except</span><span class="p">:</span>
<a name="views.py-pyg.html-540"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;There was an error parsing the due date filters. Due Date Min: {0}, Max {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_due_date</span><span class="p">,</span> <span class="n">max_due_date</span><span class="p">))</span>
<a name="views.py-pyg.html-541"></a>
<a name="views.py-pyg.html-542"></a>		<span class="c"># PoC and Helper filters</span>
<a name="views.py-pyg.html-543"></a>		<span class="k">if</span> <span class="n">mine_as_poc</span> <span class="o">==</span> <span class="n">checkbox_value</span><span class="p">:</span> 
<a name="views.py-pyg.html-544"></a>			<span class="k">if</span> <span class="n">mine_as_helper</span> <span class="o">==</span> <span class="n">checkbox_value</span><span class="p">:</span>
<a name="views.py-pyg.html-545"></a>				<span class="c"># Where am I the Point of Contact *or* the Helper?</span>
<a name="views.py-pyg.html-546"></a>				<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">request_id</span><span class="p">)</span> \
<a name="views.py-pyg.html-547"></a>								 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span> \
<a name="views.py-pyg.html-548"></a>								 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-549"></a>			<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-550"></a>				<span class="c"># Where am I the Point of Contact only?</span>
<a name="views.py-pyg.html-551"></a>				<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">request_id</span><span class="p">)</span> \
<a name="views.py-pyg.html-552"></a>								 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span> \
<a name="views.py-pyg.html-553"></a>								 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">is_point_person</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span>
<a name="views.py-pyg.html-554"></a>		<span class="k">elif</span> <span class="n">mine_as_helper</span> <span class="o">==</span> <span class="n">checkbox_value</span><span class="p">:</span>
<a name="views.py-pyg.html-555"></a>				<span class="c"># Where am I a Helper only?</span>
<a name="views.py-pyg.html-556"></a>				<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">Owner</span><span class="o">.</span><span class="n">request_id</span><span class="p">)</span> \
<a name="views.py-pyg.html-557"></a>								 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span> \
<a name="views.py-pyg.html-558"></a>								 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> \
<a name="views.py-pyg.html-559"></a>								 <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Owner</span><span class="o">.</span><span class="n">is_point_person</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span>
<a name="views.py-pyg.html-560"></a>		<span class="c"># Filter based on requester name</span>
<a name="views.py-pyg.html-561"></a>		<span class="n">requester_name</span> <span class="o">=</span> <span class="n">requester_name</span>
<a name="views.py-pyg.html-562"></a>		<span class="k">if</span> <span class="n">requester_name</span> <span class="ow">and</span> <span class="n">requester_name</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-563"></a>			<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">subscribers</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">User</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%%%s%%</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">requester_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
<a name="views.py-pyg.html-564"></a>			
<a name="views.py-pyg.html-565"></a>	<span class="c"># Apply the set of status filters to the query.</span>
<a name="views.py-pyg.html-566"></a>	<span class="c"># Using &#39;or&#39;, they&#39;re non-exclusive!</span>
<a name="views.py-pyg.html-567"></a>	<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">status_filters</span><span class="p">))</span>
<a name="views.py-pyg.html-568"></a>
<a name="views.py-pyg.html-569"></a>	<span class="k">if</span> <span class="n">sort_column</span><span class="p">:</span>
<a name="views.py-pyg.html-570"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Sort Direction: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sort_direction</span><span class="p">)</span>
<a name="views.py-pyg.html-571"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Sort Column: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sort_column</span><span class="p">)</span>
<a name="views.py-pyg.html-572"></a>		<span class="k">if</span> <span class="n">sort_direction</span> <span class="o">==</span> <span class="s">&quot;desc&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-573"></a>			<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">order_by</span><span class="p">((</span><span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">sort_column</span><span class="p">))</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<a name="views.py-pyg.html-574"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-575"></a>			<span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">order_by</span><span class="p">((</span><span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">sort_column</span><span class="p">))</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
<a name="views.py-pyg.html-576"></a>
<a name="views.py-pyg.html-577"></a>	<span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<a name="views.py-pyg.html-578"></a>
<a name="views.py-pyg.html-579"></a>
<a name="views.py-pyg.html-580"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&lt;page&gt;&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-581"></a><span class="k">def</span> <span class="nf">any_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
<a name="views.py-pyg.html-582"></a>	<span class="k">try</span><span class="p">:</span>
<a name="views.py-pyg.html-583"></a>		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.html&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
<a name="views.py-pyg.html-584"></a>	<span class="k">except</span><span class="p">:</span>
<a name="views.py-pyg.html-585"></a>		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> totally doesn&#39;t exist.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">page</span><span class="p">))</span>
<a name="views.py-pyg.html-586"></a>
<a name="views.py-pyg.html-587"></a><span class="k">def</span> <span class="nf">tutorial</span><span class="p">():</span>
<a name="views.py-pyg.html-588"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_id</span><span class="p">()</span>
<a name="views.py-pyg.html-589"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Tutorial accessed by user: </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">user_id</span><span class="p">)</span>
<a name="views.py-pyg.html-590"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;tutorial.html&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-591"></a>
<a name="views.py-pyg.html-592"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/staff_card/&lt;int:user_id&gt;&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-593"></a><span class="k">def</span> <span class="nf">staff_card</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
<a name="views.py-pyg.html-594"></a>	<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;staff_card.html&#39;</span><span class="p">,</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">user_id</span><span class="p">)</span>
<a name="views.py-pyg.html-595"></a>
<a name="views.py-pyg.html-596"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/logout&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-597"></a><span class="nd">@login_required</span>
<a name="views.py-pyg.html-598"></a><span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
<a name="views.py-pyg.html-599"></a>	<span class="n">logout_user</span><span class="p">()</span>
<a name="views.py-pyg.html-600"></a>	<span class="k">return</span> <span class="n">index</span><span class="p">()</span>
<a name="views.py-pyg.html-601"></a>
<a name="views.py-pyg.html-602"></a><span class="k">def</span> <span class="nf">get_user_id</span><span class="p">():</span>
<a name="views.py-pyg.html-603"></a>	<span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
<a name="views.py-pyg.html-604"></a>		<span class="k">return</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span>
<a name="views.py-pyg.html-605"></a>	<span class="k">return</span> <span class="bp">None</span>
<a name="views.py-pyg.html-606"></a>
<a name="views.py-pyg.html-607"></a><span class="c"># Used as AJAX POST endpoint to check if new request text contains certain keyword</span>
<a name="views.py-pyg.html-608"></a><span class="c"># See new_requests.(html/js)</span>
<a name="views.py-pyg.html-609"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/is_public_record&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-610"></a><span class="k">def</span> <span class="nf">is_public_record</span><span class="p">():</span>
<a name="views.py-pyg.html-611"></a>	<span class="n">request_text</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;request_text&#39;</span><span class="p">]</span>
<a name="views.py-pyg.html-612"></a>	<span class="n">not_records_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s">&#39;static/json/notcityrecords.json&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-613"></a>	<span class="n">not_records_json</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">not_records_filepath</span><span class="p">)</span>
<a name="views.py-pyg.html-614"></a>	<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">not_records_json</span><span class="p">)</span>
<a name="views.py-pyg.html-615"></a>	<span class="n">request_text</span> <span class="o">=</span> <span class="n">request_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a name="views.py-pyg.html-616"></a>	<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Someone input </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">request_text</span><span class="p">))</span>
<a name="views.py-pyg.html-617"></a>	<span class="k">if</span> <span class="s">&quot;birth&quot;</span> <span class="ow">in</span> <span class="n">request_text</span> <span class="ow">or</span> <span class="s">&quot;death&quot;</span> <span class="ow">in</span> <span class="n">request_text</span> <span class="ow">or</span> <span class="s">&quot;marriage&quot;</span> <span class="ow">in</span> <span class="n">request_text</span><span class="p">:</span>
<a name="views.py-pyg.html-618"></a>		<span class="k">return</span> <span class="n">json_data</span><span class="p">[</span><span class="s">&quot;Certificate&quot;</span><span class="p">]</span>
<a name="views.py-pyg.html-619"></a>	<span class="k">if</span> <span class="s">&quot;divorce&quot;</span> <span class="ow">in</span> <span class="n">request_text</span><span class="p">:</span>
<a name="views.py-pyg.html-620"></a>		<span class="k">return</span> <span class="n">json_data</span><span class="p">[</span><span class="s">&quot;Divorce&quot;</span><span class="p">]</span>
<a name="views.py-pyg.html-621"></a>	<span class="k">return</span> <span class="s">&#39;&#39;</span>
<a name="views.py-pyg.html-622"></a>
<a name="views.py-pyg.html-623"></a><span class="k">def</span> <span class="nf">get_redirect_target</span><span class="p">():</span>
<a name="views.py-pyg.html-624"></a>	<span class="sd">&quot;&quot;&quot; Taken from http://flask.pocoo.org/snippets/62/ &quot;&quot;&quot;</span>
<a name="views.py-pyg.html-625"></a>	<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;next&#39;</span><span class="p">),</span> <span class="n">request</span><span class="o">.</span><span class="n">referrer</span><span class="p">:</span>
<a name="views.py-pyg.html-626"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
<a name="views.py-pyg.html-627"></a>			<span class="k">continue</span>
<a name="views.py-pyg.html-628"></a>		<span class="k">if</span> <span class="n">is_safe_url</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
<a name="views.py-pyg.html-629"></a>			<span class="k">return</span> <span class="n">target</span>
<a name="views.py-pyg.html-630"></a>
<a name="views.py-pyg.html-631"></a><span class="k">def</span> <span class="nf">is_safe_url</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
<a name="views.py-pyg.html-632"></a>	<span class="sd">&quot;&quot;&quot; Taken from http://flask.pocoo.org/snippets/62/ &quot;&quot;&quot;</span>
<a name="views.py-pyg.html-633"></a>	<span class="n">ref_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">host_url</span><span class="p">)</span>
<a name="views.py-pyg.html-634"></a>	<span class="n">test_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">host_url</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
<a name="views.py-pyg.html-635"></a>	<span class="k">return</span> <span class="n">test_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;http&#39;</span><span class="p">,</span> <span class="s">&#39;https&#39;</span><span class="p">)</span> <span class="ow">and</span> \
<a name="views.py-pyg.html-636"></a>		<span class="n">ref_url</span><span class="o">.</span><span class="n">netloc</span> <span class="o">==</span> <span class="n">test_url</span><span class="o">.</span><span class="n">netloc</span>
<a name="views.py-pyg.html-637"></a>
<a name="views.py-pyg.html-638"></a>
<a name="views.py-pyg.html-639"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/recaptcha_&lt;string:templatetype&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;POST&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-640"></a><span class="k">def</span> <span class="nf">recaptcha_templatetype</span><span class="p">(</span><span class="n">templatetype</span><span class="p">):</span>
<a name="views.py-pyg.html-641"></a>	<span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
<a name="views.py-pyg.html-642"></a>		<span class="n">template</span> <span class="o">=</span> <span class="s">&quot;recaptcha_&quot;</span> <span class="o">+</span> <span class="n">templatetype</span> <span class="o">+</span> <span class="s">&quot;.html&quot;</span>
<a name="views.py-pyg.html-643"></a>		<span class="n">response</span> <span class="o">=</span> <span class="n">captcha</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
<a name="views.py-pyg.html-644"></a>			<span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;recaptcha_challenge_field&#39;</span><span class="p">],</span>
<a name="views.py-pyg.html-645"></a>			<span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;recaptcha_response_field&#39;</span><span class="p">],</span>
<a name="views.py-pyg.html-646"></a>			<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;RECAPTCHA_PRIVATE_KEY&#39;</span><span class="p">],</span>
<a name="views.py-pyg.html-647"></a>			<span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span>
<a name="views.py-pyg.html-648"></a>			<span class="p">)</span>
<a name="views.py-pyg.html-649"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
<a name="views.py-pyg.html-650"></a>			<span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Invalid. Please try again.&quot;</span>
<a name="views.py-pyg.html-651"></a>			<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">,</span> <span class="n">form</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
<a name="views.py-pyg.html-652"></a>		<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-653"></a>			<span class="k">if</span> <span class="n">templatetype</span> <span class="o">==</span> <span class="s">&quot;note&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-654"></a>				<span class="k">return</span> <span class="n">public_add_a_resource</span><span class="p">(</span><span class="n">passed_recaptcha</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">resource</span> <span class="o">=</span> <span class="s">&quot;note&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-655"></a>			<span class="k">elif</span> <span class="n">templatetype</span> <span class="o">==</span> <span class="s">&quot;answer&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-656"></a>				<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Template type is answer!&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-657"></a>				<span class="k">return</span> <span class="n">update_a_resource</span><span class="p">(</span><span class="n">passed_recaptcha</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">resource</span> <span class="o">=</span> <span class="s">&quot;qa&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-658"></a>			<span class="k">elif</span> <span class="n">templatetype</span> <span class="o">==</span> <span class="s">&quot;request&quot;</span><span class="p">:</span>
<a name="views.py-pyg.html-659"></a>				<span class="k">return</span> <span class="n">new_request</span><span class="p">(</span><span class="n">passed_recaptcha</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
<a name="views.py-pyg.html-660"></a>	<span class="k">else</span><span class="p">:</span>
<a name="views.py-pyg.html-661"></a>		<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Attempted access to recaptcha not via POST&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-662"></a>		<span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;error.html&#39;</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;You don&#39;t need to be here.&quot;</span><span class="p">)</span>
<a name="views.py-pyg.html-663"></a>
<a name="views.py-pyg.html-664"></a><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/.well-known/status&quot;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;GET&quot;</span><span class="p">])</span>
<a name="views.py-pyg.html-665"></a><span class="k">def</span> <span class="nf">well_known_status</span><span class="p">():</span>
<a name="views.py-pyg.html-666"></a>	<span class="sd">&#39;&#39;&#39;</span>
<a name="views.py-pyg.html-667"></a><span class="sd">	&#39;&#39;&#39;</span>
<a name="views.py-pyg.html-668"></a>	<span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
<a name="views.py-pyg.html-669"></a>		<span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;ok&#39;</span><span class="p">,</span>
<a name="views.py-pyg.html-670"></a>		<span class="s">&#39;updated&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">()),</span>
<a name="views.py-pyg.html-671"></a>		<span class="s">&#39;dependencies&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;Akismet&#39;</span><span class="p">,</span> <span class="s">&#39;Scribd&#39;</span><span class="p">,</span> <span class="s">&#39;Sendgrid&#39;</span><span class="p">,</span> <span class="s">&#39;Postgres&#39;</span><span class="p">],</span>
<a name="views.py-pyg.html-672"></a>		<span class="s">&#39;resources&#39;</span><span class="p">:</span> <span class="p">{}</span>
<a name="views.py-pyg.html-673"></a>		<span class="p">}</span>
<a name="views.py-pyg.html-674"></a>	
<a name="views.py-pyg.html-675"></a>	<span class="c">#</span>
<a name="views.py-pyg.html-676"></a>	<span class="c"># Try to connect to the database and get the first user.</span>
<a name="views.py-pyg.html-677"></a>	<span class="c">#</span>
<a name="views.py-pyg.html-678"></a>	<span class="k">try</span><span class="p">:</span>
<a name="views.py-pyg.html-679"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">get_obj</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
<a name="views.py-pyg.html-680"></a>			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Failed to get the first user&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-681"></a>		
<a name="views.py-pyg.html-682"></a>	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="views.py-pyg.html-683"></a>		<span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Database fail: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span>
<a name="views.py-pyg.html-684"></a>		<span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a name="views.py-pyg.html-685"></a>	
<a name="views.py-pyg.html-686"></a>	<span class="c">#</span>
<a name="views.py-pyg.html-687"></a>	<span class="c"># Try to connect to Akismet and see if the key is valid.</span>
<a name="views.py-pyg.html-688"></a>	<span class="c">#</span>
<a name="views.py-pyg.html-689"></a>	<span class="k">try</span><span class="p">:</span>
<a name="views.py-pyg.html-690"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">is_working_akismet_key</span><span class="p">():</span>
<a name="views.py-pyg.html-691"></a>			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Akismet reported a non-working key&#39;</span><span class="p">)</span>
<a name="views.py-pyg.html-692"></a>		
<a name="views.py-pyg.html-693"></a>	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="views.py-pyg.html-694"></a>		<span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Akismet fail: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span>
<a name="views.py-pyg.html-695"></a>		<span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a name="views.py-pyg.html-696"></a>	
<a name="views.py-pyg.html-697"></a>	<span class="c">#</span>
<a name="views.py-pyg.html-698"></a>	<span class="c"># Try to ask Sendgrid how many emails we have sent in the past month.</span>
<a name="views.py-pyg.html-699"></a>	<span class="c">#</span>
<a name="views.py-pyg.html-700"></a>	<span class="k">try</span><span class="p">:</span>
<a name="views.py-pyg.html-701"></a>		<span class="n">url</span> <span class="o">=</span> <span class="s">&#39;https://sendgrid.com/api/stats.get.json?api_user=</span><span class="si">%(MAIL_USERNAME)s</span><span class="s">&amp;api_key=</span><span class="si">%(MAIL_PASSWORD)s</span><span class="s">&amp;days=30&#39;</span> <span class="o">%</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span>
<a name="views.py-pyg.html-702"></a>		<span class="n">got</span> <span class="o">=</span> <span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<a name="views.py-pyg.html-703"></a>		
<a name="views.py-pyg.html-704"></a>		<span class="k">if</span> <span class="n">got</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
<a name="views.py-pyg.html-705"></a>			<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;HTTP status </span><span class="si">%s</span><span class="s"> from Sendgrid /api/stats.get&#39;</span> <span class="o">%</span> <span class="n">got</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<a name="views.py-pyg.html-706"></a>		
<a name="views.py-pyg.html-707"></a>		<span class="n">mails</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">m</span><span class="p">[</span><span class="s">&#39;delivered&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="s">&#39;repeat_bounces&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">got</span><span class="o">.</span><span class="n">json</span><span class="p">()])</span>
<a name="views.py-pyg.html-708"></a>		<span class="n">response</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">][</span><span class="s">&#39;Sendgrid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">mails</span><span class="p">)</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SENDGRID_MONTHLY_LIMIT&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">40000</span><span class="p">)</span>
<a name="views.py-pyg.html-709"></a>		
<a name="views.py-pyg.html-710"></a>	<span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
<a name="views.py-pyg.html-711"></a>		<span class="n">response</span><span class="p">[</span><span class="s">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Sendgrid fail: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span>
<a name="views.py-pyg.html-712"></a>		<span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<a name="views.py-pyg.html-713"></a>	
<a name="views.py-pyg.html-714"></a>	<span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>

</pre>

<a name="models">Database schema</a> 
<p>models.py</p>
<pre>
<div class="highlight"><pre><a name="models.py-pyg.html-1"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="models.py-pyg.html-2"></a><span class="sd">    public_records_portal.models</span>
<a name="models.py-pyg.html-3"></a><span class="sd">    ~~~~~~~~~~~~~~~~</span>
<a name="models.py-pyg.html-4"></a>
<a name="models.py-pyg.html-5"></a><span class="sd">    Defines RecordTrac&#39;s database schema, and implements helper functions.</span>
<a name="models.py-pyg.html-6"></a>
<a name="models.py-pyg.html-7"></a><span class="sd">&quot;&quot;&quot;</span>
<a name="models.py-pyg.html-8"></a>
<a name="models.py-pyg.html-9"></a><span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span><span class="p">,</span> <span class="n">sqlalchemy</span>
<a name="models.py-pyg.html-10"></a><span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">current_user</span>
<a name="models.py-pyg.html-11"></a>
<a name="models.py-pyg.html-12"></a><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">ForeignKey</span>
<a name="models.py-pyg.html-13"></a><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">backref</span>
<a name="models.py-pyg.html-14"></a><span class="kn">from</span> <span class="nn">sqlalchemy.ext.hybrid</span> <span class="kn">import</span> <span class="n">hybrid_property</span><span class="p">,</span> <span class="n">hybrid_method</span>
<a name="models.py-pyg.html-15"></a><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span>
<a name="models.py-pyg.html-16"></a>
<a name="models.py-pyg.html-17"></a><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<a name="models.py-pyg.html-18"></a><span class="kn">from</span> <span class="nn">public_records_portal</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">app</span>
<a name="models.py-pyg.html-19"></a><span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
<a name="models.py-pyg.html-20"></a><span class="kn">import</span> <span class="nn">json</span>
<a name="models.py-pyg.html-21"></a><span class="kn">import</span> <span class="nn">re</span>
<a name="models.py-pyg.html-22"></a><span class="kn">from</span> <span class="nn">validate_email</span> <span class="kn">import</span> <span class="n">validate_email</span>
<a name="models.py-pyg.html-23"></a>
<a name="models.py-pyg.html-24"></a>
<a name="models.py-pyg.html-25"></a><span class="c">### @export &quot;User&quot;</span>
<a name="models.py-pyg.html-26"></a><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<a name="models.py-pyg.html-27"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;user&#39;</span>
<a name="models.py-pyg.html-28"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-29"></a>	<span class="n">alias</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
<a name="models.py-pyg.html-30"></a>	<span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-31"></a>	<span class="n">phone</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
<a name="models.py-pyg.html-32"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-33"></a>	<span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>
<a name="models.py-pyg.html-34"></a>	<span class="n">department</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">&quot;department.id&quot;</span><span class="p">))</span>
<a name="models.py-pyg.html-35"></a>	<span class="n">current_department</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Department&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">department</span><span class="p">],</span> <span class="n">uselist</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<a name="models.py-pyg.html-36"></a>	<span class="n">contact_for</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span> <span class="c"># comma separated list</span>
<a name="models.py-pyg.html-37"></a>	<span class="n">backup_for</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span> <span class="c"># comma separated list</span>
<a name="models.py-pyg.html-38"></a>	<span class="n">owners</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Owner&quot;</span><span class="p">)</span>
<a name="models.py-pyg.html-39"></a>	<span class="n">subscribers</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Subscriber&quot;</span><span class="p">)</span>
<a name="models.py-pyg.html-40"></a>	<span class="n">is_staff</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="c"># Is this user an active agency member?</span>
<a name="models.py-pyg.html-41"></a>
<a name="models.py-pyg.html-42"></a>	<span class="k">def</span> <span class="nf">is_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-43"></a>		<span class="k">return</span> <span class="bp">True</span>
<a name="models.py-pyg.html-44"></a>	<span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-45"></a>		<span class="k">return</span> <span class="bp">True</span>
<a name="models.py-pyg.html-46"></a>	<span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-47"></a>		<span class="k">return</span> <span class="bp">False</span>
<a name="models.py-pyg.html-48"></a>	<span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-49"></a>		<span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="models.py-pyg.html-50"></a>	<span class="k">def</span> <span class="nf">get_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-51"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="models.py-pyg.html-52"></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span>
<a name="models.py-pyg.html-53"></a>		<span class="k">return</span> <span class="s">&quot;N/A&quot;</span>
<a name="models.py-pyg.html-54"></a>	<span class="k">def</span> <span class="nf">get_phone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-55"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phone</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">phone</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="models.py-pyg.html-56"></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">phone</span>
<a name="models.py-pyg.html-57"></a>		<span class="k">return</span> <span class="s">&quot;N/A&quot;</span>
<a name="models.py-pyg.html-58"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">phone</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">department</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">contact_for</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">backup_for</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">is_staff</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="models.py-pyg.html-59"></a>		<span class="k">if</span> <span class="n">email</span> <span class="ow">and</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<a name="models.py-pyg.html-60"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
<a name="models.py-pyg.html-61"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">alias</span>
<a name="models.py-pyg.html-62"></a>		<span class="k">if</span> <span class="n">phone</span> <span class="ow">and</span> <span class="n">phone</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="models.py-pyg.html-63"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">phone</span> <span class="o">=</span> <span class="n">phone</span>
<a name="models.py-pyg.html-64"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-65"></a>		<span class="k">if</span> <span class="n">department</span> <span class="ow">and</span> <span class="n">department</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="models.py-pyg.html-66"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">department</span> <span class="o">=</span> <span class="n">department</span>
<a name="models.py-pyg.html-67"></a>		<span class="k">if</span> <span class="n">contact_for</span> <span class="ow">and</span> <span class="n">contact_for</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="models.py-pyg.html-68"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">contact_for</span> <span class="o">=</span> <span class="n">contact_for</span>
<a name="models.py-pyg.html-69"></a>		<span class="k">if</span> <span class="n">backup_for</span> <span class="ow">and</span> <span class="n">backup_for</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
<a name="models.py-pyg.html-70"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">backup_for</span> <span class="o">=</span> <span class="n">backup_for</span>
<a name="models.py-pyg.html-71"></a>		<span class="k">if</span> <span class="n">is_staff</span><span class="p">:</span>
<a name="models.py-pyg.html-72"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="n">is_staff</span>
<a name="models.py-pyg.html-73"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-74"></a>		<span class="k">return</span> <span class="s">&#39;&lt;User </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span>
<a name="models.py-pyg.html-75"></a>	<span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-76"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span>
<a name="models.py-pyg.html-77"></a>	<span class="k">def</span> <span class="nf">department_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-78"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_department</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_department</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
<a name="models.py-pyg.html-79"></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_department</span><span class="o">.</span><span class="n">name</span>
<a name="models.py-pyg.html-80"></a>		<span class="k">else</span><span class="p">:</span>
<a name="models.py-pyg.html-81"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">User </span><span class="si">%s</span><span class="s"> is not associated with a department.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
<a name="models.py-pyg.html-82"></a>			<span class="k">return</span> <span class="s">&quot;N/A&quot;</span>
<a name="models.py-pyg.html-83"></a>
<a name="models.py-pyg.html-84"></a><span class="c">### @export &quot;Department&quot;</span>
<a name="models.py-pyg.html-85"></a><span class="k">class</span> <span class="nc">Department</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<a name="models.py-pyg.html-86"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;department&#39;</span>
<a name="models.py-pyg.html-87"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-88"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-89"></a>	<span class="n">date_updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-90"></a>	<span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-91"></a>	<span class="n">users</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;User&quot;</span><span class="p">)</span> <span class="c"># The list of users in this department</span>
<a name="models.py-pyg.html-92"></a>	<span class="n">requests</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">order_by</span> <span class="o">=</span> <span class="s">&quot;Request.date_created.asc()&quot;</span><span class="p">)</span> <span class="c"># The list of requests currently associated with this department</span>
<a name="models.py-pyg.html-93"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<a name="models.py-pyg.html-94"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
<a name="models.py-pyg.html-95"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-96"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-97"></a>		<span class="k">return</span> <span class="s">&#39;&lt;Department </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
<a name="models.py-pyg.html-98"></a>	<span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-99"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
<a name="models.py-pyg.html-100"></a>	<span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-101"></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s">&quot;N/A&quot;</span>
<a name="models.py-pyg.html-102"></a>
<a name="models.py-pyg.html-103"></a><span class="c">### @export &quot;Request&quot;</span>
<a name="models.py-pyg.html-104"></a><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span> 
<a name="models.py-pyg.html-105"></a><span class="c"># The public records request</span>
<a name="models.py-pyg.html-106"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;request&#39;</span>
<a name="models.py-pyg.html-107"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-108"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-109"></a>	<span class="n">due_date</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-110"></a>	<span class="n">extended</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> <span class="c"># Has the due date been extended?</span>
<a name="models.py-pyg.html-111"></a>	<span class="n">qas</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;QA&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s">&quot;all,delete&quot;</span><span class="p">,</span> <span class="n">order_by</span> <span class="o">=</span> <span class="s">&quot;QA.date_created.desc()&quot;</span><span class="p">)</span> <span class="c"># The list of QA units for this request</span>
<a name="models.py-pyg.html-112"></a>	<span class="n">status_updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-113"></a>	<span class="n">text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c"># The actual request text.</span>
<a name="models.py-pyg.html-114"></a>	<span class="n">owners</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Owner&quot;</span><span class="p">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="s">&quot;all, delete&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s">&quot;Owner.date_created.asc()&quot;</span><span class="p">)</span>
<a name="models.py-pyg.html-115"></a>	<span class="n">subscribers</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Subscriber&quot;</span><span class="p">,</span> <span class="n">cascade</span> <span class="o">=</span><span class="s">&quot;all, delete&quot;</span><span class="p">)</span> <span class="c"># The list of subscribers following this request.</span>
<a name="models.py-pyg.html-116"></a>	<span class="n">records</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Record&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s">&quot;all,delete&quot;</span><span class="p">,</span> <span class="n">order_by</span> <span class="o">=</span> <span class="s">&quot;Record.date_created.desc()&quot;</span><span class="p">)</span> <span class="c"># The list of records that have been uploaded for this request.</span>
<a name="models.py-pyg.html-117"></a>	<span class="n">notes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Note&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s">&quot;all,delete&quot;</span><span class="p">,</span> <span class="n">order_by</span> <span class="o">=</span> <span class="s">&quot;Note.date_created.desc()&quot;</span><span class="p">)</span> <span class="c"># The list of notes appended to this request.</span>
<a name="models.py-pyg.html-118"></a>	<span class="n">status</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">400</span><span class="p">))</span> <span class="c"># The status of the request (open, closed, etc.)</span>
<a name="models.py-pyg.html-119"></a>	<span class="n">creator_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span> <span class="c"># If city staff created it on behalf of the public, otherwise the creator is the subscriber with creator = true</span>
<a name="models.py-pyg.html-120"></a>	<span class="n">department_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&quot;department.id&quot;</span><span class="p">))</span>
<a name="models.py-pyg.html-121"></a>	<span class="n">department</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Department&quot;</span><span class="p">,</span> <span class="n">uselist</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<a name="models.py-pyg.html-122"></a>	<span class="n">date_received</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-123"></a>	<span class="n">offline_submission_type</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
<a name="models.py-pyg.html-124"></a>
<a name="models.py-pyg.html-125"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">creator_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">offline_submission_type</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">date_received</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="models.py-pyg.html-126"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
<a name="models.py-pyg.html-127"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-128"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">creator_id</span> <span class="o">=</span> <span class="n">creator_id</span>
<a name="models.py-pyg.html-129"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">offline_submission_type</span> <span class="o">=</span> <span class="n">offline_submission_type</span>
<a name="models.py-pyg.html-130"></a>		<span class="k">if</span> <span class="n">date_received</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">date_received</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="p">:</span>
<a name="models.py-pyg.html-131"></a>				<span class="bp">self</span><span class="o">.</span><span class="n">date_received</span> <span class="o">=</span> <span class="n">date_received</span>
<a name="models.py-pyg.html-132"></a>
<a name="models.py-pyg.html-133"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-134"></a>		<span class="k">return</span> <span class="s">&#39;&lt;Request </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>
<a name="models.py-pyg.html-135"></a>
<a name="models.py-pyg.html-136"></a>	<span class="k">def</span> <span class="nf">set_due_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-137"></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_received</span><span class="p">:</span>
<a name="models.py-pyg.html-138"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">date_received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_created</span>
<a name="models.py-pyg.html-139"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
<a name="models.py-pyg.html-140"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">due_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_received</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DAYS_AFTER_EXTENSION&#39;</span><span class="p">]))</span>
<a name="models.py-pyg.html-141"></a>		<span class="k">else</span><span class="p">:</span>
<a name="models.py-pyg.html-142"></a>			<span class="bp">self</span><span class="o">.</span><span class="n">due_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_received</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DAYS_TO_FULFILL&#39;</span><span class="p">]))</span>
<a name="models.py-pyg.html-143"></a>
<a name="models.py-pyg.html-144"></a>	<span class="k">def</span> <span class="nf">extension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-145"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">extended</span> <span class="o">=</span> <span class="bp">True</span> 
<a name="models.py-pyg.html-146"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">due_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">due_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DAYS_AFTER_EXTENSION&#39;</span><span class="p">]))</span>
<a name="models.py-pyg.html-147"></a>	<span class="k">def</span> <span class="nf">point_person</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-148"></a>		<span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">owners</span><span class="p">:</span>
<a name="models.py-pyg.html-149"></a>			<span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">is_point_person</span><span class="p">:</span>
<a name="models.py-pyg.html-150"></a>				<span class="k">return</span> <span class="n">o</span>
<a name="models.py-pyg.html-151"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="models.py-pyg.html-152"></a>	<span class="k">def</span> <span class="nf">all_owners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-153"></a>		<span class="n">all_owners</span> <span class="o">=</span> <span class="p">[]</span>
<a name="models.py-pyg.html-154"></a>		<span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">owners</span><span class="p">:</span>
<a name="models.py-pyg.html-155"></a>			<span class="n">all_owners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_alias</span><span class="p">())</span>
<a name="models.py-pyg.html-156"></a>		<span class="k">return</span> <span class="n">all_owners</span>
<a name="models.py-pyg.html-157"></a>		
<a name="models.py-pyg.html-158"></a>	<span class="k">def</span> <span class="nf">requester</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-159"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span><span class="p">:</span>
<a name="models.py-pyg.html-160"></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscribers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">None</span> <span class="c"># The first subscriber is always the requester</span>
<a name="models.py-pyg.html-161"></a>		<span class="k">return</span> <span class="bp">None</span>
<a name="models.py-pyg.html-162"></a>
<a name="models.py-pyg.html-163"></a>	<span class="k">def</span> <span class="nf">requester_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-164"></a>		<span class="n">requester</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requester</span><span class="p">()</span>
<a name="models.py-pyg.html-165"></a>		<span class="k">if</span> <span class="n">requester</span> <span class="ow">and</span> <span class="n">requester</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
<a name="models.py-pyg.html-166"></a>			<span class="k">return</span> <span class="n">requester</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_alias</span><span class="p">()</span>
<a name="models.py-pyg.html-167"></a>		<span class="k">return</span> <span class="s">&quot;N/A&quot;</span>
<a name="models.py-pyg.html-168"></a>
<a name="models.py-pyg.html-169"></a>	<span class="k">def</span> <span class="nf">requester_phone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-170"></a>		<span class="n">requester</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requester</span><span class="p">()</span>
<a name="models.py-pyg.html-171"></a>		<span class="k">if</span> <span class="n">requester</span> <span class="ow">and</span> <span class="n">requester</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
<a name="models.py-pyg.html-172"></a>			<span class="k">return</span> <span class="n">requester</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_phone</span><span class="p">()</span>
<a name="models.py-pyg.html-173"></a>		<span class="k">return</span> <span class="s">&quot;N/A&quot;</span>
<a name="models.py-pyg.html-174"></a>	<span class="k">def</span> <span class="nf">point_person_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-175"></a>		<span class="n">point_person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_person</span><span class="p">()</span>
<a name="models.py-pyg.html-176"></a>		<span class="k">if</span> <span class="n">point_person</span> <span class="ow">and</span> <span class="n">point_person</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
<a name="models.py-pyg.html-177"></a>			<span class="k">return</span> <span class="n">point_person</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">get_alias</span><span class="p">()</span>
<a name="models.py-pyg.html-178"></a>		<span class="k">return</span> <span class="s">&quot;N/A&quot;</span>
<a name="models.py-pyg.html-179"></a>	<span class="k">def</span> <span class="nf">department_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-180"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">department</span><span class="p">:</span>
<a name="models.py-pyg.html-181"></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">department</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span>
<a name="models.py-pyg.html-182"></a>		<span class="k">return</span> <span class="s">&quot;N/A&quot;</span>
<a name="models.py-pyg.html-183"></a>	<span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-184"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
<a name="models.py-pyg.html-185"></a>			<span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;.*(closed).*&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<a name="models.py-pyg.html-186"></a>		<span class="k">else</span><span class="p">:</span>
<a name="models.py-pyg.html-187"></a>			<span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s"> Request with this ID has no status: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a name="models.py-pyg.html-188"></a>			<span class="k">return</span> <span class="bp">False</span>
<a name="models.py-pyg.html-189"></a>	<span class="k">def</span> <span class="nf">solid_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cron_job</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="models.py-pyg.html-190"></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
<a name="models.py-pyg.html-191"></a>			<span class="k">return</span> <span class="s">&quot;closed&quot;</span>
<a name="models.py-pyg.html-192"></a>		<span class="k">else</span><span class="p">:</span>
<a name="models.py-pyg.html-193"></a>			<span class="k">if</span> <span class="n">cron_job</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">()):</span>
<a name="models.py-pyg.html-194"></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">due_date</span><span class="p">:</span>
<a name="models.py-pyg.html-195"></a>					<span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">due_date</span><span class="p">:</span>
<a name="models.py-pyg.html-196"></a>						<span class="k">return</span> <span class="s">&quot;overdue&quot;</span>
<a name="models.py-pyg.html-197"></a>					<span class="k">elif</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;DAYS_UNTIL_OVERDUE&#39;</span><span class="p">])))</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">due_date</span><span class="p">:</span>
<a name="models.py-pyg.html-198"></a>						<span class="k">return</span> <span class="s">&quot;due soon&quot;</span>
<a name="models.py-pyg.html-199"></a>		<span class="k">return</span> <span class="s">&quot;open&quot;</span>
<a name="models.py-pyg.html-200"></a>
<a name="models.py-pyg.html-201"></a>	<span class="nd">@hybrid_property</span>
<a name="models.py-pyg.html-202"></a>	<span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-203"></a>			<span class="n">two_days</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<a name="models.py-pyg.html-204"></a>			<span class="k">return</span> <span class="n">and_</span><span class="p">(</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">due_date</span> <span class="o">&gt;</span> <span class="n">two_days</span><span class="p">)</span>
<a name="models.py-pyg.html-205"></a>
<a name="models.py-pyg.html-206"></a>	<span class="nd">@hybrid_property</span>
<a name="models.py-pyg.html-207"></a>	<span class="k">def</span> <span class="nf">due_soon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-208"></a>			<span class="n">two_days</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<a name="models.py-pyg.html-209"></a>			<span class="k">return</span> <span class="n">and_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">due_date</span> <span class="o">&lt;</span> <span class="n">two_days</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">due_date</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
<a name="models.py-pyg.html-210"></a> 
<a name="models.py-pyg.html-211"></a>	<span class="nd">@hybrid_property</span>
<a name="models.py-pyg.html-212"></a>	<span class="k">def</span> <span class="nf">overdue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-213"></a>			<span class="k">return</span> <span class="n">and_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">due_date</span> <span class="o">&lt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
<a name="models.py-pyg.html-214"></a>	
<a name="models.py-pyg.html-215"></a>	<span class="nd">@hybrid_property</span>
<a name="models.py-pyg.html-216"></a>	<span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-217"></a>			<span class="k">return</span> <span class="n">Request</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%c</span><span class="s">losed%&quot;</span><span class="p">)</span>
<a name="models.py-pyg.html-218"></a>
<a name="models.py-pyg.html-219"></a><span class="c">### @export &quot;QA&quot;</span>
<a name="models.py-pyg.html-220"></a><span class="k">class</span> <span class="nc">QA</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<a name="models.py-pyg.html-221"></a><span class="c"># A Q &amp; A block for a request</span>
<a name="models.py-pyg.html-222"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;qa&#39;</span>
<a name="models.py-pyg.html-223"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-224"></a>	<span class="n">question</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
<a name="models.py-pyg.html-225"></a>	<span class="n">answer</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
<a name="models.py-pyg.html-226"></a>	<span class="n">request_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;request.id&#39;</span><span class="p">))</span>
<a name="models.py-pyg.html-227"></a>	<span class="n">owner_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span> <span class="c"># Actually just a user ID</span>
<a name="models.py-pyg.html-228"></a>	<span class="n">subscriber_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span> <span class="c"># Actually just a user ID</span>
<a name="models.py-pyg.html-229"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-230"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="models.py-pyg.html-231"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="n">question</span>
<a name="models.py-pyg.html-232"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
<a name="models.py-pyg.html-233"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-234"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">=</span> <span class="n">user_id</span>
<a name="models.py-pyg.html-235"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-236"></a>		<span class="k">return</span> <span class="s">&quot;&lt;QA Q: </span><span class="si">%r</span><span class="s"> A: </span><span class="si">%r</span><span class="s">&gt;&quot;</span> <span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
<a name="models.py-pyg.html-237"></a>
<a name="models.py-pyg.html-238"></a><span class="c">### @export &quot;Owner&quot;</span>
<a name="models.py-pyg.html-239"></a><span class="k">class</span> <span class="nc">Owner</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span> 
<a name="models.py-pyg.html-240"></a><span class="c"># A member of city staff assigned to a particular request, that may or may not upload records towards that request.</span>
<a name="models.py-pyg.html-241"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;owner&#39;</span>
<a name="models.py-pyg.html-242"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-243"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span>
<a name="models.py-pyg.html-244"></a>	<span class="n">user</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;User&quot;</span><span class="p">,</span> <span class="n">uselist</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<a name="models.py-pyg.html-245"></a>	<span class="n">request_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;request.id&#39;</span><span class="p">))</span>
<a name="models.py-pyg.html-246"></a>	<span class="n">request</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;Request&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">request_id</span><span class="p">])</span>
<a name="models.py-pyg.html-247"></a>	<span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># Indicate whether they&#39;re still involved in the request or not.</span>
<a name="models.py-pyg.html-248"></a>	<span class="n">reason</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span> <span class="c"># Reason they were assigned</span>
<a name="models.py-pyg.html-249"></a>	<span class="n">reason_unassigned</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span> <span class="c"># Reason they were unassigned</span>
<a name="models.py-pyg.html-250"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-251"></a>	<span class="n">date_updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-252"></a>	<span class="n">is_point_person</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">)</span>
<a name="models.py-pyg.html-253"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">is_point_person</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="models.py-pyg.html-254"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
<a name="models.py-pyg.html-255"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
<a name="models.py-pyg.html-256"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
<a name="models.py-pyg.html-257"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-258"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_updated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date_created</span>
<a name="models.py-pyg.html-259"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">is_point_person</span> <span class="o">=</span> <span class="n">is_point_person</span>
<a name="models.py-pyg.html-260"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-261"></a>		<span class="k">return</span> <span class="s">&#39;&lt;Owner </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span>
<a name="models.py-pyg.html-262"></a>
<a name="models.py-pyg.html-263"></a><span class="c">### @export &quot;Subscriber&quot;</span>
<a name="models.py-pyg.html-264"></a><span class="k">class</span> <span class="nc">Subscriber</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span> 
<a name="models.py-pyg.html-265"></a><span class="c"># A person subscribed to a request, who may or may not have created the request, and may or may not own a part of the request.</span>
<a name="models.py-pyg.html-266"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;subscriber&#39;</span>
<a name="models.py-pyg.html-267"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-268"></a>	<span class="n">should_notify</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># Allows a subscriber to unsubscribe</span>
<a name="models.py-pyg.html-269"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span>
<a name="models.py-pyg.html-270"></a>	<span class="n">user</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s">&quot;User&quot;</span><span class="p">,</span> <span class="n">uselist</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
<a name="models.py-pyg.html-271"></a>	<span class="n">request_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;request.id&#39;</span><span class="p">))</span>
<a name="models.py-pyg.html-272"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-273"></a>	<span class="n">owner_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;owner.id&#39;</span><span class="p">))</span> <span class="c"># Not null if responsible for fulfilling a part of the request. UPDATE 6-11-2014: This isn&#39;t used. we should get rid of it.</span>
<a name="models.py-pyg.html-274"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">creator</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
<a name="models.py-pyg.html-275"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
<a name="models.py-pyg.html-276"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
<a name="models.py-pyg.html-277"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-278"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-279"></a>		<span class="k">return</span> <span class="s">&#39;&lt;Subscriber </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span>
<a name="models.py-pyg.html-280"></a>
<a name="models.py-pyg.html-281"></a><span class="c">### @export &quot;Record&quot;</span>
<a name="models.py-pyg.html-282"></a><span class="k">class</span> <span class="nc">Record</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<a name="models.py-pyg.html-283"></a><span class="c"># A record that is attached to a particular request. A record can be online (uploaded document, link) or offline.</span>
<a name="models.py-pyg.html-284"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;record&#39;</span>
<a name="models.py-pyg.html-285"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-286"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-287"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span> <span class="c"># The user who uploaded the record, right now only city staff can</span>
<a name="models.py-pyg.html-288"></a>	<span class="n">doc_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span> <span class="c"># The document ID. Currently using Scribd API to upload documents.</span>
<a name="models.py-pyg.html-289"></a>	<span class="n">request_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;request.id&#39;</span><span class="p">))</span> <span class="c"># The request this record was uploaded for</span>
<a name="models.py-pyg.html-290"></a>	<span class="n">description</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">400</span><span class="p">))</span> <span class="c"># A short description of what the record is. </span>
<a name="models.py-pyg.html-291"></a>	<span class="n">filename</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">400</span><span class="p">))</span> <span class="c"># The original name of the file being uploaded.</span>
<a name="models.py-pyg.html-292"></a>	<span class="n">url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span> <span class="c"># Where it exists on the internet.</span>
<a name="models.py-pyg.html-293"></a>	<span class="n">download_url</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span> <span class="c"># Where it can be downloaded on the internet.</span>
<a name="models.py-pyg.html-294"></a>	<span class="n">access</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span> <span class="c"># How to access it. Probably only defined on offline docs for now.</span>
<a name="models.py-pyg.html-295"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">url</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">doc_id</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">description</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">access</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
<a name="models.py-pyg.html-296"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">doc_id</span> <span class="o">=</span> <span class="n">doc_id</span>
<a name="models.py-pyg.html-297"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
<a name="models.py-pyg.html-298"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
<a name="models.py-pyg.html-299"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-300"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
<a name="models.py-pyg.html-301"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
<a name="models.py-pyg.html-302"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
<a name="models.py-pyg.html-303"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">access</span>
<a name="models.py-pyg.html-304"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-305"></a>		<span class="k">return</span> <span class="s">&#39;&lt;Record </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
<a name="models.py-pyg.html-306"></a>
<a name="models.py-pyg.html-307"></a><span class="c">### @export &quot;Note&quot;</span>
<a name="models.py-pyg.html-308"></a><span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<a name="models.py-pyg.html-309"></a><span class="c"># A note on a request.</span>
<a name="models.py-pyg.html-310"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;note&#39;</span>
<a name="models.py-pyg.html-311"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-312"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-313"></a>	<span class="n">text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
<a name="models.py-pyg.html-314"></a>	<span class="n">request_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;request.id&#39;</span><span class="p">))</span> <span class="c"># The request it belongs to.</span>
<a name="models.py-pyg.html-315"></a>	<span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span> <span class="c"># The user who wrote the note. Right now only stored for city staff - otherwise it&#39;s an anonymous/ &#39;requester&#39; note.</span>
<a name="models.py-pyg.html-316"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_id</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<a name="models.py-pyg.html-317"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
<a name="models.py-pyg.html-318"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">request_id</span>
<a name="models.py-pyg.html-319"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">user_id</span>
<a name="models.py-pyg.html-320"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-321"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-322"></a>		<span class="k">return</span> <span class="s">&#39;&lt;Note </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">text</span>
<a name="models.py-pyg.html-323"></a>
<a name="models.py-pyg.html-324"></a><span class="c">### @export &quot;Visualization&quot;</span>
<a name="models.py-pyg.html-325"></a><span class="k">class</span> <span class="nc">Visualization</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<a name="models.py-pyg.html-326"></a>	<span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;visualization&#39;</span>
<a name="models.py-pyg.html-327"></a>	<span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
<a name="models.py-pyg.html-328"></a>	<span class="n">content</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
<a name="models.py-pyg.html-329"></a>	<span class="n">date_created</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-330"></a>	<span class="n">date_updated</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>
<a name="models.py-pyg.html-331"></a>	<span class="n">type_viz</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
<a name="models.py-pyg.html-332"></a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_viz</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
<a name="models.py-pyg.html-333"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">type_viz</span> <span class="o">=</span> <span class="n">type_viz</span>
<a name="models.py-pyg.html-334"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
<a name="models.py-pyg.html-335"></a>		<span class="bp">self</span><span class="o">.</span><span class="n">date_created</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
<a name="models.py-pyg.html-336"></a>	<span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a name="models.py-pyg.html-337"></a>		<span class="k">return</span> <span class="s">&#39;&lt;Visualization </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_viz</span>
</pre></div>

</pre>

    </body>
</html>